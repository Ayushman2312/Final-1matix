{% extends 'user_dashboard/base.html' %}
{% load static %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1Matrix - Listing Creator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif']
                    },
                    colors: {
                        'primary': '#4f46e5',
                        'primary-hover': '#4338ca',
                        'light-blue': '#6699FF'
                    }
                }
            }
        }
    </script>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
</head>
<body class="quicksand bg-slate-50 min-w-[320px]">
    <div class="w-full max-w-full  box-border">
        <div class="flex flex-wrap gap-8 w-full justify-between">
            <!-- Left Section - Input Form -->
            <div class="flex-1 min-w-[300px] bg-white shadow-[0_0px_7px_rgba(0,0,0,0.1)] rounded-2xl p-6 mb-4">
                <div class="h-full w-full flex flex-col">
                    <!-- Platform, Brand Name, Keywords Screenshot -->
                    <div class="flex flex-col gap-3">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                            <!-- Platform Selection -->
                            <div class="mb-1">
                                <label for="platform" class="block font-semibold text-sm mb-1 quicksand text-gray-700">Platform</label>
                                <select id="platform" class="quicksand w-full px-3 py-2 border border-gray-200 rounded-lg bg-white text-sm box-border">
                                    {% if platforms %}
                                        {% for platform in platforms %}
                                            <option value="{{ platform }}">{{ platform }}</option>
                                        {% endfor %}
                                    {% else %}
                                        <option value="Amazon">Amazon</option>
                                    {% endif %}
                                </select>
                            </div>
                            
                            <!-- Brand Name -->
                            <div class="mb-1">
                                <label for="brand" class="block font-semibold text-sm mb-1 quicksand text-gray-700">Brand Name</label>
                                <input type="text" id="brand" placeholder="Brand Name" class="quicksand w-full px-3 py-2 border border-gray-200 rounded-lg bg-white text-sm box-border">
                            </div>
                            
                            <!-- Keywords Screenshot -->
                            <div class="mb-1">
                                <label for="keyword-screenshot1" class="block font-semibold text-sm mb-1 quicksand text-gray-700">Keywords Screenshot</label>
                                <div class="relative border border-gray-200 rounded-lg overflow-hidden h-[34px]" id="paste-zone1" ondblclick="document.getElementById('keyword-screenshot1').click()">
                                    <div class="text-center text-xs text-gray-400 absolute bottom-0 left-0 right-0">Double click to upload or Ctrl+V to paste</div>
                                    <input type="file" id="keyword-screenshot1" class="hidden" accept="image/*" onchange="handleFileSelect(this, 'preview1', 'preview-container1', 'upload-text1')">
                                    <div id="preview-container1" class="hidden absolute top-0 left-0 w-full h-full">
                                        <img id="preview1" src="" class="w-full h-full object-contain">
                                        <button type="button" id="remove-image1" class="absolute top-1 right-1 bg-white rounded-full p-1 shadow-sm" onclick="removeImage('preview1', 'preview-container1', 'keyword-screenshot1')">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Size, Material, Color -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                            <!-- Size -->
                            <div class="mb-1">
                                <label for="size" class="block font-semibold text-sm mb-1 quicksand text-gray-700">Size</label>
                                <input type="text" id="size" placeholder="Size" class="quicksand w-full px-3 py-2 border border-gray-200 rounded-lg bg-white text-sm box-border">
                            </div>
                            
                            <!-- Material -->
                            <div class="mb-1">
                                <label for="material" class="block font-semibold text-sm mb-1 quicksand text-gray-700">Material</label>
                                <input type="text" id="material" placeholder="Material" class="quicksand w-full px-3 py-2 border border-gray-200 rounded-lg bg-white text-sm box-border">
                            </div>
                            
                            <!-- Color -->
                            <div class="mb-1">
                                <label for="color" class="block font-semibold text-sm mb-1 quicksand text-gray-700">Colour</label>
                                <input type="text" id="color" placeholder="Colour Name" class="quicksand w-full px-3 py-2 border border-gray-200 rounded-lg bg-white text-sm box-border">
                            </div>
                        </div>
                        
                        <!-- Other Specifications -->
                        <div class="mb-3">
                            <label for="other-specs" class="block font-semibold text-sm mb-1 quicksand text-gray-700">Any other specification?</label>
                            <textarea id="other-specs" placeholder="Other Specifications" rows="3" class="quicksand w-full px-3 py-2 border border-gray-200 rounded-lg bg-white text-sm box-border"></textarea>
                        </div>
                        
                        <!-- Competitor URLs -->
                        <div class="mb-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Competitors URLs -->
                                <div>
                                    <label class="block font-semibold text-sm mb-1 quicksand text-gray-700">Competitors URLs</label>
                                    <div class="flex items-center gap-2">
                                        <input type="url" id="url1" placeholder="https://amazon.in/Xo" class="quicksand w-full px-3 py-2 border border-gray-200 rounded-lg bg-white text-sm box-border flex-grow">
                                        <button type="button" onclick="addUrlField()" class="px-2 py-1 text-xs text-white rounded-lg bg-[#7B3DF3] quicksand hover:bg-blue-600 transition-colors" id="add-url-btn">Add</button>
                                    </div>
                                    <div id="url-indicators" class="flex flex-wrap gap-2 mt-1">
                                        <!-- URL indicators will be added here dynamically -->
                                    </div>
                                </div>
                                
                                <!-- Upload Products Photo -->
                                <div>
                                    <label class="block font-semibold text-sm mb-1 quicksand text-gray-700 flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                        Upload Products Photo
                                    </label>
                                    <div class="flex items-center gap-2">
                                        <div class="relative flex-grow">
                                            <input type="" id="photo-text1" placeholder="Attach Upload (Min. 2)" class="quicksand w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg bg-white text-sm box-border" readonly onclick="document.getElementById('product-photo1').click()">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                                            </svg>
                                        </div>
                                        <button type="button" onclick="addPhotoField()" class="px-2 py-1 text-xs text-white rounded-lg bg-[#7B3DF3] quicksand hover:bg-blue-600 transition-colors" id="add-photo-btn">Add</button>
                                        <input type="file" id="product-photo1" class="hidden" accept="image/*" onchange="updatePhotoName('product-photo1', 'photo-text1')">
                                    </div>
                                    <div id="photo-indicators" class="flex flex-wrap gap-2 mt-1">
                                        <!-- Photo indicators will be added here dynamically -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Analyse & Generate Button -->
                        <div class="flex justify-end">
                            <button onclick="generateListing()" class="bg-[#7B3DF3] quicksand hover:bg-blue-600 text-white font-medium py-2 px-5 rounded-lg transition-colors text-sm">
                                Analyse & Generate
                            </button>
                        </div>
                        <div class="text-right text-xs quicksand text-gray-500 mt-3">
                            Powered by <span class="font-semibold">1matrix.io</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Section - Results -->
            <div class="flex-1 min-w-[300px] bg-white rounded-2xl shadow-[0_0px_5px_rgba(0,0,0,0.1)] p-6 mb-4">
                <div class="h-full w-full flex flex-col relative">
                    <button style="color:#000000;" onclick="showResultsPopup()" class="absolute right-0 top-0 text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </button>
                    
                    <!-- Title As Per Platform -->
                    <div class="mb-3">
                        <label class="block font-semibold text-sm mb-1 quicksand text-gray-700">Title As Per Platform</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="amazon-title" name="amazon-title" placeholder="Amazon" class="quicksand w-full px-3 py-2 border border-gray-200 rounded-lg bg-white text-sm box-border" readonly>
                            <button onclick="copyToClipboard('amazon-title', this)" class="text-gray-500 hover:text-gray-700 hidden copy-button">
                                <svg class="copy-icon h-5 w-5" fill="#3C4043" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path>
                                    <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path>
                                </svg>
                                <svg class="check-icon h-5 w-5 text-green-500 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Title As Per Expert -->
                    <div class="mb-3">
                        <label class="block font-semibold text-sm mb-1 quicksand text-gray-700">Title As Per Expert</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="expert-title" name="expert-title" placeholder="Expert Title" class="quicksand w-full px-3 py-2 border border-gray-200 rounded-lg bg-white text-sm box-border" readonly>
                            <button onclick="copyToClipboard('expert-title', this)" class="text-gray-500 hover:text-gray-700 hidden copy-button">
                                <svg class="copy-icon h-5 w-5" fill="#3C4043" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path>
                                    <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path>
                                </svg>
                                <svg class="check-icon h-5 w-5 text-green-500 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-3">
                        <label class="block font-semibold text-sm mb-1 quicksand text-gray-700">Description</label>
                        <div class="flex items-start gap-2">
                            <textarea id="description" placeholder="Amazon" rows="3" class="quicksand w-full px-3 py-2 border border-gray-200 rounded-lg bg-white text-sm box-border resize-none" readonly></textarea>
                            <button onclick="copyToClipboard('description', this)" class="text-gray-500 hover:text-gray-700 hidden copy-button">
                                <svg class="copy-icon h-5 w-5" fill="#3C4043" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path>
                                    <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path>
                                </svg>
                                <svg class="check-icon h-5 w-5 text-green-500 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Bullet Points -->
                    <div class="mb-3">
                        <label class="block font-semibold text-sm mb-1 quicksand text-gray-700">Bullet Points</label>
                        <div class="flex items-start gap-2">
                            <textarea id="bullet-points" placeholder="Amazon" rows="5" class="quicksand w-full px-3 py-2 border border-gray-200 rounded-lg bg-white text-sm box-border resize-none" readonly></textarea>
                            <button onclick="copyToClipboard('bullet-points', this)" class="text-gray-500 hover:text-gray-700 hidden copy-button">
                                <svg class="copy-icon h-5 w-5" fill="#3C4043" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path>
                                    <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path>
                                </svg>
                                <svg class="check-icon h-5 w-5 text-green-500 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Search Term -->
                    <div class="mb-3">
                        <label id="search-term-label" class="block font-semibold text-sm mb-1 quicksand text-gray-700">Search Term</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="search-terms" placeholder="Amazon" class="quicksand w-full px-3 py-2 border border-gray-200 rounded-lg bg-white text-sm box-border" readonly>
                            <button onclick="copyToClipboard('search-terms', this)" class="text-gray-500 hover:text-gray-700 hidden copy-button">
                                <svg class="copy-icon h-5 w-5" fill="#3C4043" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path>
                                    <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path>
                                </svg>
                                <svg class="check-icon h-5 w-5 text-green-500 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Error field (hidden by default) -->
                    <div id="error-field" class="hidden bg-red-50 p-3 rounded-lg text-red-600 mb-3 border border-red-100 text-sm">
                        <div id="error-message"></div>
                    </div>
                </div>

                <!-- JavaScript for copy functionality -->
                <script>
                    // Function to update search term label based on platform
                    function updateSearchTermLabel() {
                        const platform = document.getElementById('platform');
                        const searchTermLabel = document.getElementById('search-term-label');
                        const popupSearchTermLabel = document.getElementById('popup-search-term-label');
                        
                        if (platform) {
                            const labelText = platform.value === 'Amazon' ? 'Search Term' : 'Keyword';
                            
                            if (searchTermLabel) {
                                searchTermLabel.textContent = labelText;
                            }
                            
                            if (popupSearchTermLabel) {
                                popupSearchTermLabel.textContent = labelText + 's';
                            }
                        }
                    }

                    // Add event listener to platform dropdown
                    document.addEventListener('DOMContentLoaded', function() {
                        const platform = document.getElementById('platform');
                        if (platform) {
                            platform.addEventListener('change', updateSearchTermLabel);
                            // Initialize label on page load
                            updateSearchTermLabel();
                        }
                    });

                    // Function to format bullet points with proper styling
                    function formatBulletPoints(text) {
                        return text.replace(/•\s*(.*?)(?=(?:•|\n|$))/g, '<div class="pl-4 py-1 relative before:content-[\'•\'] before:absolute before:left-0 before:text-gray-400">$1</div>');
                    }

                    // Function to animate text with a word-by-word fade-in effect
                    function animateText(element, text) {
                        element.innerHTML = '';
                        let delay = 0;
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = text;
                        
                        const processNode = (node) => {
                            if (node.nodeType === 3) { // Text node
                                const words = node.textContent.split(/(\s+)/); // Split by whitespace but keep the whitespace
                                words.forEach(word => {
                                    const span = document.createElement('span');
                                    span.textContent = word;
                                    span.className = 'opacity-0 transition-opacity duration-300';
                                    span.style.transitionDelay = `${delay}ms`;
                                    element.appendChild(span);
                                    setTimeout(() => span.classList.remove('opacity-0'), delay);
                                    delay += 150; // Longer delay between words
                                });
                            } else if (node.nodeType === 1) { // Element node
                                const newElement = document.createElement(node.tagName);
                                newElement.className = node.className;
                                element.appendChild(newElement);
                                node.childNodes.forEach(child => processNode(child));
                            }
                        };
                        
                        tempDiv.childNodes.forEach(node => processNode(node));
                    }

                    function showCopyButtons() {
                        const copyButtons = document.querySelectorAll('.copy-button');
                        copyButtons.forEach(button => {
                            button.classList.remove('hidden');
                        });
                    }

                    function copyToClipboard(elementId, buttonElement) {
                        const element = document.getElementById(elementId);
                        const copyIcon = buttonElement.querySelector('.copy-icon');
                        const checkIcon = buttonElement.querySelector('.check-icon');
                        
                        // Create a temporary textarea element to copy from
                        const textarea = document.createElement('textarea');
                        textarea.value = element.value;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        
                        // Show check icon
                        copyIcon.classList.add('hidden');
                        checkIcon.classList.remove('hidden');
                        
                        // Reset to copy icon after 2 seconds
                        setTimeout(() => {
                            copyIcon.classList.remove('hidden');
                            checkIcon.classList.add('hidden');
                        }, 2000);
                    }

                    // Call this function when results are fetched successfully
                    function handleSuccessfulResults(response) {
                        console.log('Handling successful results:', response);
                        showCopyButtons();
                        
                        // Update input fields with response data
                        const amazonTitle = document.getElementById('amazon-title');
                        const expertTitle = document.getElementById('expert-title');
                        const description = document.getElementById('description');
                        const bulletPoints = document.getElementById('bullet-points');
                        const searchTerms = document.getElementById('search-terms');
                        
                        // Log if any elements are missing
                        if (!amazonTitle) console.warn('amazon-title element not found');
                        if (!expertTitle) console.warn('expert-title element not found');
                        if (!description) console.warn('description element not found');
                        if (!bulletPoints) console.warn('bullet-points element not found');
                        if (!searchTerms) console.warn('search-terms element not found');
                        
                        // Set values with null checks
                        if (amazonTitle) amazonTitle.value = response.amazon_title || '';
                        if (expertTitle) expertTitle.value = response.expert_title || '';
                        if (description) description.value = response.description || '';
                        
                        // Handle bullet points which could be array or string
                        if (bulletPoints) {
                            if (Array.isArray(response.bullet_points)) {
                                bulletPoints.value = response.bullet_points.join('\n') || '';
                            } else {
                                bulletPoints.value = response.bullet_points || '';
                            }
                        }
                        
                        if (searchTerms) searchTerms.value = response.search_terms || '';

                        // Update popup content
                        const popupAmazonTitle = document.getElementById('popup-amazon-title');
                        const popupExpertTitle = document.getElementById('popup-expert-title');
                        const popupDescription = document.getElementById('popup-description');
                        const popupBulletPoints = document.getElementById('popup-bullet-points');
                        const popupSearchTerms = document.getElementById('popup-search-terms');
                        
                        if (popupAmazonTitle) animateText(popupAmazonTitle, response.amazon_title || '');
                        if (popupExpertTitle) animateText(popupExpertTitle, response.expert_title || '');
                        if (popupDescription) animateText(popupDescription, response.description || '');
                        
                        // Handle bullet points in popup
                        if (popupBulletPoints) {
                            popupBulletPoints.innerHTML = ''; // Clear existing content
                            let points = [];
                            
                            if (Array.isArray(response.bullet_points)) {
                                points = response.bullet_points;
                            } else if (typeof response.bullet_points === 'string') {
                                points = response.bullet_points.split('\n');
                            }
                            
                            const bulletPointsContent = points.map(point => {
                                if (point && point.trim()) {
                                    return `<p>${point.trim()}</p>`;
                                }
                                return '';
                            }).join('');
                            
                            animateText(popupBulletPoints, bulletPointsContent);
                        }
                        
                        if (popupSearchTerms) animateText(popupSearchTerms, response.search_terms || '');

                        // Show results popup
                        const resultsPopup = document.getElementById('resultsPopup');
                        if (resultsPopup) {
                            resultsPopup.classList.remove('hidden');
                            resultsPopup.classList.add('flex');
                        }

                        // Hide loading spinner if present
                        const spinner = document.getElementById('loading-spinner');
                        if (spinner) {
                            spinner.classList.add('hidden');
                        }

                        // Hide error field if visible
                        const errorField = document.getElementById('error-field');
                        if (errorField) {
                            errorField.classList.add('hidden');
                        }
                    }
                </script>
            </div>

            <!-- Results Popup -->
            <div id="resultsPopup" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold quicksand">Generated Results</h3>
                        <button onclick="closeResultsPopup()" class="text-gray-500 hover:text-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-2 quicksand">Title As Per Platform</h4>
                            <p id="popup-amazon-title" class="text-gray-700"></p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2 quicksand">Title As Per Expert</h4>
                            <p id="popup-expert-title" class="text-gray-700"></p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2 quicksand">Description</h4>
                            <p id="popup-description" class="text-gray-700"></p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2 quicksand">Bullet Points</h4>
                            <div id="popup-bullet-points" class="text-gray-700"></div>
                        </div>
                        <div>
                            <h4 id="popup-search-term-label" class="font-semibold mb-2 quicksand">Search Terms</h4>
                            <p id="popup-search-terms" class="text-gray-700"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Image Popup -->
    <div id="imagePopup" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="relative bg-white p-4 rounded-lg max-w-[90vw] w-[1600px]">
            <button onclick="closeImagePopup()" class="absolute -top-4 -right-4 bg-red-500 text-white rounded-full w-10 h-10 flex items-center justify-center hover:bg-red-600 focus:outline-none shadow-lg text-2xl">
                ×
            </button>
            <img src="/media/keyword_screenshot.jpg" alt="Keyword Screenshot Example" class="max-w-full max-h-[80vh] object-contain rounded-lg">
        </div>
    </div>
    
    <!-- Add hidden input fields to maintain compatibility with existing JS -->
    <div class="hidden">
        <input type="url" id="url2">
        <input type="url" id="url3">
        <input type="url" id="url4">
        <textarea id="additional-specs"></textarea>
        <div id="results-section"></div>
    </div>
    
    <script>
        document.addEventListener('paste', function(event) {
            const items = (event.clipboardData || event.originalEvent.clipboardData).items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('preview1').src = e.target.result;
                        document.getElementById('preview-container1').classList.remove('hidden');
                    };
                    reader.readAsDataURL(blob);
                    
                    // Create a file input event to trigger the existing handler
                    const fileInput = document.getElementById('keyword-screenshot1');
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(blob);
                    fileInput.files = dataTransfer.files;
                    
                    // Trigger the change event
                    const event = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(event);
                    break;
                }
            }
        });
        
        function removeImage(previewId, containerId, inputId) {
            document.getElementById(previewId).src = '';
            document.getElementById(containerId).classList.add('hidden');
            document.getElementById(inputId).value = '';
            
            // Reset the file input
            const fileInput = document.getElementById(inputId);
            fileInput.value = '';
            if (fileInput.files) {
                const dataTransfer = new DataTransfer();
                fileInput.files = dataTransfer.files;
            }
        }
        
        // Function to handle file selection for preview
        function handleFileSelect(input, previewId, containerId, uploadTextId) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById(previewId).src = e.target.result;
                    document.getElementById(containerId).classList.remove('hidden');
                    if (uploadTextId) {
                        document.getElementById(uploadTextId).textContent = input.files[0].name;
                    }
                    console.log(`File loaded: ${input.id} - ${input.files[0].name} (${Math.round(input.files[0].size/1024)}KB)`);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Function to show the results popup
        function showResultsPopup() {
            const popup = document.getElementById('resultsPopup');
            popup.classList.remove('hidden');
            popup.classList.add('flex');

            // Copy the content from the main form to the popup
            document.getElementById('popup-amazon-title').textContent = document.getElementById('amazon-title').value;
            document.getElementById('popup-expert-title').textContent = document.getElementById('expert-title').value;
            document.getElementById('popup-description').textContent = document.getElementById('description').value;
            document.getElementById('popup-search-terms').textContent = document.getElementById('search-terms').value;

            // Handle bullet points - split by newlines and create list items
            const bulletPoints = document.getElementById('bullet-points').value.split('\n').filter(point => point.trim());
            const bulletPointsContainer = document.getElementById('popup-bullet-points');
            bulletPointsContainer.innerHTML = '';
            bulletPoints.forEach(point => {
                const p = document.createElement('p');
                p.textContent = point;
                bulletPointsContainer.appendChild(p);
            });
        }

        // Function to close the results popup
        function closeResultsPopup() {
            const popup = document.getElementById('resultsPopup');
            popup.classList.add('hidden');
            popup.classList.remove('flex');
        }
        
        // Function to close the image popup
        function closeImagePopup() {
            const popup = document.getElementById('imagePopup');
            popup.classList.add('hidden');
            popup.classList.remove('flex');
        }

        // Function to collect all form data
        function collectFormData() {
            const formData = {
                platform: document.getElementById('platform').value,
                brand: document.getElementById('brand').value,
                size: document.getElementById('size').value,
                material: document.getElementById('material').value,
                color: document.getElementById('color').value,
                otherSpecs: document.getElementById('other-specs').value,
                competitorUrls: [],
                productPhotos: []
            };

            // Collect competitor URLs from all visible URL inputs
            const urlInputs = document.querySelectorAll('input[id^="url"]');
            urlInputs.forEach(input => {
                if (input.value && input.value.trim() && !input.parentElement.classList.contains('hidden')) {
                    formData.competitorUrls.push(input.value.trim());
                    console.log(`Added URL: ${input.value.trim()}`);
                }
            });

            // Also check for URLs in dynamically added fields
            const urlIndicators = document.getElementById('url-indicators');
            if (urlIndicators) {
                const dynamicUrlInputs = urlIndicators.querySelectorAll('input[type="url"]');
                dynamicUrlInputs.forEach(input => {
                    if (input.value && input.value.trim()) {
                        formData.competitorUrls.push(input.value.trim());
                        console.log(`Added dynamic URL: ${input.value.trim()}`);
                    }
                });
            }

            // Collect product photos from all file inputs starting with "product-photo"
            const photoInputs = document.querySelectorAll('input[id^="product-photo"]');
            photoInputs.forEach(input => {
                if (input.files && input.files[0] && !input.parentElement.classList.contains('hidden')) {
                    formData.productPhotos.push(input.files[0]);
                    console.log(`Added photo: ${input.files[0].name}`);
                }
            });

            // Log collected data for debugging
            console.log(`Collected ${formData.competitorUrls.length} URLs and ${formData.productPhotos.length} photos`);
            
            return formData;
        }

        // Function to validate form data
        function validateFormData(formData) {
            const errors = [];
            console.log("Validating form data:", formData);

            if (!formData.brand) {
                errors.push('Brand name is required');
            }

            if (!formData.size) {
                errors.push('Size is required');
            }

            if (!formData.material) {
                errors.push('Material is required');
            }

            if (!formData.color) {
                errors.push('Color is required');
            }

            // URL validation with better error messaging
            if (formData.competitorUrls.length === 0) {
                errors.push('At least one competitor URL is required');
                console.log("URL validation failed: No URLs found");
                
                // Log all URL input elements for debugging
                const urlInputs = document.querySelectorAll('input[id^="url"]');
                urlInputs.forEach((input, index) => {
                    console.log(`URL input ${index+1} (${input.id}): ${input.value || 'empty'}`);
                });
            }

            // Photo validation with better error messaging
            if (formData.productPhotos.length < 1) {
                errors.push('At least 1 product photo is required');
                console.log("Photo validation failed: Not enough photos");
                
                // Log all photo input elements for debugging
                const photoInputs = document.querySelectorAll('input[id^="product-photo"]');
                photoInputs.forEach((input, index) => {
                    console.log(`Photo input ${index+1} (${input.id}): ${input.files && input.files[0] ? input.files[0].name : 'empty'}`);
                });
            }

            return errors;
        }

        // Function to handle form submission with validation
        function generateListing() {
            const formData = collectFormData();
            const errors = validateFormData(formData);

            if (errors.length > 0) {
                // Show errors in the error field
                const errorField = document.getElementById('error-field');
                const errorMessage = document.getElementById('error-message');
                errorField.classList.remove('hidden');
                errorMessage.innerHTML = errors.join('<br>');
                return;
            }

            // Hide error field if it was shown
            document.getElementById('error-field').classList.add('hidden');

            // Show loading state
            Swal.fire({
                title: 'Processing...',
                text: 'Please wait while we generate your listing',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Prepare the data for API
            const apiData = {
                platform_type: formData.platform,
                brand: formData.brand,
                urls: formData.competitorUrls,
                description: formData.otherSpecs,
                product_specs: {
                    size: formData.size,
                    material: formData.material,
                    color: formData.color
                },
                keyword_screenshots: [],
                product_images: []
            };

            // Log the prepared API data
            console.log('Prepared API data:', {
                platform: apiData.platform_type,
                brand: apiData.brand,
                urls: apiData.urls,
                product_specs: apiData.product_specs
            });

            // Create promises array for all file reading operations
            const fileReadPromises = [];

            // Get keyword screenshot data
            const keywordScreenshot = document.getElementById('preview1');
            if (keywordScreenshot && keywordScreenshot.src && keywordScreenshot.src.startsWith('data:')) {
                apiData.keyword_screenshots.push(keywordScreenshot.src);
                console.log('Added keyword screenshot from preview');
            } else if (document.getElementById('keyword-screenshot1').files && document.getElementById('keyword-screenshot1').files[0]) {
                const promise = new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        apiData.keyword_screenshots.push(e.target.result);
                        console.log('Added keyword screenshot from file input');
                        resolve();
                    };
                    reader.readAsDataURL(document.getElementById('keyword-screenshot1').files[0]);
                });
                fileReadPromises.push(promise);
            }

            // Get product photos data - handle both original and dynamically added fields
            const photoInputs = document.querySelectorAll('input[type="file"][id^="product-photo"], input[type="file"][id^="dynamic-photo-"]');
            console.log(`Found ${photoInputs.length} product photo inputs`);
            
            photoInputs.forEach((input, index) => {
                if (input.files && input.files[0]) {
                    const promise = new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            apiData.product_images.push(e.target.result);
                            console.log(`Added product image #${index+1} from ${input.id}`);
                            resolve();
                        };
                        reader.readAsDataURL(input.files[0]);
                    });
                    fileReadPromises.push(promise);
                }
            });

            // Wait for all file reading operations to complete before sending API request
            Promise.all(fileReadPromises)
                .then(() => {
                    // Log data being sent (for debugging)
                    console.log('Sending data to backend:', {
                        platform: apiData.platform_type,
                        brand: apiData.brand,
                        urls_count: apiData.urls.length,
                        urls: apiData.urls,
                        product_specs: apiData.product_specs,
                        keyword_screenshots_count: apiData.keyword_screenshots.length,
                        product_images_count: apiData.product_images.length
                    });

                    // Make API call to backend
                    return fetch('/listing_creater/ai-chat/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify(apiData)
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Update the form with the generated content
                    const response = data.response;
                    console.log('Response received from backend:', response);
                    
                    // Use the handleSuccessfulResults function to update the UI
                    handleSuccessfulResults(response);
                    
                    // Fallback direct updates for key fields
                    if (document.getElementById('amazon-title') && !document.getElementById('amazon-title').value) {
                        document.getElementById('amazon-title').value = response.amazon_title || '';
                        console.log('Direct update of amazon-title field');
                    }
                    
                    if (document.getElementById('expert-title') && !document.getElementById('expert-title').value) {
                        document.getElementById('expert-title').value = response.expert_title || '';
                        console.log('Direct update of expert-title field');
                    }
                    
                    // Close loading dialog
                    Swal.close();
                    
                    // Show results popup
                    showResultsPopup();
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        title: 'Error',
                        text: error.message || 'An error occurred while generating the listing',
                        icon: 'error'
                    });
                });
        }

        // Function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Function to add URL field
        function addUrlField() {
            const urlIndicators = document.getElementById('url-indicators');
            const urlCount = urlIndicators.querySelectorAll('.url-field').length + 1;
            
            if (urlCount > 4) {
                Swal.fire({
                    title: 'Maximum URLs Reached',
                    text: 'You can only add up to 4 competitor URLs',
                    icon: 'warning'
                });
                return;
            }

            // Create a new unique ID for this URL field
            const newId = `dynamic-url-${Date.now()}`;
            
            const urlInput = document.createElement('div');
            urlInput.className = 'flex items-center gap-2 mt-2 url-field';
            urlInput.innerHTML = `
                <input type="url" id="${newId}" placeholder="https://amazon.in/product" class="quicksand w-full px-3 py-2 border border-gray-200 rounded-lg bg-white text-sm box-border flex-grow">
                <button type="button" onclick="removeUrlField(this)" class="px-2 py-1 text-xs text-white rounded-lg bg-red-500 quicksand hover:bg-red-600 transition-colors">Remove</button>
            `;
            urlIndicators.appendChild(urlInput);
            
            console.log(`Added new URL field with ID: ${newId}`);
        }

        // Function to remove URL field
        function removeUrlField(button) {
            const field = button.parentElement;
            console.log(`Removing URL field: ${field.querySelector('input').id}`);
            field.remove();
        }

        // Function to add photo field
        function addPhotoField() {
            const photoIndicators = document.getElementById('photo-indicators');
            const photoCount = photoIndicators.querySelectorAll('.photo-field').length + 1;
            
            if (photoCount > 8) {
                Swal.fire({
                    title: 'Maximum Photos Reached',
                    text: 'You can only add up to 8 product photos',
                    icon: 'warning'
                });
                return;
            }

            // Create a new unique ID for this photo field
            const newPhotoId = `dynamic-photo-${Date.now()}`;
            const newTextId = `dynamic-text-${Date.now()}`;
            
            const photoInput = document.createElement('div');
            photoInput.className = 'flex items-center gap-2 mt-2 photo-field';
            photoInput.innerHTML = `
                <input type="text" id="${newTextId}" placeholder="Attach Upload" class="quicksand w-full px-3 py-2 border border-gray-200 rounded-lg bg-white text-sm box-border flex-grow" readonly onclick="document.getElementById('${newPhotoId}').click()">
                <button type="button" onclick="removePhotoField(this)" class="px-2 py-1 text-xs text-white rounded-lg bg-red-500 quicksand hover:bg-red-600 transition-colors">Remove</button>
                <input type="file" id="${newPhotoId}" class="hidden" accept="image/*" onchange="updatePhotoName('${newPhotoId}', '${newTextId}')">
            `;
            photoIndicators.appendChild(photoInput);
            
            console.log(`Added new photo field with ID: ${newPhotoId}`);
        }

        // Function to remove photo field
        function removePhotoField(button) {
            const field = button.parentElement;
            console.log(`Removing photo field: ${field.querySelector('input[type="file"]').id}`);
            field.remove();
        }

        // Function to update photo name in text input
        function updatePhotoName(inputId, textId) {
            const input = document.getElementById(inputId);
            const textInput = document.getElementById(textId);
            if (input.files && input.files[0]) {
                const file = input.files[0];
                textInput.value = file.name;
                
                // Log file information for troubleshooting
                console.log(`Product photo selected: ${inputId} - ${file.name} (${Math.round(file.size/1024)}KB)`);
                
                // Validate file type
                const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    Swal.fire({
                        title: 'Invalid File Type',
                        text: 'Please select a valid image file (JPEG, PNG, GIF, WebP)',
                        icon: 'error'
                    });
                    input.value = '';
                    textInput.value = '';
                    return;
                }
                
                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    Swal.fire({
                        title: 'File Too Large',
                        text: 'Please select an image file under 5MB',
                        icon: 'error'
                    });
                    input.value = '';
                    textInput.value = '';
                    return;
                }
            }
        }
    </script>
    
    <!-- Compatibility Layer for creater.js -->
    <script>
        // This script creates compatibility between our dynamic elements and the legacy creater.js
        document.addEventListener('DOMContentLoaded', function() {
            // Create compatibility elements for creater.js
            console.log('Setting up compatibility layer for creater.js');
            
            // Create hidden elements that creater.js expects
            function createCompatibilityElements() {
                const hiddenContainer = document.querySelector('.hidden') || document.createElement('div');
                
                // Check if productPhoto2 exists, create if not
                if (!document.getElementById('product-photo2')) {
                    console.log('Creating compatibility element: product-photo2');
                    const productPhoto2 = document.createElement('input');
                    productPhoto2.type = 'file';
                    productPhoto2.id = 'product-photo2';
                    productPhoto2.classList.add('hidden');
                    productPhoto2.accept = 'image/*';
                    hiddenContainer.appendChild(productPhoto2);
                }
                
                // Create other expected elements if needed
                if (!document.getElementById('additional-specs')) {
                    console.log('Creating compatibility element: additional-specs');
                    const additionalSpecs = document.createElement('textarea');
                    additionalSpecs.id = 'additional-specs';
                    additionalSpecs.classList.add('hidden');
                    hiddenContainer.appendChild(additionalSpecs);
                }
                
                // Create results section if it doesn't exist
                if (!document.getElementById('results-section')) {
                    console.log('Creating compatibility element: results-section');
                    const resultsSection = document.createElement('div');
                    resultsSection.id = 'results-section';
                    resultsSection.classList.add('hidden');
                    hiddenContainer.appendChild(resultsSection);
                }
                
                // Sync the other-specs with additional-specs
                const otherSpecs = document.getElementById('other-specs');
                const additionalSpecs = document.getElementById('additional-specs');
                if (otherSpecs && additionalSpecs) {
                    otherSpecs.addEventListener('input', function() {
                        additionalSpecs.value = this.value;
                    });
                }
                
                // Override the generateListing function in creater.js
                window.originalGenerateListingFunction = window.generateListing;
                window.generateListing = function() {
                    console.log('Using our custom generateListing instead of creater.js version');
                    
                    // Sync data from dynamic fields to compatibility fields before calling our implementation
                    syncFieldsForCompatibility();
                    
                    return window.originalGenerateListingFunction();
                };
            }
            
            // Function to synchronize our dynamic fields with legacy compatibility fields
            function syncFieldsForCompatibility() {
                // Sync product photos
                const dynamicPhotoInputs = document.querySelectorAll('input[type="file"][id^="dynamic-photo-"]');
                const productPhoto2 = document.getElementById('product-photo2');
                
                if (dynamicPhotoInputs.length > 0 && productPhoto2) {
                    // Take the first dynamic photo and copy it to product-photo2
                    const firstDynamicPhoto = dynamicPhotoInputs[0];
                    if (firstDynamicPhoto.files && firstDynamicPhoto.files[0]) {
                        // Create a DataTransfer object to transfer files
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(firstDynamicPhoto.files[0]);
                        productPhoto2.files = dataTransfer.files;
                        console.log('Synced dynamic photo to product-photo2 compatibility field');
                    }
                }
                
                // Sync URLs
                const dynamicUrlInputs = document.querySelectorAll('#url-indicators input[type="url"]');
                const url2 = document.getElementById('url2');
                const url3 = document.getElementById('url3');
                const url4 = document.getElementById('url4');
                
                if (dynamicUrlInputs.length > 0) {
                    // Map dynamic URLs to legacy URL fields
                    dynamicUrlInputs.forEach((input, index) => {
                        if (index === 0 && url2) url2.value = input.value;
                        if (index === 1 && url3) url3.value = input.value;
                        if (index === 2 && url4) url4.value = input.value;
                    });
                    console.log('Synced dynamic URLs to compatibility URL fields');
                }
                
                // Sync specifications
                const otherSpecs = document.getElementById('other-specs');
                const additionalSpecs = document.getElementById('additional-specs');
                if (otherSpecs && additionalSpecs) {
                    additionalSpecs.value = otherSpecs.value;
                    console.log('Synced specifications fields');
                }
            }
            
            // Call after a small delay to ensure DOM is fully loaded
            setTimeout(createCompatibilityElements, 500);
        });
    </script>
    
    <script src="{% static 'js/listing_creator/creater.js' %}"></script>
</body>
</html>
{% endblock %}
