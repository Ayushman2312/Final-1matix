{% extends 'user_dashboard/base.html' %}
{% load static %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    {% comment %} <title>Onboarding</title> {% endcomment %}
    <style>
        @media (max-width: 768px) {
            .tab-container button {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }
            .two-column-layout {
                flex-direction: column;
            }
            .two-column-layout > div {
                width: 100%;
                margin-bottom: 1rem;
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
        </style>
</head>
<body class="bg-gray-50">
  <div class="container mx-auto px-4">
    <!-- Toggle Switch -->
    <div class="mb-6 flex justify-start gap-2">
        <div>
          <button id="addEmployeeTab" onclick="switchTab('add')" class="px-6 py-2 border border-[#7B3DF3] text-sm text-white rounded-xl font-medium text-center">
              AddNew
          </button>
      </div>
      <div>
          <button id="viewEmployeesTab" onclick="switchTab('view')" class="px-6 py-2 text-sm border border-[#7B3DF3] text-white rounded-xl font-medium text-center">
              See Invites
          </button>
      </div>
    </div>

    <!-- Main Content Section with Two Columns -->
    <div class="two-column-layout flex flex-wrap lg:flex-nowrap gap-6">
        <!-- Left Column - Form Section -->
        <div id="employeeForm" class="w-full lg:w-1/2">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Company</label>
                        <select class="w-full border text-sm border-gray-200 rounded-md py-2 px-3 focus:outline-none focus:ring-1 focus:ring-blue-500 text-gray-600">
                            <option disabled selected>Company</option>
                            {% for company in companies %}
                                <option value="{{ company.company_id }}">{{ company.company_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                        <input type="text" placeholder="Name" class="w-full border text-sm border-gray-200 rounded-md py-2 px-3 focus:outline-none focus:ring-1 focus:ring-blue-500 text-gray-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" placeholder="Select and Paste" class="w-full border text-sm border-gray-200 rounded-md py-2 px-3 focus:outline-none focus:ring-1 focus:ring-blue-500 text-gray-600">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                        <select id="departmentSelect" class="w-full border text-sm border-gray-200 rounded-md py-2 px-3 focus:outline-none focus:ring-1 focus:ring-blue-500 text-gray-600">
                            <option value="">Select Department</option>
                            {% for department in departments %}
                                <option value="{{ department.department_id }}">{{ department.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Designation</label>
                        <select id="designationSelect" class="w-full border text-sm border-gray-200 rounded-md py-2 px-3 focus:outline-none focus:ring-1 focus:ring-blue-500 text-gray-600">
                            <option value="">Select Designation</option>
                            {% for designation in designations %}
                                <option value="{{ designation.designation_id }}">{{ designation.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                        <select id="roleSelect" class="w-full border text-sm border-gray-200 rounded-md py-2 px-3 focus:outline-none focus:ring-1 focus:ring-blue-500 text-gray-600">
                            <option value="">Select Role</option>
                            {% for role in roles %}
                                <option value="{{ role.role_id }}">{{ role.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Offer Letter</label>
                    <div class="relative">
                        <select id="offerLetterSelect" class="w-full h-12 border-2 border-[#7B3DF3] text-sm rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-[#7B3DF3] focus:border-[#7B3DF3] text-gray-700 bg-white shadow-sm transition-all duration-300 hover:border-[#9B6FF5] appearance-none cursor-pointer">
                            <option value="" disabled selected>Select Offer Letter Template</option>
                            {% for letter in offer_letters %}
                            <option value="{{ letter.offer_letter_id }}">{{ letter.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none">
                            <svg class="w-5 h-5 text-[#7B3DF3]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                        <div id="previewButtons" class="hidden absolute right-12 top-1/2 -translate-y-1/2 flex items-center space-x-2">
                            <button id="previewButton" class="text-[#7B3DF3] hover:text-white hover:bg-[#7B3DF3] p-2 rounded-full transition-colors duration-200 border border-[#7B3DF3]">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-1">Select a template to preview or click the eye icon to view it.</p>
                
                <script>
                    const select = document.getElementById('offerLetterSelect');
                    const previewButtons = document.getElementById('previewButtons');
                    
                    // Show/hide preview button when select has a value
                    select.addEventListener('change', function() {
                        if(this.value) {
                            previewButtons.classList.remove('hidden');
                        } else {
                            previewButtons.classList.add('hidden');
                        }
                    });
                    
                    select.addEventListener('focus', function() {
                        if(this.value) {
                            previewButtons.classList.remove('hidden');
                        }
                    });
                    
                    select.addEventListener('blur', function(e) {
                        // Small delay to allow clicking the preview button
                        setTimeout(() => {
                            if(!e.relatedTarget || !e.relatedTarget.closest('#previewButtons')) {
                                previewButtons.classList.add('hidden');
                            }
                        }, 100);
                    });
                    
                    // Tab switching functionality
                    function switchTab(tab) {
                        const addEmployeeTab = document.getElementById('addEmployeeTab');
                        const viewEmployeesTab = document.getElementById('viewEmployeesTab');
                        const employeeForm = document.getElementById('employeeForm');
                        const rightColumn = document.querySelector('.two-column-layout > div:last-child');
                        const viewEmployeesSection = document.getElementById('viewEmployeesSection');
                        
                        if (tab === 'add') {
                            // Show the Add Employee form UI
                            addEmployeeTab.classList.remove('bg-white', 'text-[#7B3DF3]');
                            addEmployeeTab.classList.add('bg-[#7B3DF3]', 'text-white');
                            viewEmployeesTab.classList.remove('bg-[#7B3DF3]', 'text-white');
                            viewEmployeesTab.classList.add('bg-white', 'text-[#7B3DF3]');
                            
                            // Show form and right column
                            employeeForm.style.display = 'block';
                            rightColumn.style.display = 'block';
                            
                            // Hide the employees table
                            if (viewEmployeesSection) {
                                viewEmployeesSection.style.display = 'none';
                            }
                            
                            // Remove full width class from parent if it was added
                            viewEmployeesSection.parentElement.classList.remove('w-full');
                            
                            // Clear any refresh timers
                            if (window.tableRefreshTimer) {
                                clearTimeout(window.tableRefreshTimer);
                                window.tableRefreshTimer = null;
                            }
                        } else if (tab === 'view') {
                            // Show the View Employees UI
                            viewEmployeesTab.classList.remove('bg-white', 'text-[#7B3DF3]');
                            viewEmployeesTab.classList.add('bg-[#7B3DF3]', 'text-white');
                            addEmployeeTab.classList.remove('bg-[#7B3DF3]', 'text-white');
                            addEmployeeTab.classList.add('bg-white', 'text-[#7B3DF3]');
                            
                            // Hide form and right column
                            employeeForm.style.display = 'none';
                            rightColumn.style.display = 'none';
                            
                            // Show the employees table and populate it
                            if (viewEmployeesSection) {
                                viewEmployeesSection.style.display = 'block';
                                // Add full width to the view section
                                viewEmployeesSection.parentElement.classList.add('w-full');
                                
                                // Force a refresh of invitation data
                                window.invitationsData = null;
                                
                                // Show loading state while fetching fresh data
                                viewEmployeesSection.innerHTML = '<div class="text-center py-4">Refreshing invitation data...</div>';
                                
                                // Optional: Add a slight delay to show the loading message
                                setTimeout(() => {
                                    // Populate the table with actual data
                                    populateEmployeesTable();
                                }, 300);
                            }
                        }
                    }

                    // Initialize with the Add tab active
                    document.addEventListener('DOMContentLoaded', function() {
                        switchTab('add');
                    });
                </script>
                
                <!-- Photo Upload Section -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Employee Photo</label>
                    <div class="flex items-center space-x-6">
                        <div class="shrink-0 w-24 h-24 bg-gray-100 rounded-full overflow-hidden border border-gray-200">
                            <img id="photoPreview" class="w-full h-full object-cover hidden" src="" alt="Employee photo preview">
                            <div id="photoPlaceholder" class="w-full h-full flex items-center justify-center text-gray-400">
                                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                        </div>
                        <label class="block">
                            <span class="sr-only">Choose employee photo</span>
                            <input type="file" id="photoUpload" accept="image/*" class="block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-md file:border-0
                                file:text-sm file:font-medium
                                file:bg-purple-50 file:text-purple-700
                                hover:file:bg-purple-100
                            "/>
                            <p class="mt-1 text-sm text-gray-500">PNG, JPG, GIF up to 1MB</p>
                        </label>
                    </div>
                </div>
                
                <!-- Policies Section -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Policies</label>
                    <div class="flex mb-2">
                        <input type="text" placeholder="Attach Upload (Min. 2)" class="w-full border text-sm border-gray-200 rounded-l-md py-2 px-3 focus:outline-none focus:ring-1 focus:ring-blue-500 text-gray-600">
                        <button class="bg-[#7B3DF3] text-white px-5 py-2 rounded-r-md hover:bg-blue-600 transition duration-200">Add</button>
                    </div>
                    <div class="flex flex-wrap gap-2 mt-3">
                        <!-- Policy tags will be added here dynamically -->
                    </div>
                </div>
                
                <div class="text-center mt-10">
                    <button id="sendButton" class="bg-[#7B3DF3] hover:bg-blue-600 text-white font-medium py-2 px-12 rounded-md transition duration-200">
                        Send
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Right Column - Preview & Recent Submissions -->
        <div class="w-full lg:w-1/2 space-y-6">
            <!-- Offer Letter Preview -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-sm font-semibold text-[13px] text-gray-800 uppercase mb-4">OFFER LETTER PREVIEW</h2>
                <div class="h-56 bg-gray-50 border border-gray-200 rounded-md">
                    <div class="p-4 h-full overflow-auto text-gray-800 offer-letter-preview-content">
                        <p class="text-gray-500">Select an offer letter template and click the preview button to see it here.</p>
                    </div>
                </div>
            </div>
            
            <!-- Recent Submissions -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-[13px] font-semibold text-gray-800 uppercase mb-4">RECENTLY SUBMITTED PROFILES</h2>
                <div id="viewEmployeesSection" class="overflow-x-auto">
                    <!-- Table will be shown here when needed -->
                </div>
            </div>
        </div>
    </div>
  </div>
  
  <!-- Employee Dashboard Access -->
  <div class="container mx-auto px-4 mt-12 mb-12">
    <h2 class="text-xl font-bold text-gray-800 mb-6">Employee Dashboard Access</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <!-- Attendance QR Scanner -->
      <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300">
        <div class="flex items-center justify-center mb-4 text-[#7B3DF3]">
          <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-800 mb-2 text-center">Mark Attendance</h3>
        <p class="text-sm text-gray-600 mb-4 text-center">Scan QR code to mark your daily attendance</p>
        <button id="openQrScannerBtn" class="w-full py-2 px-4 bg-[#7B3DF3] text-white rounded-md hover:bg-[#6935D3] transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#7B3DF3]">
          Scan QR Code
        </button>
        <!-- QR Scanner Modal (hidden by default) -->
        <div id="qrScannerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
          <div class="bg-white p-6 rounded-lg max-w-md w-full">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold text-gray-800">Scan QR Code</h3>
              <button id="closeQrScannerBtn" class="text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <div id="qrScannerContainer" class="w-full h-64 bg-gray-100 flex items-center justify-center mb-4">
              <p class="text-gray-500">Camera feed will appear here</p>
            </div>
            <div class="text-center">
              <p id="qrScanStatus" class="text-sm text-gray-600 mb-4">Please allow camera access to scan QR code</p>
              <button id="markAttendanceBtn" class="py-2 px-4 bg-[#7B3DF3] text-white rounded-md hover:bg-[#6935D3] transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#7B3DF3] disabled:opacity-50" disabled>
                Mark Attendance
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Apply for Leave -->
      <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300">
        <div class="flex items-center justify-center mb-4 text-[#7B3DF3]">
          <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-800 mb-2 text-center">Apply for Leave</h3>
        <p class="text-sm text-gray-600 mb-4 text-center">Request time off and view your leave balance</p>
        <button id="applyLeaveBtn" class="w-full py-2 px-4 bg-[#7B3DF3] text-white rounded-md hover:bg-[#6935D3] transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#7B3DF3]">
          Apply Now
        </button>
      </div>
      
      <!-- Reimbursement Requests -->
      <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300">
        <div class="flex items-center justify-center mb-4 text-[#7B3DF3]">
          <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-800 mb-2 text-center">Reimbursement</h3>
        <p class="text-sm text-gray-600 mb-4 text-center">Submit expense claims and track reimbursements</p>
        <button id="submitReimbursementBtn" class="w-full py-2 px-4 bg-[#7B3DF3] text-white rounded-md hover:bg-[#6935D3] transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#7B3DF3]">
          Submit Claim
        </button>
      </div>
      
      <!-- Salary Slips -->
      <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300">
        <div class="flex items-center justify-center mb-4 text-[#7B3DF3]">
          <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-800 mb-2 text-center">Salary Slips</h3>
        <p class="text-sm text-gray-600 mb-4 text-center">View and download your monthly salary slips</p>
        <button id="viewSalarySlipsBtn" class="w-full py-2 px-4 bg-[#7B3DF3] text-white rounded-md hover:bg-[#6935D3] transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#7B3DF3]">
          View Slips
        </button>
      </div>
      
      <!-- Resignation -->
      <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300">
        <div class="flex items-center justify-center mb-4 text-[#7B3DF3]">
          <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-800 mb-2 text-center">Resignation</h3>
        <p class="text-sm text-gray-600 mb-4 text-center">Submit your resignation and view notice period</p>
        <button id="submitResignationBtn" class="w-full py-2 px-4 bg-[#7B3DF3] text-white rounded-md hover:bg-[#6935D3] transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#7B3DF3]">
          Submit Request
        </button>
      </div>
    </div>
  </div>
  
  <script>
    // Pass invitations data to JavaScript
    window.invitationsData = [
    {% for invitation in invitations %}
        {
            invitation_id: "{{ invitation.invitation_id }}",
            name: "{{ invitation.name }}",
            email: "{{ invitation.email }}",
            department: "{{ invitation.department|default:'' }}",
            designation: "{{ invitation.designation|default:'' }}",
            role: "{{ invitation.role|default:'' }}",
            status: "{{ invitation.status }}",
            sent_at: "{{ invitation.sent_at|date:'c' }}",
            form_link: "{{ invitation.form_link }}"
        }{% if not forloop.last %},{% endif %}
    {% endfor %}
    ];
    
    // Pass departments, designations, and roles to JavaScript
    window.departmentsData = [
    {% for department in departments %}
        {
            id: "{{ department.department_id }}",
            name: "{{ department.name }}"
        }{% if not forloop.last %},{% endif %}
    {% endfor %}
    ];
    
    window.designationsData = [
    {% for designation in designations %}
        {
            id: "{{ designation.designation_id }}",
            name: "{{ designation.name }}"
        }{% if not forloop.last %},{% endif %}
    {% endfor %}
    ];
    
    window.rolesData = [
    {% for role in roles %}
        {
            id: "{{ role.role_id }}",
            name: "{{ role.name }}"
        }{% if not forloop.last %},{% endif %}
    {% endfor %}
    ];
  </script>
  
  <script src="{% static 'js/hr/onboarding.js' %}"></script>

  <!-- QR Code Scanner library -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  
  <script>
    // Employee Dashboard Features
    document.addEventListener('DOMContentLoaded', function() {
      // QR Scanner Functionality
      const openQrScannerBtn = document.getElementById('openQrScannerBtn');
      const closeQrScannerBtn = document.getElementById('closeQrScannerBtn');
      const qrScannerModal = document.getElementById('qrScannerModal');
      const qrScannerContainer = document.getElementById('qrScannerContainer');
      const qrScanStatus = document.getElementById('qrScanStatus');
      const markAttendanceBtn = document.getElementById('markAttendanceBtn');
      
      let html5QrCode;
      let lastScannedCode = null;
      
      if (openQrScannerBtn) {
        openQrScannerBtn.addEventListener('click', function() {
          qrScannerModal.classList.remove('hidden');
          startQrScanner();
        });
      }
      
      if (closeQrScannerBtn) {
        closeQrScannerBtn.addEventListener('click', function() {
          stopQrScanner();
          qrScannerModal.classList.add('hidden');
        });
      }
      
      function startQrScanner() {
        html5QrCode = new Html5Qrcode("qrScannerContainer");
        qrScanStatus.textContent = "Starting camera...";
        
        html5QrCode.start(
          { facingMode: "environment" },
          {
            fps: 10,
            qrbox: { width: 250, height: 250 }
          },
          onScanSuccess,
          onScanFailure
        ).catch(function(err) {
          qrScanStatus.textContent = "Error starting camera: " + err;
        });
      }
      
      function stopQrScanner() {
        if (html5QrCode && html5QrCode.isScanning) {
          html5QrCode.stop().then(() => {
            console.log('QR scanner stopped');
          }).catch(err => {
            console.error('Error stopping QR scanner:', err);
          });
        }
      }
      
      function onScanSuccess(decodedText, decodedResult) {
        // Play a success sound
        const audio = new Audio("{% static 'sounds/beep.mp3' %}");
        audio.play();
        
        // Update UI
        qrScanStatus.textContent = "QR Code detected!";
        lastScannedCode = decodedText;
        markAttendanceBtn.disabled = false;
        
        // Optional: Stop scanning after successful scan
        stopQrScanner();
      }
      
      function onScanFailure(error) {
        // Handle scan failure silently
        console.warn(`QR code scanning failed: ${error}`);
      }
      
      if (markAttendanceBtn) {
        markAttendanceBtn.addEventListener('click', function() {
          if (lastScannedCode) {
            // Here you would send the scanned code to your server
            qrScanStatus.textContent = "Marking attendance...";
            
            // Simulate API call
            setTimeout(function() {
              qrScanStatus.textContent = "Attendance marked successfully!";
              qrScanStatus.classList.add('text-green-600');
              
              // Close modal after 2 seconds
              setTimeout(function() {
                qrScannerModal.classList.add('hidden');
                qrScanStatus.classList.remove('text-green-600');
                lastScannedCode = null;
                markAttendanceBtn.disabled = true;
              }, 2000);
            }, 1500);
          }
        });
      }
      
      // Leave Application
      const applyLeaveBtn = document.getElementById('applyLeaveBtn');
      if (applyLeaveBtn) {
        applyLeaveBtn.addEventListener('click', function() {
          window.location.href = "/hr_management/leave/";
        });
      }
      
      // Reimbursement Request
      const submitReimbursementBtn = document.getElementById('submitReimbursementBtn');
      if (submitReimbursementBtn) {
        submitReimbursementBtn.addEventListener('click', function() {
          window.location.href = "/hr_management/reimbursement/";
        });
      }
      
      // Salary Slips
      const viewSalarySlipsBtn = document.getElementById('viewSalarySlipsBtn');
      if (viewSalarySlipsBtn) {
        viewSalarySlipsBtn.addEventListener('click', function() {
          window.location.href = "/hr_management/salary-slips/";
        });
      }
      
      // Resignation
      const submitResignationBtn = document.getElementById('submitResignationBtn');
      if (submitResignationBtn) {
        submitResignationBtn.addEventListener('click', function() {
          window.location.href = "/hr_management/resignation/";
        });
      }
    });
  </script>

  <!-- Employee table management -->
  <script>
    function populateEmployeesTable() {
        const viewEmployeesSection = document.getElementById('viewEmployeesSection');
        if (!viewEmployeesSection) return;
        
        // Show loading state
        viewEmployeesSection.innerHTML = '<div class="text-center py-4">Loading invitations...</div>';
        
        // Fetch fresh invitation data from the server
        fetch('/hr_management/onboarding/invitations/?v=2', {
            method: 'GET',
            headers: {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the global invitations data
                window.invitationsData = data.invitations || [];
                
                // Continue with populating the table
                renderInvitationsTable();
            } else {
                // Fall back to cached data if server request fails
                renderInvitationsTable(window.invitationsData || []);
            }
        })
        .catch(error => {
            console.error('Error fetching invitations:', error);
            // Fall back to cached data if server request fails
            renderInvitationsTable(window.invitationsData || []);
        });
        
        // Separate function to render the table with the data
        function renderInvitationsTable(invitationsData = window.invitationsData || []) {
            if (invitationsData.length === 0) {
                viewEmployeesSection.innerHTML = '<div class="text-center py-4 text-gray-500">No invitations found.</div>';
                return;
            }
            
            // Add status legend at the top
            let legendHTML = `
                <div class="bg-white p-4 rounded-lg shadow-sm mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-medium text-gray-700">Status Legend:</h3>
                        <button id="refreshInvitationsBtn" class="text-[#7B3DF3] hover:text-[#6935D3] text-sm flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Refresh
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <div class="flex items-center">
                            <span class="inline-block w-2 h-2 rounded-full bg-gray-100 mr-1"></span>
                            <span class="text-xs text-gray-600">Pending: Invitation created but not sent</span>
                        </div>
                        <div class="flex items-center">
                            <span class="inline-block w-2 h-2 rounded-full bg-yellow-100 mr-1"></span>
                            <span class="text-xs text-gray-600">Sent: Invitation sent to employee</span>
                        </div>
                        <div class="flex items-center">
                            <span class="inline-block w-2 h-2 rounded-full bg-blue-100 mr-1"></span>
                            <span class="text-xs text-gray-600">Completed: Form filled by employee, awaiting your action</span>
                        </div>
                        <div class="flex items-center">
                            <span class="inline-block w-2 h-2 rounded-full bg-green-100 mr-1"></span>
                            <span class="text-xs text-gray-600">Accepted: Employee has dashboard access</span>
                        </div>
                        <div class="flex items-center">
                            <span class="inline-block w-2 h-2 rounded-full bg-red-100 mr-1"></span>
                            <span class="text-xs text-gray-600">Rejected/Expired: Employee does not have access</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Generate table HTML
            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Department</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Sent Date</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            // Add invitation rows
            invitationsData.forEach(invitation => {
                // Format date
                const sentDate = invitation.sent_at ? new Date(invitation.sent_at).toLocaleDateString() : 'Not sent';
                
                // Determine status class and tooltip text
                let statusClass = '';
                let statusTooltip = '';
                
                switch(invitation.status) {
                    case 'pending':
                        statusClass = 'bg-gray-100 text-gray-800';
                        statusTooltip = 'Invitation is pending to be sent';
                        break;
                    case 'sent':
                        statusClass = 'bg-yellow-100 text-yellow-800';
                        statusTooltip = 'Invitation has been sent but not yet completed by the employee';
                        break;
                    case 'completed':
                        statusClass = 'bg-blue-100 text-blue-800';
                        statusTooltip = 'Form has been filled by the employee, awaiting approval/rejection';
                        break;
                    case 'accepted':
                        statusClass = 'bg-green-100 text-green-800';
                        statusTooltip = 'Employee has been accepted and has dashboard access';
                        break;
                    case 'rejected':
                        statusClass = 'bg-red-100 text-red-800';
                        statusTooltip = 'Employee has been rejected and does not have dashboard access';
                        break;
                    case 'expired':
                        statusClass = 'bg-red-100 text-red-800';
                        statusTooltip = 'Invitation has expired';
                        break;
                    default:
                        statusClass = 'bg-gray-100 text-gray-800';
                        statusTooltip = 'Unknown status';
                }
                
                // Make sure invitation_id is available and not undefined
                const invitationId = invitation.invitation_id || '';
                
                tableHTML += `
                    <tr>
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${invitation.name || '-'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${invitation.email || '-'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${invitation.department || '-'}</td>
                        <td class="px-4 py-2 whitespace-nowrap">
                            <div class="flex items-center space-x-3">
                                <!-- Different action buttons based on status -->
                                ${invitation.status === 'completed' ? `
                                    <!-- For completed invitations, show view button and review button -->
                                    <button 
                                        class="text-blue-600 hover:text-blue-800 focus:outline-none" 
                                        title="View Details"
                                        onclick="viewInvitationDetails('${invitationId}')">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                        </svg>
                                    </button>
                                    <a 
                                        href="/hr/onboarding/form-action/${invitationId}/"
                                        class="text-green-600 hover:text-green-800 focus:outline-none" 
                                        title="Review Application">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                        </svg>
                                    </a>
                                ` : invitation.status === 'accepted' ? `
                                    <!-- For accepted invitations, show view button only -->
                                    <button 
                                        class="text-blue-600 hover:text-blue-800 focus:outline-none" 
                                        title="View Details"
                                        onclick="viewInvitationDetails('${invitationId}')">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                        </svg>
                                    </button>
                                ` : invitation.status === 'rejected' ? `
                                    <!-- For rejected invitations, show view button and delete option -->
                                    <button 
                                        class="text-blue-600 hover:text-blue-800 focus:outline-none" 
                                        title="View Details"
                                        onclick="viewInvitationDetails('${invitationId}')">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                        </svg>
                                    </button>
                                    <button 
                                        class="text-red-600 hover:text-red-800 focus:outline-none" 
                                        title="Delete" 
                                        onclick="deleteInvitation('${invitationId}')">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                ` : invitation.status === 'need_discussion' ? `
                                    <!-- For discussion requests, show view button only -->
                                    <button 
                                        class="text-blue-600 hover:text-blue-800 focus:outline-none" 
                                        title="View Details"
                                        onclick="viewInvitationDetails('${invitationId}')">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                        </svg>
                                    </button>
                                ` : `
                                    <!-- For other statuses (sent, pending), show view button only -->
                                    <button 
                                        class="text-blue-600 hover:text-blue-800 focus:outline-none" 
                                        title="View Details"
                                        onclick="viewInvitationDetails('${invitationId}')">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                        </svg>
                                    </button>
                                `}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            viewEmployeesSection.innerHTML = legendHTML + tableHTML;
            
            // Add refresh button functionality
            const refreshButton = document.getElementById('refreshInvitationsBtn');
            if (refreshButton) {
                refreshButton.addEventListener('click', function() {
                    // Show loading state
                    viewEmployeesSection.innerHTML = '<div class="text-center py-4">Refreshing invitation data...</div>';
                    
                    // Force a refresh by calling populateEmployeesTable again
                    setTimeout(() => {
                        populateEmployeesTable();
                    }, 300);
                });
            }
            
            // Add table automatic refresh functionality
            const refreshInterval = 30000; // 30 seconds
            if (window.tableRefreshTimer) {
                clearTimeout(window.tableRefreshTimer);
            }
            
            window.tableRefreshTimer = setTimeout(() => {
                if (document.getElementById('viewEmployeesSection') && 
                    document.getElementById('viewEmployeesSection').style.display !== 'none') {
                    populateEmployeesTable();
                }
            }, refreshInterval);
        }
    }

    // View invitation details
    function viewInvitationDetails(invitationId) {
        // Show loading indicator
        Swal.fire({
            title: 'Loading...',
            text: 'Fetching invitation details',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // Fetch invitation details from the server
        fetch(`/hr_management/onboarding/invitation/${invitationId}/?v=2`, {
            headers: {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                Swal.close();
                if (data.success) {
                    const invitation = data.invitation;
                    
                    // Format dates for display
                    const sentDate = invitation.sent_at ? new Date(invitation.sent_at).toLocaleString() : 'Not sent';
                    const completedDate = invitation.completed_at ? new Date(invitation.completed_at).toLocaleString() : 'Not completed';
                    const rejectedDate = invitation.rejected_at ? new Date(invitation.rejected_at).toLocaleString() : '';
                    
                    // Build HTML content for the modal
                    let content = `
                        <div class="text-left">
                            <p><strong>Name:</strong> ${invitation.name}</p>
                            <p><strong>Email:</strong> ${invitation.email}</p>
                            <p><strong>Department:</strong> ${invitation.department || 'Not specified'}</p>
                            <p><strong>Designation:</strong> ${invitation.designation || 'Not specified'}</p>
                            <p><strong>Role:</strong> ${invitation.role || 'Not specified'}</p>
                            <p><strong>Status:</strong> ${invitation.status.charAt(0).toUpperCase() + invitation.status.slice(1)}</p>
                            <p><strong>Sent on:</strong> ${sentDate}</p>
                    `;
                    
                    // Add status-specific information
                    if (invitation.status === 'completed') {
                        content += `<p><strong>Completed on:</strong> ${completedDate}</p>`;
                    } else if (invitation.status === 'rejected') {
                        content += `
                            <p><strong>Rejected on:</strong> ${rejectedDate}</p>
                            <div class="mt-2">
                                <p><strong>Rejection reason:</strong></p>
                                <div class="p-2 bg-gray-100 rounded text-sm">${invitation.rejection_reason || 'No reason provided'}</div>
                            </div>
                        `;
                    } else if (invitation.status === 'need_discussion') {
                        content += `
                            <div class="mt-2">
                                <p><strong>Discussion request:</strong></p>
                                <div class="p-2 bg-gray-100 rounded text-sm">${invitation.discussion_message || 'No details provided'}</div>
                            </div>
                        `;
                    }
                    
                    content += `</div>`;
                    
                    // Show the details in a modal
                    Swal.fire({
                        title: 'Invitation Details',
                        html: content,
                        confirmButtonColor: '#7B3DF3',
                        confirmButtonText: 'Close',
                        width: '600px'
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message || 'Could not fetch invitation details',
                        confirmButtonColor: '#7B3DF3'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred while fetching the invitation details',
                    confirmButtonColor: '#7B3DF3'
                });
            });
    }

    // Delete invitation
    function deleteInvitation(invitationId) {
        // Confirm deletion
        Swal.fire({
            title: 'Delete Invitation',
            text: 'Are you sure you want to delete this invitation? This action cannot be undone.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#EF4444',
            cancelButtonColor: '#6B7280',
            confirmButtonText: 'Yes, delete it',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                // Send delete request
                fetch(`/hr_management/onboarding/invitation/${invitationId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken()
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Deleted',
                                text: 'Invitation has been deleted successfully',
                                confirmButtonColor: '#7B3DF3'
                            }).then(() => {
                                // Refresh the table
                                populateEmployeesTable();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.message || 'Could not delete invitation',
                                confirmButtonColor: '#7B3DF3'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'An error occurred while deleting the invitation',
                            confirmButtonColor: '#7B3DF3'
                        });
                    });
            }
        });
    }

    // Get CSRF token from cookies
    function getCsrfToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
  </script>
</body>
</html>
{% endblock %}
