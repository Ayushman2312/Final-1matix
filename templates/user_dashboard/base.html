{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>1Matrix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="/media/Favicon.png">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: {
                        'xs': '480px',
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Quicksand:wght@300..700&display=swap">
    <link rel="stylesheet" href="{% static 'css/user.css' %}">
    <!-- Add CSRF Token meta tag -->
    {% csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token }}">
    <style>
        @keyframes reminderFlash {
            0%, 100% { box-shadow: 0 10px 15px -3px rgba(123, 61, 243, 0.2), 0 4px 6px -2px rgba(123, 61, 243, 0.1); }
            50% { box-shadow: 0 10px 25px -5px rgba(123, 61, 243, 0.4), 0 8px 10px -6px rgba(123, 61, 243, 0.2); }
        }
        .reminder-flashing {
            animation: reminderFlash 1s infinite;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col">
    <!-- Overlay for mobile -->
    <div id="overlay" class="overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar Navigation -->
    <div id="sidebar" class="sidebar-transition fixed h-full bg-[#7B3DF3] w-64 z-50 shadow-lg md:block sidebar-mobile overflow-y-auto" style="scrollbar-width: none; -ms-overflow-style: none;">
        <!-- Logo Section -->
        <div class="py-4 border-b border-[#9362F7]">
            <a href="/user/dashboard/" class="block mx-7 mt-[5px] relative">
                <!-- Logo -->
                <div class="text-white text-3xl font-bold lexend-1matrix">1Matrix.io</div>
                <!-- Small logo for collapsed sidebar -->
                <div class="w-8 h-auto absolute top-0 left-0 hidden transition-all duration-300 text-white font-bold" id="smallLogo">I.io</div>
            </a>
        </div>
        <nav class="mt-4" style="font-family: 'Montserrat', sans-serif;">
            <!-- Main Navigation -->
            <div class="px-4 mb-6">
                <a href="#" class="flex items-center px-4 py-3 text-sm rounded-lg text-white bg-[#6931D3] hover:bg-[#6931D3] transition-all duration-200">
                    <svg class="h-5 w-5 min-w-[1.25rem]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    <span class="ml-3 sidebar-text">Dashboard</span>
                </a>
            </div>

            <!-- Apps Section -->
            <div class="px-4 space-y-1">
                <a href="/fee_calculator/" class="flex items-center px-4 py-3 text-sm rounded-lg text-white hover:bg-[#6931D3] transition-all duration-200">
                    <svg class="h-5 w-5 min-w-[1.25rem]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                    </svg>
                    <span class="ml-3 sidebar-text">Fee Calculator</span>
                </a>

                <a href="/listing_creater/ai-chat/" class="flex items-center px-4 py-3 text-sm rounded-lg text-white hover:bg-[#6931D3] transition-all duration-200">
                    <svg class="h-5 w-5 min-w-[1.25rem]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                    <span class="ml-3 sidebar-text">AI Listing Creater</span>
                </a>

                <div class="relative">
                    <button onclick="toggleDropdown(this)" class="flex items-center px-4 py-3 text-sm rounded-lg text-white hover:bg-[#6931D3] transition-all duration-200 w-full">
                        <svg class="h-5 w-5 min-w-[1.25rem]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                        <span class="ml-3 sidebar-text">HR Management</span>
                        <svg class="w-4 h-4 ml-auto transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="hidden mt-1 ml-8 space-y-1">
                        <a href="/hr_management/company/" class="block px-4 py-2 text-sm text-white rounded-lg">Company</a>
                        <a href="/hr_management/onboarding/" class="block px-4 py-2 text-sm text-white rounded-lg">Onboarding</a>
                        <a href="/hr_management/creation/" class="block px-4 py-2 text-sm text-white rounded-lg">Templates</a>
                        <a href="/hr_management/attendance/" class="block px-4 py-2 text-sm text-white rounded-lg">Attendance</a>
                    </div>
                </div>

                <!-- Invoicing -->
                <div class="relative">
                    <button onclick="toggleDropdown(this)" class="flex items-center px-4 py-3 text-sm rounded-lg text-white hover:bg-[#6931D3] transition-all duration-200 w-full">
                        <svg class="h-5 w-5 min-w-[1.25rem]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span class="ml-3 sidebar-text">Invoicing</span>
                        <svg class="w-4 h-4 ml-auto transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="hidden mt-1 ml-8 space-y-1">
                        <a href="/invoicing/companies/" class="block px-4 py-2 text-sm text-white rounded-lg">Company</a>
                        <a href="/invoicing/create-invoice/" class="block px-4 py-2 text-sm text-white rounded-lg">Create Invoice</a>
                        <a href="/invoicing/reports/" class="block px-4 py-2 text-sm text-white rounded-lg">Reports</a>
                    </div>
                </div>

                <!-- Settings -->
                <div class="relative">
                    <a href="/product_card/" class="flex items-center px-4 py-3 text-sm rounded-lg text-white hover:bg-[#6931D3] transition-all duration-200">
                        <svg class="h-5 w-5 min-w-[1.25rem]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                        <span class="ml-3 sidebar-text">Product Card</span>
                    </a>
                </div>

                <script>
                    function toggleDropdown(button) {
                        const dropdown = button.nextElementSibling;
                        const arrow = button.querySelector('svg:last-child');
                        
                        if (dropdown.classList.contains('hidden')) {
                            dropdown.classList.remove('hidden');
                            arrow.style.transform = 'rotate(180deg)';
                            // Only add the active classes if they're not already applied
                            if (!button.classList.contains('bg-[#6931D3]')) {
                                button.classList.add('bg-[#6931D3]');
                            }
                        } else {
                            dropdown.classList.add('hidden');
                            arrow.style.transform = 'rotate(0deg)';
                            // Only remove background if not active page
                            if (!button.classList.contains('text-white')) {
                                button.classList.remove('bg-[#6931D3]');
                            }
                        }
                    }
                </script>

                <!-- Other existing sidebar navigation items can remain here with updated styling -->
                <!-- Just maintaining the rest as is with style updates -->
                <div class="relative">
                    <button onclick="toggleDropdown(this)" class="w-full flex items-center px-4 py-3 text-sm rounded-lg text-white hover:bg-[#6931D3] transition-all duration-200">
                        <svg class="h-5 w-5 min-w-[1.25rem]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                        </svg>
                        <span class="ml-3 sidebar-text">Website</span>
                        <svg class="h-4 w-4 ml-auto transform transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div class="hidden mt-1 ml-8 space-y-1">
                        <a href="{% url 'website_dashboard' %}" class="block px-4 py-2 text-sm text-white hover:text-white hover:bg-[#6931D3] rounded-lg">Dashboard</a>
                        <a href="{% url 'select_template' %}" class="block px-4 py-2 text-sm text-white hover:text-white hover:bg-[#6931D3] rounded-lg">Create Website</a>
                        <a href="{% url 'domain_settings' %}" class="block px-4 py-2 text-sm text-white hover:text-white hover:bg-[#6931D3] rounded-lg">Domain Settings</a>
                        {% if website and website.id %}
                            <a href="{% url 'manage_pages' website.id %}" class="block px-4 py-2 text-sm text-white hover:text-white hover:bg-[#6931D3] rounded-lg">Manage Pages</a>
                            <a href="{% url 'edit_website' website.id %}" class="block px-4 py-2 text-sm text-white hover:text-white hover:bg-[#6931D3] rounded-lg">Edit Website</a>
                            <a href="{% url 'preview_website' website.id %}" class="block px-4 py-2 text-sm text-white hover:text-white hover:bg-[#6931D3] rounded-lg">Preview Website</a>
                        {% endif %}
                    </div>
                </div>
                <a href="{% url 'data_miner' %}" class="flex items-center px-4 py-3 text-sm rounded-lg text-white hover:bg-[#6931D3] transition-all duration-200">
                    <svg class="h-5 w-5 min-w-[1.25rem]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                    </svg>
                    <span class="ml-3 sidebar-text">LeadX</span>
                </a>
                <a href="/trends/" class="flex items-center px-4 py-3 text-sm rounded-lg text-white hover:bg-[#6931D3] transition-all duration-200">
                    <svg class="h-5 w-5 min-w-[1.25rem]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <span class="ml-3 sidebar-text">TrendIQ</span>
                </a>
                <a href="/business_analytics/dashboard/" class="flex items-center px-4 py-3 text-sm rounded-lg text-white hover:bg-[#6931D3] transition-all duration-200">
                    <svg class="h-5 w-5 min-w-[1.25rem]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    <span class="ml-3 sidebar-text">Business Analytics</span>
                </a>
            </div>
        </nav>

        <!-- Add product and log out buttons at the bottom of sidebar -->
        <div class="absolute bottom-4 left-0 right-0 px-4">
            <a href="{% url 'logout' %}" class="flex items-center px-4 py-3 text-sm rounded-lg text-white hover:bg-[#6931D3] transition-all duration-200">
                <svg class="h-5 w-5 min-w-[1.25rem]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                <span class="ml-3 sidebar-text">Log out</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="main-transition flex-1 ml-0 md:ml-64 main-content-mobile">
        <!-- Top Navigation Bar -->
        <header class="bg-white shadow-sm">
            <div class="flex flex-wrap items-center justify-between p-2 md:p-4">
                <div class="flex items-center space-x-2 md:space-x-6">
                    <button id="toggleSidebar" class="text-gray-500 hover:text-gray-700" onclick="toggleSidebar()">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                    <div class="relative w-[18vw] h-[2.4rem] sm:w-[20vw] md:w-[18vw] lg:w-[18vw]" style="margin-left: 2.5rem;">
                        <div class="relative w-full h-full">
                            <input type="text" 
                                   id="searchInput"
                                   class="w-full h-full bg-white text-gray-800 text-sm sm:text-base rounded-full px-3 sm:px-4 py-2 border border-[#7B3DF3] focus:border-[#7B3DF3] focus:ring-2 focus:ring-[#7B3DF3]/20 focus:outline-none transition-all duration-200 ease-in-out" 
                                   placeholder="Enter 10 digit mobile number"
                                   pattern="[0-9]{10}"
                                   maxlength="10"
                                   onkeypress="return event.charCode >= 48 && event.charCode <= 57">
                            <button onclick="redirectToWhatsApp()" 
                                    class="absolute inset-y-0 right-0 flex items-center pr-3 text-[#7B3DF3] hover:text-[#6931D3] transition-colors duration-200 cursor-pointer">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-whatsapp" viewBox="0 0 16 16">
                                        <path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232"/>
                                      </svg>
                            </button>
                        </div>
                    </div>
                    <script>
                        function redirectToWhatsApp() {
                            const input = document.getElementById('searchInput');
                            const number = input.value.trim();
                            
                            if (number.length === 10 && /^\d{10}$/.test(number)) {
                                window.open(`https://wa.me/${number}`, '_blank');
                            } else {
                                alert('Please enter a valid 10-digit mobile number');
                            }
                        }

                        document.getElementById('searchInput').addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                redirectToWhatsApp();
                            }
                        });
                    </script>
                </div>
                <div class="flex items-center space-x-3 md:space-x-6 mt-2 sm:mt-0">
                    <!-- Buttons that match the image -->
                    <button class="text-[#7B3DF3]">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16l2.879-2.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242zM21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                    <button class="text-[#7B3DF3]">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                    </button>
                    <button class="text-[#7B3DF3]">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                    <div class="h-8 w-8 rounded-full bg-[#7B3DF3] flex items-center justify-center text-white">
                        <span>U</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1">
            {% url 'help_and_support' as help_url %}
            {% if request.path == help_url %}
                <div>
            {% else %}
                <div class="p-4 sm:p-5 md:p-2 mx-2 sm:mx-4 md:mx-[3.7rem] md:my-[1.1rem] responsive-padding-md">
                    <header class="text-start mb-4 md:mb-6">
                        <span class="text-[30px] sm:text-[40px] md:text-[50px] font-bold border-b-2 border-black montserrat-header">{{ app_name }}</span>
                        {% if request.path == '/user/dashboard/' %}
                            <div class="mt-2 text-[#030303] montserrat-header">Welcome, <span class="text-[#030303]">{{user.name}}</span></div>
                        {% endif %}
                    </header>
                    {% block content %}
                    <!-- Dashboard Main Section: Pixel-Perfect Screenshot Match -->
                    <div class="w-full sm:py-6 md:py-2 font-[Quicksand] mb-10">
                      
                      <!-- Top Counters -->
                      <div class="grid grid-cols-1 xs:grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-6 gap-3 sm:gap-5 mb-6 sm:mb-8 overflow-x-auto">
                        <div class="bg-white rounded-[20px] shadow-[0_4px_16px_0_rgba(123,61,243,0.07)] flex flex-col items-center py-3 sm:py-5 px-2 border border-[#F0EFFF] min-w-[120px]">
                          <div class="text-lg sm:text-xl md:text-2xl font-bold text-[#7B3DF3] leading-none" style="font-family: 'Montserrat', sans-serif;">0</div>
                          
                          <div class="text-xs text-[#232323] mt-1 font-semibold tracking-wide uppercase" style="font-family: 'Quicksand', sans-serif;">Listing Credit</div>
                        </div>
                        <div class="bg-white rounded-[20px] shadow-[0_4px_16px_0_rgba(123,61,243,0.07)] flex flex-col items-center py-3 sm:py-5 px-2 border border-[#F0EFFF] min-w-[120px]">
                          <div class="text-lg sm:text-xl md:text-2xl font-bold text-[#7B3DF3] leading-none" style="font-family: 'Montserrat', sans-serif;">0</div>
                          
                          <div class="text-xs text-[#232323] mt-1 font-semibold tracking-wide uppercase" style="font-family: 'Quicksand', sans-serif;">LeadX Credits</div>
                        </div>
                        <div class="bg-white rounded-[20px] shadow-[0_4px_16px_0_rgba(123,61,243,0.07)] flex flex-col items-center py-3 sm:py-5 px-2 border border-[#F0EFFF] min-w-[120px]">
                          <div class="text-lg sm:text-xl md:text-2xl font-bold text-[#7B3DF3] leading-none" style="font-family: 'Montserrat', sans-serif;">0</div>
                          
                          <div class="text-xs text-[#232323] mt-1 font-semibold tracking-wide uppercase" style="font-family: 'Quicksand', sans-serif;">TrendIQ Credit</div>
                        </div>
                        <div class="bg-white rounded-[20px] shadow-[0_4px_16px_0_rgba(123,61,243,0.07)] flex flex-col items-center py-3 sm:py-5 px-2 border border-[#F0EFFF] min-w-[120px]">
                          <div class="text-lg sm:text-xl md:text-2xl font-bold text-[#7B3DF3] leading-none" style="font-family: 'Montserrat', sans-serif;">0</div>
                          
                          <div class="text-xs text-[#232323] mt-1 font-semibold tracking-wide uppercase" style="font-family: 'Quicksand', sans-serif;">Website Enquiries</div>
                        </div>
                        <div class="bg-white rounded-[20px] shadow-[0_4px_16px_0_rgba(123,61,243,0.07)] flex flex-col items-center py-3 sm:py-5 px-2 border border-[#F0EFFF] min-w-[120px]">
                          <div class="text-lg sm:text-xl md:text-2xl font-bold text-[#7B3DF3] leading-none" style="font-family: 'Montserrat', sans-serif;">0</div>
                          
                          <div class="text-xs text-[#232323] mt-1 font-semibold tracking-wide uppercase" style="font-family: 'Quicksand', sans-serif;">Support Requests</div>
                        </div>
                        <div class="bg-white rounded-[20px] shadow-[0_4px_16px_0_rgba(123,61,243,0.07)] flex flex-col items-center py-3 sm:py-5 px-2 border border-[#F0EFFF] min-w-[120px]">
                          <div class="text-lg sm:text-xl md:text-2xl font-bold text-[#7B3DF3] leading-none" style="font-family: 'Montserrat', sans-serif;">0</div>
                          
                          <div class="text-xs text-[#232323] mt-1 font-semibold tracking-wide uppercase" style="font-family: 'Quicksand', sans-serif;">Case log</div>
                        </div>
                      </div>
                      <!-- Main Grid -->
                      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-7 md-grid-cols-2">
                        <!-- Sales Chart -->
                        <div class="bg-white rounded-[20px] shadow-[0_4px_16px_0_rgba(123,61,243,0.07)] p-4 sm:p-7 md-reduced-padding col-span-1 lg:col-span-2 flex flex-col border border-[#F0EFFF]">
                          <div class="font-bold text-base sm:text-lg text-[#232323] mb-3" style="font-family: 'Montserrat', sans-serif;">Sales</div>
                          <div class="w-full h-[200px] sm:h-[240px] md:h-[280px] md-chart-height relative">
                            <canvas id="salesChart" class="w-full h-full"></canvas>
                          </div>
                          <script>
                            document.addEventListener('DOMContentLoaded', function() {
                              if (window.salesChartInstance) window.salesChartInstance.destroy();
                              var ctx = document.getElementById('salesChart').getContext('2d');
                              window.salesChartInstance = new Chart(ctx, {
                                type: 'bar',
                                data: {
                                  labels: ['B2B Sales', 'B2C Sales', 'Sales', 'Cancellation Rate', 'Top Selling State', 'Low Selling City'],
                                  datasets: [{
                                    label: '',
                                    data: [5, 7, 2, 9, 10, 11, 12],
                                    backgroundColor: [
                                      '#A084E8', '#A084E8', '#E4D0FB', '#7B3DF3', '#A084E8', '#A084E8', '#E4D0FB'
                                    ],
                                    borderRadius: 8,
                                    barThickness: 32,
                                  }]
                                },
                                options: {
                                  responsive: true,
                                  maintainAspectRatio: false,
                                  plugins: { legend: { display: false } },
                                  scales: {
                                    x: {
                                      grid: { display: false },
                                      ticks: { color: '#232323', font: { family: 'Quicksand', weight: 'bold', size: 14 } }
                                    },
                                    y: {
                                      grid: { color: '#F3EFFF' },
                                      ticks: { color: '#A084E8', font: { family: 'Quicksand', size: 13 } },
                                      beginAtZero: true,
                                      suggestedMax: 10
                                    }
                                  }
                                }
                              });
                            });
                          </script>
                        </div>
                        <!-- Top Item Categories -->
                        <div class="bg-white rounded-[20px] shadow-[0_4px_16px_0_rgba(123,61,243,0.07)] p-4 sm:p-7 flex flex-col border border-[#F0EFFF]">
                          <div class="flex items-center justify-between mb-3">
                            <div class="font-bold text-base sm:text-lg text-[#232323]" style="font-family: 'Montserrat', sans-serif;">Quick Access</div>
                          </div>
                          <div class="grid grid-cols-3 gap-2 sm:gap-3 mt-2">
                            <div class="bg-[#E9D8FD] rounded-xl flex items-center justify-center h-12 sm:h-16 group relative cursor-pointer">
                                <svg class="w-5 h-5 sm:w-7 sm:h-7 text-[#7B3DF3] transition-opacity duration-300 group-hover:opacity-0" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                                </svg>
                                <span class="absolute inset-0 flex items-center justify-center text-[#7B3DF3] font-medium text-[15px] opacity-0 transition-opacity duration-300 group-hover:opacity-100">Website</span>
                            </div>
                            <div class="bg-[#E9D8FD] rounded-xl flex items-center justify-center h-12 sm:h-16 group relative cursor-pointer">
                                <svg class="w-5 h-5 sm:w-7 sm:h-7 text-[#7B3DF3] transition-opacity duration-300 group-hover:opacity-0" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2ZM16 18H8V16H16V18ZM16 14H8V12H16V14ZM13 9V3.5L18.5 9H13Z"/>
                                </svg>
                                <span class="absolute inset-0 flex items-center justify-center text-[#7B3DF3] font-medium text-[15px] opacity-0 transition-opacity duration-300 group-hover:opacity-100">Invoices</span>
                            </div>
                            <div class="bg-[#E9D8FD] rounded-xl flex items-center justify-center h-12 sm:h-16 group relative cursor-pointer">
                                <svg class="w-5 h-5 sm:w-7 sm:h-7 text-[#7B3DF3] transition-opacity duration-300 group-hover:opacity-0" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm-2 14l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>
                                </svg>
                                <span class="absolute inset-0 flex items-center justify-center text-[#7B3DF3] font-medium text-[15px] opacity-0 transition-opacity duration-300 group-hover:opacity-100">Attendance</span>
                            </div>
                            
                            <div class="bg-[#E9D8FD] rounded-xl flex items-center justify-center h-12 sm:h-16 group relative cursor-pointer" onclick="openReminderModal()">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-5 h-5 sm:w-7 sm:h-7 text-[#7B3DF3] transition-opacity duration-300 group-hover:opacity-0" viewBox="0 0 16 16">
                                    <path d="M6 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1H9v1.07a7.001 7.001 0 0 1 3.274 12.474l.601.602a.5.5 0 0 1-.707.708l-.746-.746A6.97 6.97 0 0 1 8 16a6.97 6.97 0 0 1-3.422-.892l-.746.746a.5.5 0 0 1-.707-.708l.602-.602A7.001 7.001 0 0 1 7 2.07V1h-.5A.5.5 0 0 1 6 .5m2.5 5a.5.5 0 0 0-1 0v3.362l-1.429 2.38a.5.5 0 1 0 .858.515l1.5-2.5A.5.5 0 0 0 8.5 9zM.86 5.387A2.5 2.5 0 1 1 4.387 1.86 8.04 8.04 0 0 0 .86 5.387M11.613 1.86a2.5 2.5 0 1 1 3.527 3.527 8.04 8.04 0 0 0-3.527-3.527"/>
                                </svg>
                                <span class="absolute inset-0 flex items-center justify-center text-[#7B3DF3] font-medium text-[14px] opacity-0 transition-opacity duration-300 group-hover:opacity-100">Reminders</span>
                            </div>
                            
                            <div class="bg-[#E9D8FD] rounded-xl flex items-center justify-center h-12 sm:h-16 group relative cursor-pointer" onclick="openQuickNotesModal()">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-5 h-5 sm:w-7 sm:h-7 text-[#7B3DF3] transition-opacity duration-300 group-hover:opacity-0" viewBox="0 0 16 16">
                                    <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.5.5 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11z"/>
                                </svg>
                                <span class="absolute inset-0 flex items-center justify-center text-[#7B3DF3] font-medium text-[14px] opacity-0 transition-opacity duration-300 group-hover:opacity-100">Quick Notes</span>
                            </div>
                            <div class="bg-[#E9D8FD] rounded-xl flex items-center justify-center h-12 sm:h-16 group relative cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-5 h-5 sm:w-7 sm:h-7 text-[#7B3DF3] transition-opacity duration-300 group-hover:opacity-0 text-center" viewBox="0 0 20 20">
                                    <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2m.995-14.901a1 1 0 1 0-1.99 0A5 5 0 0 0 3 6c0 1.098-.5 6-2 7h14c-1.5-1-2-5.902-2-7 0-2.42-1.72-4.44-4.005-4.901"/>
                                </svg>
                                <span class="absolute inset-0 flex items-center justify-center text-[#7B3DF3] font-medium text-[14px] opacity-0 transition-opacity duration-300 group-hover:opacity-100">Notifications</span>
                            </div>
                            <div class="bg-[#E9D8FD] rounded-xl flex items-center justify-center h-12 sm:h-16 group relative cursor-pointer" style="visibility: hidden;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-5 h-5 sm:w-7 sm:h-7 text-[#7B3DF3] transition-opacity duration-300 group-hover:opacity-0" viewBox="0 0 24 24">
                                    <path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/>
                                </svg>
                                <span class="absolute inset-0 flex items-center justify-center text-[#7B3DF3] font-medium text-[14px] opacity-0 transition-opacity duration-300 group-hover:opacity-100">Subscription</span>
                            </div>
                            <div class="bg-[#E9D8FD] rounded-xl flex items-center justify-center h-12 sm:h-16 group relative cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-5 h-5 sm:w-7 sm:h-7 text-[#7B3DF3] transition-opacity duration-300 group-hover:opacity-0" viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/>
                                </svg>
                                <span class="absolute inset-0 flex items-center justify-center text-[#7B3DF3] font-medium text-[14px] opacity-0 transition-opacity duration-300 group-hover:opacity-100">Subscription</span>
                            </div>
                          </div>
                        </div>
                        <div class="bg-white rounded-[20px] shadow-[0_4px_16px_0_rgba(123,61,243,0.07)] p-4 sm:p-7 flex flex-col border border-[#F0EFFF]">
                          <div class="flex items-center justify-between mb-3">
                              <div class="flex items-center gap-2">
                                  <h2 class="font-bold text-base sm:text-lg text-[#232323] whitespace-nowrap" style="font-family: 'Montserrat', sans-serif;">
                                      Business Analytics
                                  </h2>
                              </div>
                              <button 
                                  class="text-[#7B3DF3] px-3 py-1.5 rounded-lg text-sm font-medium flex items-center hover:bg-[#F0EFFF] transition-colors duration-200"
                                  style="font-family: 'Montserrat', sans-serif;"
                                  aria-label="Settings"
                                  onclick="openTagsModal()">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                  </svg>
                              </button>
                          </div>
                          <div class="flex flex-col items-center justify-center mt-2">
                            <div class="w-48 h-48 relative">
                              <canvas id="businessAnalyticsPieChart"></canvas>
                            </div>
                            <button onclick="window.location.href='/business_analytics/dashboard/?openUploadModal=true'" class="mt-6 px-6 py-2 bg-[#7B3DF3] text-white rounded-lg text-sm font-medium hover:bg-[#6931D3] transition-all duration-300 w-full sm:w-auto flex items-center justify-center gap-2 group relative overflow-hidden transform hover:scale-[1.02] active:scale-[0.98]">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform duration-300 group-hover:-translate-y-1 group-hover:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                </svg>
                                <span class="relative">
                                    <span class="transition-transform duration-300 inline-block group-hover:-translate-y-1 group-hover:translate-x-1">Upload</span>
                                    <span class="absolute bottom-0 left-0 w-full h-[2px] bg-white transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></span>
                                </span>
                                <div class="absolute inset-0 bg-white/10 transform -skew-x-12 -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
                            </button>
                            <p class="text-xs text-gray-800 mt-1">Upload your sales report here</p>
                          </div>

                          <script>
                            document.addEventListener('DOMContentLoaded', function() {
                              const ctx = document.getElementById('businessAnalyticsPieChart').getContext('2d');
                              
                              new Chart(ctx, {
                                type: 'pie',
                                data: {
                                  labels: [
                                    'Online Sales',
                                    'Offline Sales'
                                  ],
                                  datasets: [{
                                    data: [85000, 55000],
                                    backgroundColor: [
                                      '#7B3DF3',
                                      '#E9D8FD'
                                    ],
                                    borderWidth: 2,
                                    borderColor: '#ffffff',
                                    borderRadius: 5
                                  }]
                                },
                                options: {
                                  responsive: true,
                                  maintainAspectRatio: true,
                                  plugins: {
                                    legend: {
                                      display: true,
                                      position: 'bottom',
                                      labels: {
                                        font: {
                                          family: 'Montserrat',
                                          size: 12
                                        },
                                        padding: 20,
                                        usePointStyle: true,
                                        pointStyle: 'circle'
                                      }
                                    },
                                    tooltip: {
                                      backgroundColor: 'rgba(35, 35, 35, 0.9)',
                                      padding: 12,
                                      titleFont: {
                                        family: 'Montserrat',
                                        size: 14,
                                        weight: 'bold'
                                      },
                                      bodyFont: {
                                        family: 'Montserrat',
                                        size: 13
                                      },
                                      callbacks: {
                                        label: function(context) {
                                          const value = context.raw.toLocaleString('en-US', {
                                            style: 'currency',
                                            currency: 'USD',
                                            minimumFractionDigits: 0
                                          });
                                          const percentage = ((context.raw / context.dataset.data.reduce((a,b) => a+b)) * 100).toFixed(1);
                                          return `${context.label}: ${value} (${percentage}%)`;
                                        }
                                      }
                                    }
                                  },
                                  animation: {
                                    duration: 2000,
                                    easing: 'easeOutQuart'
                                  }
                                }
                              });
                            });
                          </script>
                        </div>
                        </div>
                        </div>
                        <!-- Stores List -->
                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 sm:gap-7">
                          <!-- Stores List -->
                          

                          <!-- Stock Numbers Section -->
                          <div class="bg-white rounded-[20px] shadow-[0_4px_16px_0_rgba(123,61,243,0.07)] p-4 sm:p-7 md-reduced-padding flex-1 border border-[#F0EFFF] lg:col-span-4">
                            <div class="flex items-center justify-between mb-3">
                              <div class="font-bold text-base sm:text-lg text-[#232323]" style="font-family: 'Montserrat', sans-serif;">Stock numbers</div>
                            </div>
                            <div class="space-y-4">
                              <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                  <span class="text-sm text-[#7B3DF3] font-semibold" style="font-family: 'Quicksand', sans-serif;">Out of stock</span>
                                  <svg class="h-4 w-4 text-[#7B3DF3]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                  </svg>
                                </div>
                                <div class="text-sm text-[#232323] font-bold" style="font-family: 'Montserrat', sans-serif;">12</div>
                              </div>
                              <div class="flex justify-between items-center">
                                <div class="text-sm text-[#7B3DF3] font-semibold" style="font-family: 'Quicksand', sans-serif;">Total Products</div>
                                <div class="text-sm text-[#232323] font-bold" style="font-family: 'Montserrat', sans-serif;">6</div>
                              </div>
                              <div class="flex justify-between items-center">
                                <div class="text-sm text-[#7B3DF3] font-semibold" style="font-family: 'Quicksand', sans-serif;">Categories</div>
                                <div class="text-sm text-[#232323] font-bold" style="font-family: 'Montserrat', sans-serif;">1</div>
                              </div>
                            </div>
                          </div>
                          <div class="bg-white rounded-[20px] shadow-[0_4px_16px_0_rgba(123,61,243,0.07)] p-4 sm:p-7 md-reduced-padding flex-1 border border-[#F0EFFF] lg:col-span-8">
                            <div class="flex items-center justify-between mb-3">
                              <div class="font-bold text-base sm:text-lg text-[#232323]" style="font-family: 'Montserrat', sans-serif;">Companies</div>
                              <a href="/hr_management/company/" class="text-xs text-[#7B3DF3] font-semibold" style="font-family: 'Montserrat', sans-serif;">VIEW ALL</a>
                            </div>
                            <div class="overflow-x-auto">
                              <table class="min-w-full text-xs sm:text-sm mt-2" style="font-family: 'Quicksand', sans-serif;">
                                <thead>
                                  <tr class="text-[#7B3DF3] text-left">
                                    <th class="font-semibold py-1 pr-2 sm:pr-4">Company Name</th>
                                    <th class="font-semibold py-1 pr-2 sm:pr-4">Location</th>
                                    <th class="font-semibold py-1 pr-2 sm:pr-4">GST Number</th>
                                    <th class="font-semibold py-1 pr-2 sm:pr-4">Employees</th>
                                  </tr>
                                </thead>
                                <tbody class="text-[#232323]">
                                  {% for company in companies %}
                                  <tr class="border-b last:border-0">
                                    <td class="py-1 pr-2 sm:pr-4">{{ company.name }}</td>
                                    <td class="py-1 pr-2 sm:pr-4">{{ company.location }}</td>
                                    <td class="py-1 pr-2 sm:pr-4">{{ company.gst_number }}</td>
                                    <td class="py-1 pr-2 sm:pr-4">{{ company.employee_count }} employees</td>
                                  </tr>
                                  {% endfor %}
                                  {% if not companies %}
                                  <tr>
                                    <td colspan="4" class="py-4 text-center text-gray-500">No companies found</td>
                                  </tr>
                                  {% endif %}
                                </tbody>
                              </table>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <!-- End Dashboard Main Section -->
                    {% endblock %}
                </div>
            {% endif %}
        </main>
    </div>

    <!-- Sidebar toggle script -->
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const mainContent = document.getElementById('main-content');
            const fullLogo = document.getElementById('fullLogo');
            const smallLogo = document.getElementById('smallLogo');
            const sidebarTexts = document.querySelectorAll('.sidebar-text');
            
            if (window.innerWidth <= 768) {
                // Mobile behavior
                sidebar.classList.toggle('open');
                overlay.classList.toggle('show');
                document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
            } else {
                // Desktop behavior
                const isCollapsed = sidebar.style.width === '64px';
                
                sidebar.style.width = isCollapsed ? '256px' : '64px';
                mainContent.style.marginLeft = isCollapsed ? '256px' : '64px';
                
                // Toggle logos with proper display
                if (isCollapsed) {
                    if (fullLogo) fullLogo.style.display = 'block';
                    if (smallLogo) smallLogo.style.display = 'none';
                    sidebarTexts.forEach(text => text.style.display = 'inline');
                } else {
                    if (fullLogo) fullLogo.style.display = 'none';
                    if (smallLogo) smallLogo.style.display = 'block';
                    sidebarTexts.forEach(text => text.style.display = 'none');
                }
            }
        }

        // Initialize sidebar state on page load
        document.addEventListener('DOMContentLoaded', () => {
            const fullLogo = document.getElementById('fullLogo');
            const smallLogo = document.getElementById('smallLogo');
            
            // Check for medium screens (1024x778 range)
            const isMediumScreen = window.innerWidth <= 1024 && window.innerWidth > 768;
            
            if (window.innerWidth <= 768) {
                const mainContent = document.getElementById('main-content');
                mainContent.style.marginLeft = '0';
                mainContent.classList.add('main-content-mobile');
            } else if (isMediumScreen) {
                // Medium screen optimizations
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.getElementById('main-content');
                
                if (sidebar) sidebar.style.width = '220px';
                if (mainContent) mainContent.style.marginLeft = '220px';
                
                // Adjust chart sizes for medium screens
                if (window.salesChartInstance) {
                    window.salesChartInstance.resize();
                }
                
                if (fullLogo) fullLogo.style.display = 'block';
                if (smallLogo) smallLogo.style.display = 'none';
            } else {
                if (fullLogo) fullLogo.style.display = 'block';
                if (smallLogo) smallLogo.style.display = 'none';
            }
            
            // Make sure charts are responsive
            window.addEventListener('resize', function() {
                if (window.salesChartInstance) {
                    window.salesChartInstance.resize();
                }
                
                // Handle screen size changes
                const isCurrentlyMediumScreen = window.innerWidth <= 1024 && window.innerWidth > 768;
                if (isCurrentlyMediumScreen) {
                    const sidebar = document.getElementById('sidebar');
                    const mainContent = document.getElementById('main-content');
                    
                    if (sidebar && !sidebar.classList.contains('open')) sidebar.style.width = '220px';
                    if (mainContent) mainContent.style.marginLeft = '220px';
                }
            });
        });
    </script>

    <!-- Tags Modal -->
    

    <script>
    function openTagsModal() {
      document.getElementById('tagsModal').classList.remove('hidden');
    }
    function closeTagsModal() {
      document.getElementById('tagsModal').classList.add('hidden');
    }
    // Optional: Close modal on background click
    document.getElementById('tagsModal').addEventListener('click', function(e) {
      if (e.target === this) closeTagsModal();
    });
    </script>
    
    <!-- Reminder Modals -->
    <!-- Main Reminder Modal -->
    <div id="reminderModal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black bg-opacity-50" onclick="closeReminderModal()"></div>
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm mx-4 relative z-10 overflow-hidden">
            <!-- Modal Header -->
            <div class="bg-[#7B3DF3] py-3 px-5 flex justify-between items-center">
                <h3 class="text-white text-base font-bold" id="reminderModalTitle">Reminders</h3>
                <button onclick="closeReminderModal()" class="text-white hover:text-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Modal Options -->
            <div id="reminderOptions" class="p-5 space-y-3">
                <button onclick="showCreateReminderForm()" class="w-full bg-[#7B3DF3] hover:bg-[#6931D3] text-white font-medium py-2.5 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    Create Reminder
                </button>
                <button onclick="showViewReminders()" class="w-full border border-[#7B3DF3] hover:bg-[#F0EFFF] text-[#7B3DF3] font-medium py-2.5 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    View Reminders
                </button>
            </div>
            
            <!-- Create Reminder Form (Hidden Initially) -->
            <div id="createReminderForm" class="p-5 hidden">
                <form id="reminderForm" class="space-y-3">
                    <div>
                        <label for="reminderTitle" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                        <input type="text" id="reminderTitle" name="title" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#7B3DF3] focus:border-[#7B3DF3] text-sm">
                    </div>
                    <div>
                        <label for="reminderDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="reminderDescription" name="description" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#7B3DF3] focus:border-[#7B3DF3] text-sm"></textarea>
                    </div>
                    <div>
                        <label for="reminderDate" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                        <input type="date" id="reminderDate" name="date" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#7B3DF3] focus:border-[#7B3DF3] text-sm">
                    </div>
                    <div>
                        <label for="reminderTime" class="block text-sm font-medium text-gray-700 mb-1">Time</label>
                        <div class="bg-gray-100 p-2 rounded-md mb-2 text-center">
                            <div id="currentTimeDisplay" class="text-gray-700 font-medium text-sm">Current time: </div>
                            <div class="text-xs text-gray-500" id="timezoneDisplay"></div>
                        </div>
                        <input type="time" id="reminderTime" name="time" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#7B3DF3] focus:border-[#7B3DF3] text-sm">
                    </div>
                    <div class="flex space-x-3 pt-2">
                        <button type="button" onclick="backToOptions()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition duration-200 text-sm">
                            Back
                        </button>
                        <button type="submit" class="flex-1 bg-[#7B3DF3] hover:bg-[#6931D3] text-white font-medium py-2 px-4 rounded-lg transition duration-200 text-sm">
                            Save
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- View Reminders List (Hidden Initially) -->
            <div id="viewReminders" class="hidden">
                <div class="p-4">
                    <div class="mb-3 flex justify-between items-center">
                        <h3 class="text-sm font-medium text-gray-700">Your Reminders</h3>
                        <span class="text-xs text-gray-500">Sorted by newest first</span>
                    </div>
                    <div id="remindersContainer" class="max-h-[50vh] overflow-y-auto pb-2">
                        <!-- Loading/no reminders message container -->
                        <div id="noRemindersMessage" class="text-center text-gray-500 py-4">
                            <div class="flex justify-center items-center py-4">
                                <svg class="animate-spin h-6 w-6 text-[#7B3DF3]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                            <p class="text-sm text-center">Loading reminders...</p>
                        </div>
                        
                        <!-- Reminders list container -->
                        <div id="remindersList" class="space-y-3 hidden"></div>
                    </div>
                </div>
                <div class="bg-gray-50 p-4 border-t">
                    <button type="button" onclick="backToOptions()" class="w-full bg-[#7B3DF3] hover:bg-[#6931D3] text-white font-medium py-2 px-4 rounded-lg transition duration-200 text-sm">
                        Back
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Reminder Notification Modal -->
    <div id="reminderNotificationModal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm mx-4 relative z-10 overflow-hidden">
            <!-- Modal Header -->
            <div class="bg-[#7B3DF3] py-3 px-5 flex justify-between items-center">
                <h3 class="text-white text-base font-bold">Reminder</h3>
                <div class="flex items-center">
                    <span id="reminderTime" class="text-white text-xs mr-2"></span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white animate-pulse" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                    </svg>
                    <button onclick="closeNotificationModal()" class="ml-3 text-white hover:text-gray-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Notification Content -->
            <div class="p-5">
                <h4 id="notificationTitle" class="text-lg font-bold text-gray-900 mb-2"></h4>
                <p id="notificationDescription" class="text-gray-700 mb-5 text-sm"></p>
                
                <input type="hidden" id="currentReminderId">
                
                <div class="flex space-x-3">
                    <button onclick="completeReminder()" class="flex-1 bg-[#7B3DF3] hover:bg-[#6931D3] text-white font-medium py-2 px-4 rounded-lg transition duration-200 text-sm">
                        Turn Off
                    </button>
                    <button onclick="showSnoozeOptions()" class="flex-1 border border-[#7B3DF3] hover:bg-[#F0EFFF] text-[#7B3DF3] font-medium py-2 px-4 rounded-lg transition duration-200 text-sm">
                        Remind Later
                    </button>
                </div>
                
                <div id="snoozeOptions" class="mt-4 hidden">
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Remind me in:</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="snoozeReminder(10)" class="bg-gray-100 hover:bg-gray-200 text-gray-800 text-xs py-2 px-3 rounded transition duration-200">
                                10 minutes
                            </button>
                            <button onclick="snoozeReminder(30)" class="bg-gray-100 hover:bg-gray-200 text-gray-800 text-xs py-2 px-3 rounded transition duration-200">
                                30 minutes
                            </button>
                            <button onclick="snoozeReminder(60)" class="bg-gray-100 hover:bg-gray-200 text-gray-800 text-xs py-2 px-3 rounded transition duration-200">
                                1 hour
                            </button>
                            <button onclick="snoozeReminder(1440)" class="bg-gray-100 hover:bg-gray-200 text-gray-800 text-xs py-2 px-3 rounded transition duration-200">
                                1 day
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Custom time:</label>
                        <div class="flex space-x-2">
                            <input type="datetime-local" id="customSnoozeTime" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#7B3DF3] focus:border-[#7B3DF3] text-sm">
                            <button onclick="snoozeReminderCustom()" class="bg-[#7B3DF3] hover:bg-[#6931D3] text-white font-medium py-2 px-3 rounded-lg transition duration-200 text-sm">
                                Set
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Audio for reminder notification -->
    <audio id="reminderSound" preload="auto" loop>
        <source src="/media/bell-notification-337658.mp3" type="audio/mpeg">
    </audio>
    
    <!-- Reminder JavaScript -->
    <script>
        // Reminder Modal Functions
        function openReminderModal() {
            document.getElementById('reminderModal').classList.remove('hidden');
            document.getElementById('reminderOptions').classList.remove('hidden');
            document.getElementById('createReminderForm').classList.add('hidden');
            document.getElementById('viewReminders').classList.add('hidden');
        }
        
        function closeReminderModal() {
            // Hide the modal
            document.getElementById('reminderModal').classList.add('hidden');
            
            // Reset internal state
            document.getElementById('reminderOptions').classList.remove('hidden');
            document.getElementById('createReminderForm').classList.add('hidden');
            document.getElementById('viewReminders').classList.add('hidden');
            
            // Stop the clock if running
            if (window.clockInterval) {
                clearInterval(window.clockInterval);
                window.clockInterval = null;
            }
            
            // Reset loading state
            isLoadingReminders = false;
        }
        
        function showCreateReminderForm() {
            document.getElementById('reminderOptions').classList.add('hidden');
            document.getElementById('createReminderForm').classList.remove('hidden');
            
            // Set default date to today
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('reminderDate').value = formattedDate;
            
            // Set default time to current time + 1 hour
            const hour = (today.getHours() + 1) % 24;
            const formattedTime = `${hour.toString().padStart(2, '0')}:${today.getMinutes().toString().padStart(2, '0')}`;
            document.getElementById('reminderTime').value = formattedTime;
            
            // Display the current time and update it every second
            updateCurrentTime();
            // Start the clock
            if (window.clockInterval) {
                clearInterval(window.clockInterval);
            }
            window.clockInterval = setInterval(updateCurrentTime, 1000);
            
            // Display timezone information
            displayTimezoneInfo();
        }
        
        function backToOptions() {
            document.getElementById('reminderOptions').classList.remove('hidden');
            document.getElementById('createReminderForm').classList.add('hidden');
            document.getElementById('viewReminders').classList.add('hidden');
            
            // Stop the clock when returning to options
            if (window.clockInterval) {
                clearInterval(window.clockInterval);
                window.clockInterval = null;
            }
        }
        
        // Function to update the current time display
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: true
            });
            document.getElementById('currentTimeDisplay').textContent = `Current time: ${timeString}`;
        }
        
        // Function to display timezone information
        function displayTimezoneInfo() {
            const timezoneDisplay = document.getElementById('timezoneDisplay');
            
            // Get timezone name if available
            let timezoneName = '';
            try {
                timezoneName = Intl.DateTimeFormat().resolvedOptions().timeZone;
            } catch (e) {
                console.error("Cannot get timezone name:", e);
            }
            
            // Get offset in hours:minutes format
            const now = new Date();
            const offsetMinutes = now.getTimezoneOffset();
            const offsetHours = Math.floor(Math.abs(offsetMinutes) / 60);
            const offsetMins = Math.abs(offsetMinutes) % 60;
            const offsetSign = offsetMinutes <= 0 ? '+' : '-';
            const offsetFormatted = `${offsetSign}${offsetHours.toString().padStart(2, '0')}:${offsetMins.toString().padStart(2, '0')}`;
            
            // Update the display
            timezoneDisplay.textContent = `Timezone: ${timezoneName || 'Unknown'} (UTC${offsetFormatted})`;
        }
        
        function showViewReminders() {
            console.log("showViewReminders called");
            
            // First make the view visible
            const reminderOptionsEl = document.getElementById('reminderOptions');
            const viewRemindersEl = document.getElementById('viewReminders');
            
            if (!reminderOptionsEl || !viewRemindersEl) {
                console.error('Required elements not found:', {
                    reminderOptions: !!reminderOptionsEl,
                    viewReminders: !!viewRemindersEl
                });
                return;
            }
            
            reminderOptionsEl.classList.add('hidden');
            viewRemindersEl.classList.remove('hidden');
            
            console.log('View switched to reminders view');
            
            // Get references to the list elements
            const remindersList = document.getElementById('remindersList');
            const noRemindersMessage = document.getElementById('noRemindersMessage');
            
            console.log("UI elements:", {
                remindersList: !!remindersList,
                noRemindersMessage: !!noRemindersMessage
            });
            
            if (remindersList && noRemindersMessage) {
                // Reset state
                remindersList.innerHTML = '';
                remindersList.classList.add('hidden');
                noRemindersMessage.classList.remove('hidden');
                
                // Load reminders
                loadReminders();
            } else {
                console.error('Required list elements not found');
            }
        }
        
        // Load Reminders
        let isLoadingReminders = false; // Flag to prevent multiple simultaneous calls
        
        function loadReminders() {
            // Prevent multiple simultaneous calls
            if (isLoadingReminders) {
                console.log('Already loading reminders, request ignored');
                return;
            }
            
            isLoadingReminders = true;
            console.log('loadReminders called, fetching data...');
            
            // Get references to elements
            const remindersList = document.getElementById('remindersList');
            const noRemindersMessage = document.getElementById('noRemindersMessage');
            
            if (!remindersList || !noRemindersMessage) {
                console.error('Could not find required elements:', { 
                    remindersList: !!remindersList, 
                    noRemindersMessage: !!noRemindersMessage 
                });
                isLoadingReminders = false;
                return;
            }
            
            // Clear previous content
            remindersList.innerHTML = '';
            
            // Show loading indicator
            noRemindersMessage.innerHTML = `
                <div class="flex justify-center items-center py-6">
                    <svg class="animate-spin h-6 w-6 text-[#7B3DF3]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <p class="text-sm text-center">Loading reminders...</p>
            `;
            noRemindersMessage.classList.remove('hidden');
            remindersList.classList.add('hidden');
            
            fetch('/user/api/reminders/list/')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                isLoadingReminders = false;
                console.log('API response:', data);
                
                if (data.success) {
                    if (!data.reminders || data.reminders.length === 0) {
                        // No reminders case
                        console.log('No reminders found');
                        
                        // Show no reminders message
                        noRemindersMessage.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto text-gray-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            <p class="text-sm">No reminders found. Create one to get started!</p>
                        `;
                        noRemindersMessage.classList.remove('hidden');
                        remindersList.classList.add('hidden');
                    } else {
                        // We have reminders
                        console.log(`Found ${data.reminders.length} reminders`);
                        
                        // Hide the no reminders message, show the reminders list
                        noRemindersMessage.classList.add('hidden');
                        remindersList.classList.remove('hidden');
                        
                        // Clear any previous content
                        remindersList.innerHTML = '';
                        
                        // Sort reminders by creation date (newest first)
                        data.reminders.sort((a, b) => {
                            // Use created_at for sorting, falling back to reminder_time if not available
                            const dateA = a.created_at ? new Date(a.created_at) : new Date(a.reminder_time);
                            const dateB = b.created_at ? new Date(b.created_at) : new Date(b.reminder_time);
                            return dateB - dateA; // Reverse order for newest first
                        });
                        
                        console.log('Sorted reminders (newest first):', data.reminders.map(r => r.created_at));
                        
                        // Add each reminder to the list
                        data.reminders.forEach(reminder => {
                            try {
                                // Parse the datetime and convert to local time
                                const reminderDate = new Date(reminder.reminder_time);
                                
                                // Format date and time in the user's local timezone
                                const formattedDate = reminderDate.toLocaleDateString([], {
                                    year: 'numeric',
                                    month: 'short',
                                    day: 'numeric'
                                });
                                
                                const formattedTime = reminderDate.toLocaleTimeString([], { 
                                    hour: '2-digit', 
                                    minute: '2-digit',
                                    hour12: true  // Use 12-hour format with AM/PM
                                });
                                
                                // Format creation date if available
                                let createdAtText = '';
                                if (reminder.created_at) {
                                    const createdDate = new Date(reminder.created_at);
                                    // If created today, show "Today at [time]", otherwise show date
                                    const today = new Date();
                                    if (createdDate.toDateString() === today.toDateString()) {
                                        createdAtText = `Created today at ${createdDate.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', hour12: true})}`;
                                    } else {
                                        createdAtText = `Created on ${createdDate.toLocaleDateString([], {month: 'short', day: 'numeric', year: 'numeric'})}`;
                                    }
                                }
                                
                                const reminderElement = document.createElement('div');
                                reminderElement.className = 'bg-white p-3 rounded-lg border border-gray-200 shadow-sm text-sm';
                                
                                let statusBadge = '';
                                if (reminder.status === 'completed') {
                                    statusBadge = '<span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-0.5 rounded-full ml-2">Completed</span>';
                                } else if (reminder.status === 'snoozed') {
                                    statusBadge = '<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-0.5 rounded-full ml-2">Snoozed</span>';
                                } else if (reminder.is_due) {
                                    statusBadge = '<span class="bg-red-100 text-red-800 text-xs font-medium px-2 py-0.5 rounded-full ml-2">Due</span>';
                                }
                                
                                reminderElement.innerHTML = `
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="font-semibold text-gray-900">${reminder.title} ${statusBadge}</h4>
                                            <p class="text-xs text-gray-600 mt-1">${reminder.description || 'No description'}</p>
                                            ${createdAtText ? `<p class="text-[10px] text-gray-400 mt-1">${createdAtText}</p>` : ''}
                                        </div>
                                        <div class="text-right">
                                            <p class="text-xs text-gray-500">${formattedDate}</p>
                                            <p class="text-xs font-semibold text-gray-700">${formattedTime}</p>
                                        </div>
                                    </div>
                                    <div class="flex justify-end space-x-2 mt-2">
                                        ${reminder.status !== 'completed' ? 
                                            `<button onclick="completeReminderFromList('${reminder.id}')" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-1 px-2 rounded transition duration-200">
                                                Mark Complete
                                            </button>` : ''
                                        }
                                    </div>
                                `;
                                
                                remindersList.appendChild(reminderElement);
                            } catch (err) {
                                console.error('Error processing reminder:', err, reminder);
                            }
                        });
                    }
                } else {
                    console.error('API returned error:', data.message);
                    
                    // Show error message
                    noRemindersMessage.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto text-red-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <p class="text-sm text-red-600">Error loading reminders: ${data.message}</p>
                    `;
                    noRemindersMessage.classList.remove('hidden');
                    remindersList.classList.add('hidden');
                }
            })
            .catch(error => {
                isLoadingReminders = false;
                console.error('Error:', error);
                
                // Show error message
                noRemindersMessage.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto text-red-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <p class="text-sm text-red-600">Failed to load reminders. Please try again.</p>
                `;
                noRemindersMessage.classList.remove('hidden');
                remindersList.classList.add('hidden');
            });
        }
        
        // Mark reminder as complete from the list view
        function completeReminderFromList(reminderId) {
            console.log(`Marking reminder ${reminderId} as complete`);
            
            if (confirm('Are you sure you want to mark this reminder as complete?')) {
                fetch(`/user/api/reminders/${reminderId}/complete/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Complete reminder response:', data);
                    if (data.success) {
                        // Reload reminders
                        loadReminders();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to update reminder. Please try again.');
                });
            }
        }
        
        // Notification Modal Functions
        function showReminderNotification(reminder) {
            const notificationModal = document.getElementById('reminderNotificationModal');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationDescription = document.getElementById('notificationDescription');
            const reminderTimeDisplay = document.getElementById('reminderTime');
            const currentReminderId = document.getElementById('currentReminderId');
            
            // Set reminder data
            notificationTitle.textContent = reminder.title;
            notificationDescription.textContent = reminder.description || 'No description provided';
            
            // Parse the datetime and ensure it's displayed in local time
            const reminderDate = new Date(reminder.reminder_time);
            console.log(`Reminder datetime from server: ${reminder.reminder_time}`);
            console.log(`Parsed as local time: ${reminderDate.toLocaleString()}`);
            
            // Format the time in the user's local timezone
            const formattedTime = reminderDate.toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true  // Use 12-hour format with AM/PM
            });
            
            // Debug timezone info
            const userTimezoneOffset = new Date().getTimezoneOffset();
            const offsetHours = Math.floor(Math.abs(userTimezoneOffset) / 60);
            const offsetMinutes = Math.abs(userTimezoneOffset) % 60;
            const offsetSign = userTimezoneOffset <= 0 ? '+' : '-';
            const userTimezone = `${offsetSign}${offsetHours.toString().padStart(2, '0')}:${offsetMinutes.toString().padStart(2, '0')}`;
            console.log(`User's current timezone offset: ${userTimezone}`);
            
            reminderTimeDisplay.textContent = formattedTime;
            
            currentReminderId.value = reminder.id;
            
            // Hide snooze options initially
            document.getElementById('snoozeOptions').classList.add('hidden');
            
            // Show the modal
            notificationModal.classList.remove('hidden');
            
            // Add a flashing effect to the notification modal to draw attention
            const modalContent = notificationModal.querySelector('.bg-white');
            modalContent.classList.add('reminder-flashing');
            
            // Play sound (continuous loop is enabled in the audio element)
            playReminderSound();
        }
        
        function completeReminder() {
            const reminderId = document.getElementById('currentReminderId').value;
            
            // Stop the sound first to provide immediate feedback
            stopReminderSound();
            
            fetch(`/user/api/reminders/${reminderId}/complete/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeNotificationModal();
                } else {
                    alert('Error: ' + data.message);
                    // Restart sound if there was an error
                    playReminderSound();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update reminder. Please try again.');
                // Restart sound if there was an error
                playReminderSound();
            });
        }
        
        function showSnoozeOptions() {
            // Don't stop the sound, continue playing while choosing snooze options
            document.getElementById('snoozeOptions').classList.remove('hidden');
        }
        
        function snoozeReminder(minutes) {
            const reminderId = document.getElementById('currentReminderId').value;
            
            // Stop the sound first to provide immediate feedback
            stopReminderSound();
            
            fetch(`/user/api/reminders/${reminderId}/snooze/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    snooze_minutes: minutes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeNotificationModal();
                } else {
                    alert('Error: ' + data.message);
                    // Restart sound if there was an error
                    playReminderSound();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to snooze reminder. Please try again.');
                // Restart sound if there was an error
                playReminderSound();
            });
        }
        
        function snoozeReminderCustom() {
            const reminderId = document.getElementById('currentReminderId').value;
            const customTime = document.getElementById('customSnoozeTime').value;
            
            if (!customTime) {
                alert('Please select a custom time');
                return;
            }
            
            // Stop the sound first to provide immediate feedback
            stopReminderSound();
            
            console.log('Custom snooze time selected:', customTime);
            
            // Add timezone information
            // Get the client's timezone offset in minutes
            const timezoneOffsetMinutes = new Date().getTimezoneOffset();
            // Convert offset to hours and minutes format (e.g., "+05:30" or "-08:00")
            const offsetHours = Math.floor(Math.abs(timezoneOffsetMinutes) / 60);
            const offsetMinutes = Math.abs(timezoneOffsetMinutes) % 60;
            const offsetSign = timezoneOffsetMinutes <= 0 ? '+' : '-'; // Note: getTimezoneOffset returns negative for positive timezone
            const timezoneOffset = `${offsetSign}${offsetHours.toString().padStart(2, '0')}:${offsetMinutes.toString().padStart(2, '0')}`;
            console.log('User timezone offset:', timezoneOffset);
            
            // Get the user's timezone name if available
            let userTimezoneName = '';
            try {
                userTimezoneName = Intl.DateTimeFormat().resolvedOptions().timeZone;
                console.log('User timezone:', userTimezoneName);
            } catch (e) {
                console.error("Cannot get timezone name:", e);
            }
            
            // Add timezone information to the datetime string
            const customTimeWithTZ = `${customTime}${timezoneOffset}`;
            console.log('Custom snooze time with timezone:', customTimeWithTZ);
            
            // For verification, show what this time would be displayed as
            const testDate = new Date(customTime);
            console.log('This time will be displayed as:', testDate.toLocaleString());
            
            fetch(`/user/api/reminders/${reminderId}/snooze/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    snooze_datetime: customTimeWithTZ,
                    timezone_name: userTimezoneName
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    closeNotificationModal();
                } else {
                    alert('Error: ' + data.message);
                    // Restart sound if there was an error
                    playReminderSound();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to snooze reminder. Please try again.');
                // Restart sound if there was an error
                playReminderSound();
            });
        }
        
        function closeNotificationModal() {
            // Stop the sound
            stopReminderSound();
            
            // Remove the flashing effect
            const notificationModal = document.getElementById('reminderNotificationModal');
            const modalContent = notificationModal.querySelector('.bg-white');
            if (modalContent) {
                modalContent.classList.remove('reminder-flashing');
            }
            
            // Hide the modal
            notificationModal.classList.add('hidden');
        }
        
        // Sound Functions
        function playReminderSound() {
            const sound = document.getElementById('reminderSound');
            if (sound) {
                // Make sure volume is at a good level
                sound.volume = 0.7;
                sound.currentTime = 0;
                
                // We're using the loop attribute, so playing once will continue
                // until stopReminderSound is called
                sound.play().catch(err => {
                    console.error('Error playing sound:', err);
                    // Many browsers require user interaction before audio can play
                    // In that case, we'll try to play without loop as a fallback
                    sound.loop = false;
                    sound.play().catch(e => console.error('Could not play sound even without loop:', e));
                });
            }
        }
        
        function stopReminderSound() {
            const sound = document.getElementById('reminderSound');
            if (sound) {
                sound.pause();
                sound.currentTime = 0;
                // Ensure loop is turned back on for next time
                sound.loop = true;
            }
        }
        
        // Helper function to get CSRF token
        function getCsrfToken() {
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
                
            return cookieValue || '';
        }
        
        // Add a better way to get the CSRF token
        function getCSRFToken() {
            // Try to get it from a meta tag first (most reliable)
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            if (csrfToken) {
                return csrfToken;
            }
            
            // Or try to get it from the cookie
            return getCsrfToken();
        }
        
        // Check for due reminders periodically
        function checkDueReminders() {
            fetch('/user/api/reminders/check/')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.has_due_reminders) {
                    // Show notification for the first due reminder
                    showReminderNotification(data.due_reminders[0]);
                }
            })
            .catch(error => {
                console.error('Error checking reminders:', error);
            });
        }
        
        // Set up reminder checking interval (every minute)
        document.addEventListener('DOMContentLoaded', function() {
            setInterval(checkDueReminders, 60000);
            
            // Also check on page load after a few seconds
            setTimeout(checkDueReminders, 5000);
        });

        // Reminder Creation
        document.addEventListener('DOMContentLoaded', function() {
            const reminderForm = document.getElementById('reminderForm');
            if (reminderForm) {
                reminderForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const title = document.getElementById('reminderTitle').value;
                    const description = document.getElementById('reminderDescription').value;
                    const date = document.getElementById('reminderDate').value;
                    const time = document.getElementById('reminderTime').value;
                    
                    if (!title || !date || !time) {
                        alert('Please fill in all required fields');
                        return;
                    }
                    
                    // Create a local Date object in the user's timezone
                    const localDateTime = new Date(`${date}T${time}`);
                    console.log('User selected time (local):', localDateTime.toLocaleString());
                    
                    // Get the user's timezone information
                    let userTimezoneName = '';
                    try {
                        userTimezoneName = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    } catch (e) {
                        console.error("Cannot get timezone name:", e);
                    }
                    
                    // Get timezone offset in standard format
                    const timezoneOffsetMinutes = localDateTime.getTimezoneOffset();
                    const offsetHours = Math.floor(Math.abs(timezoneOffsetMinutes) / 60);
                    const offsetMinutes = Math.abs(timezoneOffsetMinutes) % 60;
                    const offsetSign = timezoneOffsetMinutes <= 0 ? '+' : '-';
                    const timezoneOffset = `${offsetSign}${offsetHours.toString().padStart(2, '0')}:${offsetMinutes.toString().padStart(2, '0')}`;
                    
                    console.log('User timezone:', userTimezoneName);
                    console.log('User timezone offset:', timezoneOffset);
                    
                    // Format the datetime string with timezone info
                    // This is the EXACT time in the user's local timezone
                    const isoDateTimeStr = localDateTime.toISOString();
                    const dateTimeWithTZ = `${date}T${time}${timezoneOffset}`;
                    
                    console.log('ISO format (converted to UTC):', isoDateTimeStr);
                    console.log('Local time with explicit offset:', dateTimeWithTZ);
                    
                    // We'll send the datetime with explicit timezone offset to ensure
                    // the server preserves the exact time the user selected
                    
                    // Get CSRF token
                    const csrfToken = getCSRFToken();
                    console.log('CSRF Token:', csrfToken ? 'Found' : 'Not found');
                    
                    // Prepare data
                    const reminderData = {
                        title: title,
                        description: description,
                        reminder_time: dateTimeWithTZ, // Use the timezone-aware format
                        timezone_name: userTimezoneName // Include the timezone name for reference
                    };
                    console.log('Creating reminder with data:', reminderData);
                    
                    // Send the data to the server
                    fetch('/user/api/reminders/create/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify(reminderData),
                        credentials: 'same-origin'
                    })
                    .then(response => {
                        console.log('Response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Response data:', data);
                        if (data.success) {
                            // Reset form
                            document.getElementById('reminderForm').reset();
                            
                            // Show success message
                            alert('Reminder created successfully!');
                            
                            // If the view reminders section is visible, refresh the list
                            if (!document.getElementById('viewReminders').classList.contains('hidden')) {
                                loadReminders();
                            }
                            
                            // Return to options
                            backToOptions();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error creating reminder:', error);
                        alert('Failed to create reminder. Please try again. Error: ' + error.message);
                    });
                });
            }
        });
    </script>

    <!-- Quick Notes Modal -->
    <div id="quickNotesModal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black bg-opacity-50" onclick="closeQuickNotesModal()"></div>
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm mx-4 relative z-10 overflow-hidden">
            <!-- Modal Header -->
            <div class="bg-[#7B3DF3] py-3 px-5 flex justify-between items-center">
                <h3 class="text-white text-base font-bold" id="quickNotesModalTitle">Quick Notes</h3>
                <button onclick="closeQuickNotesModal()" class="text-white hover:text-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Modal Options -->
            <div id="quickNotesOptions" class="p-5 space-y-3">
                <button onclick="showCreateNoteForm()" class="w-full bg-[#7B3DF3] hover:bg-[#6931D3] text-white font-medium py-2.5 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    Create Note
                </button>
                <button onclick="showViewNotes()" class="w-full border border-[#7B3DF3] hover:bg-[#F0EFFF] text-[#7B3DF3] font-medium py-2.5 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    View Notes
                </button>
            </div>
            
            <!-- Create Note Form (Hidden Initially) -->
            <div id="createNoteForm" class="p-5 hidden">
                <form id="noteForm" class="space-y-4">
                    <div>
                        <label for="noteTitle" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                        <input type="text" id="noteTitle" name="title" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#7B3DF3] focus:border-[#7B3DF3] text-sm">
                    </div>
                    <div>
                        <label for="noteDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="noteDescription" name="description" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#7B3DF3] focus:border-[#7B3DF3] text-sm"></textarea>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="pinNote" name="pinned" class="h-4 w-4 text-[#7B3DF3] focus:ring-[#7B3DF3] border-gray-300 rounded">
                        <label for="pinNote" class="ml-2 block text-sm text-gray-700">Pin this note</label>
                    </div>
                    <div class="flex space-x-3 pt-2">
                        <button type="button" onclick="backToNotesOptions()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition duration-200 text-sm">
                            Back
                        </button>
                        <button type="submit" class="flex-1 bg-[#7B3DF3] hover:bg-[#6931D3] text-white font-medium py-2 px-4 rounded-lg transition duration-200 text-sm">
                            Save
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- View Notes List (Hidden Initially) -->
            <div id="viewNotes" class="hidden">
                <div class="p-4">
                    <div class="mb-3 flex justify-between items-center">
                        <h3 class="text-sm font-medium text-gray-700">Your Notes</h3>
                        <span class="text-xs text-gray-500">Sorted by newest first</span>
                    </div>
                    <div id="notesContainer" class="max-h-[50vh] overflow-y-auto pb-2">
                        <!-- Loading/no notes message container -->
                        <div id="noNotesMessage" class="text-center text-gray-500 py-4">
                            <div class="flex justify-center items-center py-4">
                                <svg class="animate-spin h-6 w-6 text-[#7B3DF3]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                            <p class="text-sm text-center">Loading notes...</p>
                        </div>
                        
                        <!-- Notes list container -->
                        <div id="notesList" class="space-y-3 hidden"></div>
                    </div>
                </div>
                <div class="bg-gray-50 p-4 border-t">
                    <button type="button" onclick="backToNotesOptions()" class="w-full bg-[#7B3DF3] hover:bg-[#6931D3] text-white font-medium py-2 px-4 rounded-lg transition duration-200 text-sm">
                        Back
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pinned Notes Container (Fixed to the right side) -->
    <div id="pinnedNotesContainer" class="fixed right-4 top-1/4 z-40 space-y-2 w-12 flex flex-col items-center">
        <!-- Pinned notes will be added here dynamically -->
    </div>

    <!-- Quick Notes JavaScript -->
    <script>
        // Notes Modal Functions
        function openQuickNotesModal() {
            document.getElementById('quickNotesModal').classList.remove('hidden');
            document.getElementById('quickNotesOptions').classList.remove('hidden');
            document.getElementById('createNoteForm').classList.add('hidden');
            document.getElementById('viewNotes').classList.add('hidden');
        }
        
        function closeQuickNotesModal() {
            document.getElementById('quickNotesModal').classList.add('hidden');
            
            // Reset internal state
            document.getElementById('quickNotesOptions').classList.remove('hidden');
            document.getElementById('createNoteForm').classList.add('hidden');
            document.getElementById('viewNotes').classList.add('hidden');
        }
        
        function showCreateNoteForm() {
            document.getElementById('quickNotesOptions').classList.add('hidden');
            document.getElementById('createNoteForm').classList.remove('hidden');
            
            // Reset form
            document.getElementById('noteForm').reset();
        }
        
        function backToNotesOptions() {
            document.getElementById('quickNotesOptions').classList.remove('hidden');
            document.getElementById('createNoteForm').classList.add('hidden');
            document.getElementById('viewNotes').classList.add('hidden');
        }
        
        function showViewNotes() {
            document.getElementById('quickNotesOptions').classList.add('hidden');
            document.getElementById('viewNotes').classList.remove('hidden');
            
            // Load notes
            loadNotes();
        }
        
        // Variables to store notes
        let notes = [];
        let isLoadingNotes = false;
        
        // Helper function to get CSRF token
        function getQuickNotesCsrfToken() {
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
                
            return cookieValue || document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
        }
        
        // Load Notes from API
        function loadNotes() {
            if (isLoadingNotes) return;
            
            isLoadingNotes = true;
            
            const notesList = document.getElementById('notesList');
            const noNotesMessage = document.getElementById('noNotesMessage');
            
            // Clear previous content and show loading
            notesList.innerHTML = '';
            notesList.classList.add('hidden');
            noNotesMessage.classList.remove('hidden');
            noNotesMessage.innerHTML = `
                <div class="flex justify-center items-center py-4">
                    <svg class="animate-spin h-6 w-6 text-[#7B3DF3]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <p class="text-sm text-center">Loading notes...</p>
            `;
            
            // Fetch notes from API
            fetch('/user/api/quick-notes/list/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    isLoadingNotes = false;
                    
                    if (data.success) {
                        notes = data.notes || [];
                        
                        if (notes.length === 0) {
                            // No notes case
                            noNotesMessage.innerHTML = `
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto text-gray-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                <p class="text-sm">No notes found. Create one to get started!</p>
                            `;
                            noNotesMessage.classList.remove('hidden');
                            notesList.classList.add('hidden');
                        } else {
                            // We have notes
                            noNotesMessage.classList.add('hidden');
                            notesList.classList.remove('hidden');
                            
                            // Display each note
                            notes.forEach((note, index) => {
                                const noteElement = document.createElement('div');
                                noteElement.className = 'bg-white p-3 rounded-lg border border-gray-200 shadow-sm text-sm';
                                
                                // Format date
                                const createdDate = new Date(note.created_at);
                                const formattedDate = createdDate.toLocaleDateString();
                                
                                noteElement.innerHTML = `
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1 pr-3">
                                            <h4 class="font-semibold text-gray-900">${note.title}</h4>
                                            <p class="text-xs text-gray-600 mt-1">${note.description || 'No description'}</p>
                                            <p class="text-[10px] text-gray-400 mt-1">Created on ${formattedDate}</p>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="toggleNotePin('${note.id}')" class="text-${note.pinned ? '[#7B3DF3]' : 'gray-400'} hover:text-[#7B3DF3] transition-colors">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="${note.pinned ? 'currentColor' : 'none'}" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                                                </svg>
                                            </button>
                                            <button onclick="deleteNote('${note.id}')" class="text-red-400 hover:text-red-600 transition-colors">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                `;
                                
                                notesList.appendChild(noteElement);
                            });
                        }
                    } else {
                        console.error('API returned error:', data.message);
                        noNotesMessage.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto text-red-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <p class="text-sm text-red-600">Error loading notes: ${data.message}</p>
                        `;
                    }
                })
                .catch(error => {
                    isLoadingNotes = false;
                    console.error('Error:', error);
                    
                    noNotesMessage.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto text-red-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <p class="text-sm text-red-600">Failed to load notes. Please try again.</p>
                    `;
                });
        }
        
        // Create a new note via API
        function createNote(title, description, pinned = false) {
            const noteData = {
                title,
                description,
                pinned
            };
            
            fetch('/user/api/quick-notes/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getQuickNotesCsrfToken()
                },
                body: JSON.stringify(noteData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // If the note is pinned, add it to the pinned notes container
                    if (pinned) {
                        addPinnedNoteToUI(data.note);
                    }
                    
                    // Show success message
                    alert('Note created successfully!');
                    
                    // Go back to options
                    backToNotesOptions();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error creating note:', error);
                alert('Failed to create note. Please try again.');
            });
        }
        
        // Toggle pin status via API
        function toggleNotePin(noteId) {
            fetch(`/user/api/quick-notes/${noteId}/toggle-pin/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getQuickNotesCsrfToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Find the note in our array
                    const noteIndex = notes.findIndex(n => n.id === noteId);
                    if (noteIndex !== -1) {
                        // Update the pinned status
                        notes[noteIndex].pinned = data.is_pinned;
                        
                        // Update the UI
                        if (data.is_pinned) {
                            addPinnedNoteToUI(notes[noteIndex]);
                        } else {
                            removePinnedNoteFromUI(noteId);
                        }
                        
                        // Refresh the notes list if visible
                        if (!document.getElementById('viewNotes').classList.contains('hidden')) {
                            loadNotes();
                        }
                    }
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error toggling pin:', error);
                alert('Failed to update note. Please try again.');
            });
        }
        
        // Delete a note via API
        function deleteNote(noteId) {
            if (confirm('Are you sure you want to delete this note?')) {
                fetch(`/user/api/quick-notes/${noteId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getQuickNotesCsrfToken()
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Find the note in our array
                        const noteIndex = notes.findIndex(n => n.id === noteId);
                        if (noteIndex !== -1) {
                            const wasPinned = notes[noteIndex].pinned;
                            
                            // Remove from array
                            notes.splice(noteIndex, 1);
                            
                            // If the note was pinned, remove it from the pinned container
                            if (wasPinned) {
                                removePinnedNoteFromUI(noteId);
                            }
                            
                            // Refresh the notes list
                            loadNotes();
                        }
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error deleting note:', error);
                    alert('Failed to delete note. Please try again.');
                });
            }
        }
        
        // Add a pinned note to the UI
        function addPinnedNoteToUI(note) {
            const pinnedContainer = document.getElementById('pinnedNotesContainer');
            
            // Remove existing note if it's already pinned (to avoid duplicates)
            removePinnedNoteFromUI(note.id);
            
            // Create the pinned note element
            const pinnedNote = document.createElement('div');
            pinnedNote.id = `pinned-note-${note.id}`;
            pinnedNote.className = 'bg-white rounded-full shadow-lg w-10 h-10 flex items-center justify-center cursor-pointer transform hover:scale-110 transition-transform duration-200 relative group';
            pinnedNote.setAttribute('data-note-id', note.id);
            pinnedNote.setAttribute('title', note.title);
            
            // Add note content
            pinnedNote.innerHTML = `
                <div class="absolute opacity-0 group-hover:opacity-100 bottom-full right-0 mb-2 w-48 bg-white rounded-md shadow-lg p-2 transform transition-opacity duration-200 text-left z-50 border border-gray-200">
                    <h4 class="font-semibold text-gray-900 text-sm">${note.title}</h4>
                    <p class="text-xs text-gray-600 mt-1 line-clamp-3">${note.description || 'No description'}</p>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[#7B3DF3]" fill="currentColor" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                </svg>
            `;
            
            // Add click handler to unpin
            pinnedNote.addEventListener('click', function() {
                toggleNotePin(note.id);
            });
            
            // Add to the container
            pinnedContainer.appendChild(pinnedNote);
        }
        
        // Remove a pinned note from the UI
        function removePinnedNoteFromUI(noteId) {
            const pinnedNote = document.getElementById(`pinned-note-${noteId}`);
            if (pinnedNote) {
                pinnedNote.remove();
            }
        }
        
        // Load pinned notes on page load
        function loadPinnedNotes() {
            fetch('/user/api/quick-notes/list/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        notes = data.notes || [];
                        
                        // Add all pinned notes to the UI
                        notes.filter(note => note.pinned).forEach(note => {
                            addPinnedNoteToUI(note);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading pinned notes:', error);
                });
        }
        
        // Initialize everything when the document is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Setup note form submission
            const noteForm = document.getElementById('noteForm');
            if (noteForm) {
                noteForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const title = document.getElementById('noteTitle').value.trim();
                    const description = document.getElementById('noteDescription').value.trim();
                    const pinned = document.getElementById('pinNote').checked;
                    
                    if (!title) {
                        alert('Please enter a title for your note');
                        return;
                    }
                    
                    // Create the note
                    createNote(title, description, pinned);
                });
            }
            
            // Load pinned notes
            loadPinnedNotes();
            
            // Add click handler to the Quick Notes button in the grid
            const quickNotesButton = document.querySelector('.grid-cols-3 .group:nth-child(5)');
            if (quickNotesButton) {
                quickNotesButton.addEventListener('click', openQuickNotesModal);
            }
        });
    </script>
</body>
</html>