{% extends 'user_dashboard/base.html' %}
{% load static %}

{% block title %}{{ keyword|default:"Google" }} Search Trends in India (2020-2025){% endblock %}

{% block extra_head %}
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- JSON repair utilities - load this early to enhance JSON parsing -->
<script src="{% static 'js/json-repair.js' %}"></script>

<!-- Chart.js - Latest version -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- ApexCharts - For more attractive charts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.1/dist/apexcharts.min.js"></script>

<!-- Moment.js for date handling -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

<!-- Chart.js adapter for Moment -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>

<!-- Chart.js annotation plugin -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

<!-- Chart.js Zoom plugin for interactivity -->
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

<!-- Luxon for better date handling -->
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>

<!-- D3.js for advanced visualizations -->
<script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js"></script>

<!-- Custom styles for the loading indicator -->
<style>
    /* Loading indicator styles */
    #inlineLoader {
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.85);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        padding: 2rem;
    }

    /* When body has loading class, ensure loader is visible */
    body.loading #inlineLoader {
        display: flex;
        opacity: 1;
    }

    /* Spinner animation */
    .loader-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Loader step animation */
    .step-text {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { opacity: 0.7; }
        50% { opacity: 1; }
        100% { opacity: 0.7; }
    }

    /* Hide chart containers initially until data is loaded */
    .chart-container {
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
    }

    .chart-container.loaded {
        opacity: 1;
    }
    
    /* Enhanced chart styling */
    .chart-container {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border-radius: 0.5rem;
        background: linear-gradient(to bottom right, #f9fafb, #ffffff);
        border: 1px solid rgba(0, 0, 0, 0.05);
        padding: 1rem;
        transition: all 0.3s ease-in-out;
    }
    
    .chart-container:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }
    
    /* Button styling */
    .chart-control-btn {
        transition: all 0.2s ease-in-out;
        border-radius: 0.375rem;
        padding: 0.5rem 1rem;
        border: 1px solid rgba(0, 0, 0, 0.1);
        background-color: white;
    }
    
    .chart-control-btn:hover {
        transform: translateY(-1px);
        border-color: #27FFB4;
        background-color: rgba(39, 255, 180, 0.1);
    }
    
    .chart-control-btn.active {
        background-color: rgba(39, 255, 180, 0.2);
        border-color: #27FFB4;
        color: #065f46;
    }
    
    /* Panel styling */
    .trends-panel {
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transition: box-shadow 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .trends-panel:hover {
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    }
    
    /* Time unit button styling */
    .time-unit-btn {
        transition: all 0.2s ease-in-out;
    }
    
    .time-unit-btn:hover {
        transform: translateY(-1px);
        background-color: rgba(39, 255, 180, 0.2);
        border-color: #27FFB4;
    }
    
    .time-unit-btn.active {
        background-color: rgba(39, 255, 180, 0.2);
        border-color: #27FFB4;
    }
</style>

<!-- Ensure Chart.js and trends-charts.js are loaded properly -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, checking dependencies...');
        
        // Check if Chart.js is loaded
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded! Attempting to load it now...');
            
            // Load Chart.js dynamically
            const chartScript = document.createElement('script');
            chartScript.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
            chartScript.onload = function() {
                console.log('Chart.js loaded successfully');
                
                // Load trends-charts.js after Chart.js loads
                loadTrendsChartsJs();
            };
            
            document.head.appendChild(chartScript);
        } else {
            // Chart.js is already loaded, load trends-charts.js
            loadTrendsChartsJs();
        }
        
        function loadTrendsChartsJs() {
            // Only load trends-charts.js if it's not already loaded
            if (typeof window.renderCharts !== 'function') {
                console.log('Loading trends-charts.js...');
                const trendsScript = document.createElement('script');
                trendsScript.src = "{% static 'js/trends-charts.js' %}";
                trendsScript.onload = function() {
                    console.log('trends-charts.js loaded successfully');
                    
                    // Make renderCharts globally available in case it's not already
                    if (typeof window.renderCharts !== 'function' && 
                        typeof renderCharts === 'function') {
                        window.renderCharts = renderCharts;
                    }
                    
                    // If auto-fetch is enabled, trigger it after script loads
                    const container = document.querySelector('[data-auto-fetch="true"]');
                    const keyword = document.querySelector('#keywordInput')?.value;
                    if (container && keyword && typeof fetchTrendsData === 'function') {
                        console.log('Auto-fetching for keyword:', keyword);
                        const analysisOption = document.getElementById('analysisOption')?.value || '1';
                        fetchTrendsData(keyword, analysisOption);
                    } else if (window.shouldAutoFetch && window.initialKeyword) {
                        console.log('Auto-fetching via shouldAutoFetch flag for keyword:', window.initialKeyword);
                        const analysisOption = document.getElementById('analysisOption')?.value || '1';
                        fetchTrendsData(window.initialKeyword, analysisOption);
                    }
                };
                
                // Add error handling for script loading
                trendsScript.onerror = function() {
                    console.error('Failed to load trends-charts.js');
                };
                
                document.head.appendChild(trendsScript);
            } else {
                console.log('trends-charts.js is already loaded');
                // Even if already loaded, check if we need to auto-fetch
                if (window.shouldAutoFetch && window.initialKeyword) {
                    console.log('Auto-fetching via shouldAutoFetch flag for keyword:', window.initialKeyword);
                    const analysisOption = document.getElementById('analysisOption')?.value || '1';
                    fetchTrendsData(window.initialKeyword, analysisOption);
                }
            }
        }
        
        // Check if trends-charts.js functionality is loaded after a delay
        setTimeout(function() {
            if (typeof window.renderCharts !== 'function') {
                console.error('renderCharts function not found after timeout. Retrying...');
                loadTrendsChartsJs();
            }
        }, 2000);
    });
</script>

<!-- Remove the duplicate static script tag since we're loading it dynamically -->
<!-- <script src="{% static 'js/trends-charts.js' %}"></script> -->
<script src="{% static 'js/chart-controls.js' %}"></script>
<script>
    // Pass variables from Django to JavaScript
    window.googleApiConfigured = {{ google_api_configured|lower }};
    window.searchedFlag = {{ searched|lower }};
    window.shouldAutoFetch = {{ should_auto_fetch|lower }};
    window.initialKeyword = "{{ keyword }}";
    
    // Debug info
    console.log('Django context variables:');
    console.log('- googleApiConfigured:', {{ google_api_configured|lower }});
    console.log('- searchedFlag:', {{ searched|lower }});
    console.log('- shouldAutoFetch:', {{ should_auto_fetch|lower }});
    console.log('- initialKeyword:', "{{ keyword }}");
    
    // Set a flag to indicate this page was just loaded (for auto-fetch detection)
    window.justLoaded = true;
    
    // Add a class to the body if we should auto-fetch
    if ({{ should_auto_fetch|lower }}) {
        document.body.classList.add('should-auto-fetch');
    }
</script>

<!-- Global error handler for JSON parsing and other critical errors -->
<script>
    // Set up global error handler
    window.addEventListener('error', function(event) {
        console.error('Global error caught:', event.error || event.message);
        
        // Check if this is a JSON parsing error
        const errorMsg = (event.error && event.error.message) || event.message || '';
        if (errorMsg.includes('JSON.parse') || errorMsg.includes('JSON parse') || errorMsg.includes('position 38236')) {
            console.log('Detected JSON parsing error, attempting recovery');
            
            // Hide the loader if it's visible
            const loader = document.getElementById('inlineLoader');
            if (loader && loader.style.display !== 'none') {
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                    document.body.classList.remove('loading');
                }, 300);
                
                // Show a user-friendly error
                setTimeout(() => {
                    if (typeof showError === 'function') {
                        showError('There was a problem processing the data. Try a different search term or analysis option.');
                    } else {
                        const errorContainer = document.createElement('div');
                        errorContainer.className = 'mt-6 bg-red-50 border-l-4 border-red-500 p-4 max-w-3xl mx-auto';
                        errorContainer.id = 'error-message-container';
                        errorContainer.innerHTML = `
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-red-700">
                                        <strong>Error Processing Data:</strong> There was a problem with parsing the response data. 
                                        <span class="block mt-1 text-xs text-gray-600">This may be due to a temporary API issue or server timeout.</span>
                                    </p>
                                    <div class="mt-3">
                                        <button id="retryButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold text-sm py-1.5 px-3 rounded-md shadow-sm transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                                            </svg>
                                            Retry
                                        </button>
                                        <button id="changeKeywordButton" class="ml-2 bg-white hover:bg-gray-100 text-indigo-600 border border-indigo-200 font-semibold text-sm py-1.5 px-3 rounded-md shadow-sm transition-colors">
                                            Try Different Keyword
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Insert at the top of the results container or main container
                        const resultsContainer = document.getElementById('resultsContainer');
                        const trendsContainer = document.getElementById('trendsContainer');
                        const containerToUse = resultsContainer || trendsContainer;
                        
                        if (containerToUse) {
                            containerToUse.insertBefore(errorContainer, containerToUse.firstChild);
                            
                            // Add event listeners to the retry buttons
                            const retryButton = errorContainer.querySelector('#retryButton');
                            if (retryButton) {
                                retryButton.addEventListener('click', function() {
                                    // Remove the error container
                                    errorContainer.remove();
                                    
                                    // Get the current keyword and analysis option
                                    const keywordInput = document.getElementById('keywordInput') || document.getElementById('id_keyword');
                                    const analysisOption = document.getElementById('analysisOption');
                                    
                                    // If we have a valid keyword and the fetch function, retry the fetch
                                    if (keywordInput && keywordInput.value && typeof window.fetchTrendsData === 'function') {
                                        // Reset dataAlreadyFetched flag to allow fetch
                                        window.dataAlreadyFetched = false;
                                        
                                        // Fetch data again
                                        window.fetchTrendsData(keywordInput.value, analysisOption ? analysisOption.value : '1');
                                    }
                                });
                            }
                            
                            // Add event listener to change keyword button
                            const changeKeywordButton = errorContainer.querySelector('#changeKeywordButton');
                            if (changeKeywordButton) {
                                changeKeywordButton.addEventListener('click', function() {
                                    // Remove the error container
                                    errorContainer.remove();
                                    
                                    // Focus the keyword input
                                    const keywordInput = document.getElementById('keywordInput') || document.getElementById('id_keyword');
                                    if (keywordInput) {
                                        keywordInput.focus();
                                        keywordInput.select();
                                    }
                                });
                            }
                        } else {
                            // If no container found, just append to body
                            document.body.appendChild(errorContainer);
                        }
                    }
                }, 350);
            }
            
            // Attempt emergency chart rendering if we have data
            if (window.trendsData && typeof window.renderCharts === 'function') {
                console.log('Attempting emergency chart rendering with existing data');
                try {
                    window.renderCharts();
                } catch (e) {
                    console.error('Emergency chart rendering failed:', e);
                }
            }
        }
    });
    
    // Enhance the window.showError function to add retry functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Store the original showError function if it exists
        const originalShowError = window.showError;
        
        // Create enhanced version with retry button
        window.showError = function(message) {
            console.error('Error:', message);
            
            // First, clear any existing error messages
            const existingErrors = document.querySelectorAll('#error-message-container');
            existingErrors.forEach(error => error.remove());
            
            // Create error container
            const errorContainer = document.createElement('div');
            errorContainer.className = 'bg-red-50 border-l-4 border-red-500 p-4 rounded-md shadow-sm mb-6';
            errorContainer.id = 'error-message-container';
            
            // Format the error message
            let formattedMessage = message;
            let additionalInfo = '';
            
            // Customize message based on error type
            if (message.includes('JSON') || message.includes('parse') || message.includes('processing data') || message.includes('position 38236')) {
                formattedMessage = 'Error processing data';
                additionalInfo = 'The server response could not be properly processed. This may be due to temporary API issues.';
            } else if (message.includes('fetch') || message.includes('network') || message.includes('connection')) {
                formattedMessage = 'Connection error';
                additionalInfo = 'Please check your internet connection and try again.';
            } else if (message.includes('timeout') || message.includes('timed out')) {
                formattedMessage = 'Request timeout';
                additionalInfo = 'The server took too long to respond. Please try again later.';
            }
            
            errorContainer.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3 w-full">
                        <p class="text-sm font-medium text-red-800">${formattedMessage}</p>
                        <p class="text-xs text-red-700 mt-1">${message}</p>
                        ${additionalInfo ? `<p class="text-xs text-gray-600 mt-1">${additionalInfo}</p>` : ''}
                        
                        <div class="mt-3">
                            <button id="errorRetryButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold text-sm py-1.5 px-3 rounded-md shadow-sm transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                                </svg>
                                Retry
                            </button>
                            <button id="errorChangeKeywordButton" class="ml-2 bg-white hover:bg-gray-100 text-indigo-600 border border-indigo-200 font-semibold text-sm py-1.5 px-3 rounded-md shadow-sm transition-colors">
                                Try Different Keyword
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Find a suitable container to add the error to
            const container = document.getElementById('timeSeriesChartContainer') || 
                document.getElementById('chartControlsSection') || 
                document.getElementById('resultsContainer');
            
            if (container) {
                // Insert at the beginning of the container
                if (container.firstChild) {
                    container.insertBefore(errorContainer, container.firstChild);
                } else {
                    container.appendChild(errorContainer);
                }
                
                // Add event listener to retry button
                const retryButton = errorContainer.querySelector('#errorRetryButton');
                if (retryButton) {
                    retryButton.addEventListener('click', function() {
                        // Cancel any ongoing fetch operation
                        if (typeof window.cancelTrendsFetch === 'function') {
                            window.cancelTrendsFetch();
                        }
                        
                        // Hide error
                        errorContainer.remove();
                        
                        // Get the current keyword
                        const keywordInput = document.getElementById('keywordInput') || document.getElementById('id_keyword');
                        const analysisOption = document.getElementById('analysisOption');
                        
                        if (keywordInput && keywordInput.value && typeof window.fetchTrendsData === 'function') {
                            // Reset flag to allow fetch
                            window.dataAlreadyFetched = false;
                            
                            // Retry with the same keyword
                            window.fetchTrendsData(keywordInput.value, analysisOption ? analysisOption.value : '1');
                        }
                    });
                }
                
                // Add event listener to change keyword button
                const changeKeywordButton = errorContainer.querySelector('#errorChangeKeywordButton');
                if (changeKeywordButton) {
                    changeKeywordButton.addEventListener('click', function() {
                        // Focus the keyword input
                        const keywordInput = document.getElementById('keywordInput') || document.getElementById('id_keyword');
                        if (keywordInput) {
                            keywordInput.focus();
                            keywordInput.select();
                        }
                        
                        // Hide error
                        errorContainer.remove();
                    });
                }
            } else if (originalShowError) {
                // Fall back to original showError if available
                originalShowError(message);
            }
        };
        
        // Also define hideError if it doesn't exist
        if (typeof window.hideError !== 'function') {
            window.hideError = function() {
                const existingErrors = document.querySelectorAll('#error-message-container');
                existingErrors.forEach(error => error.remove());
            };
        }
    });
</script>

<!-- Reset auto-fetch behavior on normal navigation -->
<script>
    // Check if this is a genuine page load (not a form submission return)
    if (!document.referrer.includes(window.location.pathname) && location.search === '') {
        // Don't clear session storage on direct navigation anymore
        // We want to keep the last keyword for auto-fetch on reload
        console.log('Direct page load - preserving session storage for auto-fetch');
    }
    
    // Check if there's a stored keyword in session storage
    document.addEventListener('DOMContentLoaded', function() {
        const storedKeyword = sessionStorage.getItem('lastKeyword');
        if (storedKeyword) {
            console.log('Found stored keyword in session storage:', storedKeyword);
            
            // Update page title if we have a stored keyword
            const headerTitle = document.getElementById('headerTitle');
            if (headerTitle) {
                headerTitle.textContent = `${storedKeyword} in India`;
            }
            
            // Make the AI insights button visible if needed
            const aiInsightsButton = document.getElementById('aiInsightsButton');
            if (aiInsightsButton && aiInsightsButton.style.display === 'none') {
                aiInsightsButton.style.display = 'inline-flex';
            }
        }
    });
</script>

<!-- Custom styles for enhanced UI -->
<style>
    .chart-container {
        position: relative;
        transition: all 0.3s ease;
        border-radius: 1rem;
        overflow: hidden;
    }
    
    .chart-container:hover {
        box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.1), 0 10px 10px -5px rgba(79, 70, 229, 0.04);
        transform: translateY(-2px);
    }
    
    .filter-button {
        transition: all 0.2s ease;
    }
    
    .filter-button:hover {
        transform: translateY(-1px);
    }
    
    .filter-button.active {
        background-color: #4338ca;
        color: white;
    }
    
    .animate-gradient {
        background-size: 200% 200%;
        animation: gradient 8s ease infinite;
    }
    
    .filter-controls {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 1rem;
        padding: 1rem;
        background-color: #f9fafb;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .filter-group {
        min-width: 200px;
    }
    
    @keyframes gradient {
        0% {
            background-position: 0% 50%;
        }
        50% {
            background-position: 100% 50%;
        }
        100% {
            background-position: 0% 50%;
        }
    }
</style>

<!-- Filter visibility and functionality check -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Check if filter controls are visible
        const filterControls = document.querySelector('.filter-controls');
        if (filterControls) {
            console.log('Filter controls are present in the DOM');
            
            // Make sure they're visible
            filterControls.style.display = 'flex';
            
            setTimeout(() => {
                console.log('Filter controls visibility check:', 
                    window.getComputedStyle(filterControls).display !== 'none' ? 
                    'Filters are VISIBLE' : 'Filters are HIDDEN');
            }, 500);
        } else {
            console.error('Filter controls not found in DOM');
        }
        
        // Add logging to filter change events
        const timeRangeSelect = document.getElementById('timeRangeSelect');
        const quarterSelect = document.getElementById('quarterSelect');
        const monthSelect = document.getElementById('monthSelect');
        
        if (timeRangeSelect) {
            timeRangeSelect.addEventListener('change', function() {
                console.log('Year filter changed to:', this.value);
            });
        }
        
        if (quarterSelect) {
            quarterSelect.addEventListener('change', function() {
                console.log('Quarter filter changed to:', this.value);
            });
        }
        
        if (monthSelect) {
            monthSelect.addEventListener('change', function() {
                console.log('Month filter changed to:', this.value);
            });
        }
        
        // Function to ensure filters are initialized after chart is created
        function initializeFilters() {
            const chartFilters = document.getElementById('chartFilters');
            if (chartFilters) {
                chartFilters.style.display = 'flex';
                console.log('Filter initialization complete - filters are visible');
            }
        }
        
        // Call immediately and also set a timeout to ensure it runs after chart rendering
        initializeFilters();
        setTimeout(initializeFilters, 1000);
        setTimeout(initializeFilters, 3000);
        
        // Also initialize when window is fully loaded
        window.addEventListener('load', initializeFilters);
        
        // Add a mutation observer to detect when the chart container becomes visible
        const resultsContainer = document.getElementById('resultsContainer');
        if (resultsContainer) {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        console.log('Results container class changed, checking filters');
                        initializeFilters();
                    }
                });
            });
            
            observer.observe(resultsContainer, { attributes: true });
        }
    });
</script>

<script>
    // Function to update insights visibility
    function updateInsightsVisibility(hasData) {
        const insightsSection = document.getElementById('insightsSection');
        const noDataMessage = document.getElementById('noDataMessage');
        const resultsContainer = document.getElementById('resultsContainer');
        
        if (!resultsContainer) return;
        
        if (hasData) {
            insightsSection.classList.remove('hidden');
            noDataMessage.classList.add('hidden');
        } else {
            insightsSection.classList.add('hidden');
            noDataMessage.classList.remove('hidden');
        }
    }

    // Function to check if chart has data
    function checkChartData() {
        const chartContainer = document.getElementById('timeSeriesChartContainer');
        if (!chartContainer) return false;
        
        const canvas = chartContainer.querySelector('canvas');
        if (!canvas) return false;
        
        const ctx = canvas.getContext('2d');
        if (!ctx) return false;
        
        // Check if the chart has been drawn
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const hasData = imageData.data.some(x => x !== 0);
        
        return hasData;
    }

    // Initialize visibility on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Initially hide both sections
        const insightsSection = document.getElementById('insightsSection');
        const noDataMessage = document.getElementById('noDataMessage');
        
        if (insightsSection) insightsSection.classList.add('hidden');
        if (noDataMessage) noDataMessage.classList.add('hidden');
        
        // Show no data message if no chart data
        if (!checkChartData()) {
            updateInsightsVisibility(false);
        }
    });

    // Listen for chart updates
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                const hasData = checkChartData();
                updateInsightsVisibility(hasData);
            }
        });
    });

    // Start observing when the chart container is available
    const startObserving = setInterval(function() {
        const chartContainer = document.getElementById('timeSeriesChartContainer');
        if (chartContainer) {
            observer.observe(chartContainer, { 
                attributes: true,
                childList: true,
                subtree: true
            });
            clearInterval(startObserving);
        }
    }, 100);

    // Also check for chart data when the window loads
    window.addEventListener('load', function() {
        const hasData = checkChartData();
        updateInsightsVisibility(hasData);
    });
</script>
{% endblock %}

{% block content %}
<!-- Main content wrapper -->
<div class="container mx-auto px-4 py-8 relative" id="trendsContainer">
    
    <!-- Header -->
    <div class="text-center mb-10">
        <h1 class="text-3xl font-bold text-gray-800" id="headerTitle">
            {% if keyword %}{{ keyword }} in India{% else %}Google Search Trends in India{% endif %}
        </h1>
        <p class="text-lg text-gray-600 mt-2">
            Interactive visualization of search interest patterns in India over a 5-year period (2020-2025)
        </p>
    </div>
    
    <!-- Search form -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8 max-w-3xl mx-auto">
        <form id="trendsForm" method="post" action="{% url 'trends:trends' %}" class="space-y-4">
            {% csrf_token %}
            
            <div class="mb-4">
                <label for="keywordInput" class="block text-sm font-medium text-gray-700 mb-1">Enter a keyword or topic to analyze:</label>
                <div class="mt-1 flex rounded-md shadow-sm">
                    <input type="text" name="keyword" id="keywordInput" 
                           class="focus:ring-indigo-500 focus:border-indigo-500 flex-1 block w-full rounded-md sm:text-sm border-gray-300 p-3"
                           placeholder="e.g. Coconut Oil, Digital Marketing, Yoga..."
                           value="{{ keyword|default:'' }}" required>
                </div>
                <p class="text-xs text-gray-500 mt-1">See how search interest has changed over time in India</p>
            </div>
            
            <div class="mb-4">
                <label for="analysisOption" class="block text-sm font-medium text-gray-700 mb-1">Analysis Type:</label>
                <select id="analysisOption" name="analysis_option" 
                        class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    <option value="1" {% if analysis_option == '1' %}selected{% endif %}>Time trends only (fastest)</option>
                    <option value="2" {% if analysis_option == '2' %}selected{% endif %}>Time trends + State analysis</option>
                    <option value="3" {% if analysis_option == '3' %}selected{% endif %}>Time trends + City analysis</option>
                    <option value="4" {% if analysis_option == '4' %}selected{% endif %}>Complete analysis (Time + States + Cities)</option>
                </select>
            </div>
            
            <div class="flex justify-end">
                <input type="hidden" name="direct_submit" value="false">
                <button type="submit" id="analyzeButton"
                        class="inline-flex justify-center py-2 px-6 border border-transparent shadow-lg text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Analyze Trends
                </button>
            </div>
        </form>
    </div>
    
    <!-- Loader -->
    <div id="inlineLoader" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 backdrop-blur-md transition-opacity duration-300 opacity-0" style="display: none;">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex items-center">
                <div class="mr-4">
                    <svg class="animate-spin h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">1M</circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Analyzing Trends</h3>
                    <p class="text-sm text-gray-500">Fetching data for <span class="font-semibold">{% if keyword %}{{ keyword }}{% else %}your search{% endif %}</span></p>
                    <p class="text-sm text-gray-600 mt-1 step-text">Connecting to Google Trends</p>
                </div>
            </div>
            <div class="mt-4">
                <div class="h-2 bg-gray-200 rounded overflow-hidden">
                    <div class="h-full bg-indigo-600 rounded animate-pulse"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Results container -->
    <div id="resultsContainer" class="bg-white rounded-lg shadow-lg p-6 mb-8{% if not searched %} hidden{% endif %}" data-auto-fetch="{{ should_auto_fetch|lower }}">
        
        <!-- Time Series Chart Section -->
        <div class="mb-12">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Search Interest Over Time</h2>
            <div id="timeSeriesChartContainer" class="relative h-[60vh] mb-8 chart-container p-4 bg-gradient-to-br from-gray-50 to-white border border-gray-100 rounded-lg">
                <div class="absolute top-2 right-2 flex gap-2">
                    <button class="chart-control-btn download-btn" data-chart="timeSeries" title="Download chart as image">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                    </button>
                    <button class="chart-control-btn zoom-reset-btn" data-chart="timeSeries" title="Reset zoom">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                </div>
                <!-- Improved canvas wrapper with faded overlay for loading states -->
                <div class="relative">
                    <canvas id="timeSeriesChart" class="w-full"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-80 chart-loading" style="display: none;">
                        <div class="flex flex-col items-center">
                            <div class="loader-spinner mb-2"></div>
                            <p class="text-gray-700">Loading chart data...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Time unit controls with enhanced styling -->
                <div class="flex flex-wrap gap-2 mt-4 justify-center">
                    <button class="time-unit-btn px-3 py-1.5 border border-gray-300 rounded-md" data-unit="day" data-chart="timeSeries">Daily</button>
                    <button class="time-unit-btn px-3 py-1.5 border border-gray-300 rounded-md" data-unit="week" data-chart="timeSeries">Weekly</button>
                    <button class="time-unit-btn px-3 py-1.5 border border-gray-300 rounded-md active bg-[#27FFB4]/20 border-[#27FFB4]" data-unit="month" data-chart="timeSeries">Monthly</button>
                    <button class="time-unit-btn px-3 py-1.5 border border-gray-300 rounded-md" data-unit="quarter" data-chart="timeSeries">Quarterly</button>
                    <button class="time-unit-btn px-3 py-1.5 border border-gray-300 rounded-md" data-unit="year" data-chart="timeSeries">Yearly</button>
                </div>
            </div>
            
            <!-- Filter options -->
            <div class="filter-controls flex flex-wrap justify-center gap-4 mb-4" id="chartFilters">
                <div class="filter-group">
                    <label for="timeRangeSelect" class="block text-sm font-medium text-gray-700 mb-1">Year Filter:</label>
                    <select id="timeRangeSelect" class="bg-white text-gray-800 border border-gray-300 px-4 py-2 rounded-md w-full">
                        <option value="all">All Years</option>
                        <option value="2020">2020</option>
                        <option value="2021">2021</option>
                        <option value="2022">2022</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="quarterSelect" class="block text-sm font-medium text-gray-700 mb-1">Quarter Filter:</label>
                    <select id="quarterSelect" class="bg-white text-gray-800 border border-gray-300 px-4 py-2 rounded-md w-full">
                        <option value="all">All Quarters</option>
                        <option value="quarter:2020Q1">Q1 2020</option>
                        <option value="quarter:2020Q2">Q2 2020</option>
                        <option value="quarter:2020Q3">Q3 2020</option>
                        <option value="quarter:2020Q4">Q4 2020</option>
                        <option value="quarter:2021Q1">Q1 2021</option>
                        <option value="quarter:2021Q2">Q2 2021</option>
                        <option value="quarter:2021Q3">Q3 2021</option>
                        <option value="quarter:2021Q4">Q4 2021</option>
                        <option value="quarter:2022Q1">Q1 2022</option>
                        <option value="quarter:2022Q2">Q2 2022</option>
                        <option value="quarter:2022Q3">Q3 2022</option>
                        <option value="quarter:2022Q4">Q4 2022</option>
                        <option value="quarter:2023Q1">Q1 2023</option>
                        <option value="quarter:2023Q2">Q2 2023</option>
                        <option value="quarter:2023Q3">Q3 2023</option>
                        <option value="quarter:2023Q4">Q4 2023</option>
                        <option value="quarter:2024Q1">Q1 2024</option>
                        <option value="quarter:2024Q2">Q2 2024</option>
                        <option value="quarter:2024Q3">Q3 2024</option>
                        <option value="quarter:2024Q4">Q4 2024</option>
                        <option value="quarter:2025Q1">Q1 2025</option>
                        <option value="quarter:2025Q2">Q2 2025</option>
                        <option value="quarter:2025Q3">Q3 2025</option>
                        <option value="quarter:2025Q4">Q4 2025</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="monthSelect" class="block text-sm font-medium text-gray-700 mb-1">Month Filter:</label>
                    <select id="monthSelect" class="bg-white text-gray-800 border border-gray-300 px-4 py-2 rounded-md w-full">
                        <option value="all">All Months</option>
                        <option value="month:2020-1">Jan 2020</option>
                        <option value="month:2020-2">Feb 2020</option>
                        <option value="month:2020-3">Mar 2020</option>
                        <option value="month:2020-4">Apr 2020</option>
                        <option value="month:2020-5">May 2020</option>
                        <option value="month:2020-6">Jun 2020</option>
                        <option value="month:2020-7">Jul 2020</option>
                        <option value="month:2020-8">Aug 2020</option>
                        <option value="month:2020-9">Sep 2020</option>
                        <option value="month:2020-10">Oct 2020</option>
                        <option value="month:2020-11">Nov 2020</option>
                        <option value="month:2020-12">Dec 2020</option>
                        <!-- Add more recent years/months first -->
                        <option value="month:2024-1">Jan 2024</option>
                        <option value="month:2024-2">Feb 2024</option>
                        <option value="month:2024-3">Mar 2024</option>
                        <option value="month:2024-4">Apr 2024</option>
                        <option value="month:2024-5">May 2024</option>
                        <option value="month:2024-6">Jun 2024</option>
                        <option value="month:2024-7">Jul 2024</option>
                        <option value="month:2024-8">Aug 2024</option>
                        <option value="month:2024-9">Sep 2024</option>
                        <option value="month:2024-10">Oct 2024</option>
                        <option value="month:2024-11">Nov 2024</option>
                        <option value="month:2024-12">Dec 2024</option>
                    </select>
                </div>
            </div>
            
            <!-- Legend section -->
            <div class="legend flex flex-wrap justify-center gap-6 mt-4">
                <div class="legend-item flex items-center">
                    <div class="legend-color w-4 h-4 mr-2 rounded" style="background: rgba(52, 152, 219, 0.7);"></div>
                    <span class="text-sm">Search Interest</span>
                </div>
                <div class="legend-item flex items-center">
                    <div class="legend-color w-4 h-4 mr-2 rounded" style="background: rgba(231, 76, 60, 0.7);"></div>
                    <span class="text-sm">Trend Line</span>
                </div>
                <div class="legend-item flex items-center">
                    <div class="legend-color w-4 h-4 mr-2 rounded" style="background: rgba(46, 204, 113, 0.7);"></div>
                    <span class="text-sm">Moving Average</span>
                </div>
            </div>
        </div>
        
        <!-- Insights Section -->
        <div id="insightsSection" class="insights bg-gray-50 p-6 rounded-lg mb-8 h-[60vh] overflow-auto shadow-inner hidden">
            <h3 class="text-lg font-semibold text-blue-600 mb-3 sticky top-0 bg-gray-50 py-2 z-10">Key Insights</h3>
            <div id="insightsContent" class="text-gray-700">
                <p class="text-center text-gray-500 italic">Loading analysis...</p>
            </div>
        </div>
        
        <!-- No Data Message -->
        <div id="noDataMessage" class="hidden bg-gradient-to-br from-indigo-50 to-purple-50 p-8 rounded-lg mb-8 text-center">
            <div class="max-w-2xl mx-auto">
                <svg class="w-16 h-16 mx-auto text-indigo-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">No Data Available Yet</h3>
                <p class="text-gray-600 mb-4">Enter a keyword above to see search trends and get detailed insights about its popularity in India.</p>
                <div class="flex justify-center space-x-4">
                    <button onclick="document.getElementById('keywordInput').focus()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        Start Searching
                    </button>
                </div>
            </div>
        </div>
        
        {% if google_api_configured %}
        <!-- AI Insights button -->
        <div class="mt-6 text-center">
            <a id="aiInsightsButton" href="{% if keyword %}{% url 'trends:insights' keyword=keyword %}{% else %}#{% endif %}" 
               class="inline-flex items-center px-6 py-2 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-1 0a7 7 0 11-14 0 7 7 0 0114 0zm-7-2a1 1 0 011 1v3a1 1 0 11-2 0V9a1 1 0 011-1zm0-4a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" />
                </svg>
                Get Advanced AI Insights
            </a>
        </div>
        {% endif %}
        
    </div>
    
    <!-- Recent searches (if available) -->
    {% if recent_searches %}
    <div class="recent-searches bg-white rounded-lg shadow-md p-6 mb-8 max-w-3xl mx-auto">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Recent Searches</h2>
        <div class="flex flex-wrap gap-2">
            {% for search in recent_searches %}
            <a href="{% url 'trends:trends' %}?keyword={{ search.keyword|urlencode }}" 
               class="inline-block px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm rounded-full transition-colors">
                {{ search.keyword }}
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Error message container -->
    <div id="error-message-container" class="hidden mt-6 bg-red-50 border-l-4 border-red-500 p-4 max-w-3xl mx-auto">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm text-red-700" id="error-message">
                    An error occurred while fetching trends data.
                </p>
            </div>
        </div>
    </div>
    
</div>
{% endblock %} 
