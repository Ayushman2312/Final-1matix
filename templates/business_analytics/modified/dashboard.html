{% extends 'user_dashboard/base.html' %}
{% load static %}

{% block content %}
<div class="w-full sm:py-6 md:py-2 font-[Quicksand] mb-10">
    <div class="bg-white rounded-[20px] shadow-[0_4px_16px_0_rgba(123,61,243,0.07)] p-4 sm:p-7 border border-[#F0EFFF] mb-6">
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
                <h2 class="font-bold text-base sm:text-lg text-[#232323] whitespace-nowrap" style="font-family: 'Montserrat', sans-serif;">
                    Business Analytics
                </h2>
            </div>
            <button 
                id="uploadAnalyticsBtn"
                class="text-[#7B3DF3] px-3 py-1.5 rounded-lg text-sm font-medium flex items-center hover:bg-[#F0EFFF] transition-colors duration-200"
                style="font-family: 'Montserrat', sans-serif;"
                aria-label="Upload Data">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                </svg>
                Upload Data
            </button>
        </div>
        
        <!-- Debug information for template rendering -->
        <div id="debugInfo" class="bg-gray-100 p-2 rounded mb-4 text-xs font-mono">
            <div>Debug: Template rendered. Recent analysis: {% if recent_analysis %}Available (ID: {{ recent_analysis.id }}){% else %}Not available{% endif %}</div>
            {% if recent_analysis and recent_analysis.analysis_data %}
                <div>Analysis data available: Yes</div>
                <div>Time series data: {% if recent_analysis.analysis_data.time_series %}Available ({{ recent_analysis.analysis_data.time_series.labels|length }} periods){% else %}Not available{% endif %}</div>
            {% else %}
                <div>Analysis data available: No</div>
            {% endif %}
        </div>
        
        <div id="noAnalysisMessage" class="{% if recent_analysis %}hidden{% endif %} text-center py-8">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="text-gray-600 font-medium mb-2">No Analysis Data Yet</h3>
            <p class="text-gray-500 text-sm mb-4">Upload your sales data to see detailed analytics and insights</p>
            <button 
                id="uploadEmptyBtn"
                class="px-6 py-2 bg-[#7B3DF3] text-white rounded-lg text-sm font-medium hover:bg-[#6931D3] transition-all duration-300">
                Upload Sales Data
            </button>
        </div>
        
        <div id="analysisContent" class="{% if not recent_analysis %}hidden{% endif %}">
            <!-- Analysis content for the main dashboard -->
            {% if recent_analysis %}
            <div class="mb-6">
                <h4 class="text-lg font-semibold mb-3 text-gray-800">Sales Summary</h4>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4" id="dashboardSummaryCards">
                    <!-- Summary cards will be added here -->
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6" id="dashboardChartsContainer">
                <div id="salesTrendContainer" class="bg-white rounded-lg shadow p-4 border border-gray-100 hidden">
                    <h4 class="text-sm font-semibold mb-3 text-gray-800">Sales Trend</h4>
                    <div class="h-60">
                        <canvas id="dashboardSalesTrendChart"></canvas>
                    </div>
                </div>
                
                <div id="salesChannelContainer" class="bg-white rounded-lg shadow p-4 border border-gray-100 hidden">
                    <h4 class="text-sm font-semibold mb-3 text-gray-800">Sales by Channel</h4>
                    <div class="h-60">
                        <canvas id="dashboardSalesChannelChart"></canvas>
                    </div>
                </div>
                
                <!-- Fallback chart container for when primary charts don't have data -->
                <div id="fallbackChartContainer" class="bg-white rounded-lg shadow p-4 border border-gray-100 hidden">
                    <h4 id="fallbackChartTitle" class="text-sm font-semibold mb-3 text-gray-800">Available Data</h4>
                    <div class="h-60">
                        <canvas id="fallbackChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="dashboardListsContainer">
                <div id="topProductsContainer" class="bg-white rounded-lg shadow p-4 border border-gray-100 hidden">
                    <h4 class="text-sm font-semibold mb-3 text-gray-800">Top Products</h4>
                    <div id="dashboardTopProductsList" class="space-y-2">
                        <!-- Top products will be added here -->
                    </div>
                </div>
                
                <div id="topRegionsContainer" class="bg-white rounded-lg shadow p-4 border border-gray-100 hidden">
                    <h4 class="text-sm font-semibold mb-3 text-gray-800">Top Regions</h4>
                    <div id="dashboardTopRegionsList" class="space-y-2">
                        <!-- Top regions will be added here -->
                    </div>
                </div>
                
                <!-- Fallback list container for when primary lists don't have data -->
                <div id="fallbackListContainer" class="bg-white rounded-lg shadow p-4 border border-gray-100 hidden">
                    <h4 id="fallbackListTitle" class="text-sm font-semibold mb-3 text-gray-800">Available Data</h4>
                    <div id="fallbackList" class="space-y-2">
                        <!-- Fallback data will be added here -->
                    </div>
                </div>
                
                <!-- Data quality info container -->
                <div id="dataQualityContainer" class="bg-white rounded-lg shadow p-4 border border-gray-100 hidden">
                    <h4 class="text-sm font-semibold mb-3 text-gray-800">Data Quality Information</h4>
                    <div id="dataQualityContent" class="text-sm text-gray-600">
                        <!-- Data quality info will be added here -->
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Debug information section -->
    <div class="mt-6 bg-white rounded-[20px] shadow-[0_4px_16px_0_rgba(123,61,243,0.07)] p-4 sm:p-7 border border-[#F0EFFF]">
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
                <h2 class="font-bold text-base sm:text-lg text-[#232323] whitespace-nowrap" style="font-family: 'Montserrat', sans-serif;">
                    Debug Information
                </h2>
            </div>
            <button 
                id="toggleDebugBtn"
                class="text-[#7B3DF3] px-3 py-1.5 rounded-lg text-sm font-medium flex items-center hover:bg-[#F0EFFF] transition-colors duration-200"
                style="font-family: 'Montserrat', sans-serif;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Toggle
            </button>
        </div>
        
        <div id="debugInfoContainer" class="hidden">
            <!-- Response status info -->
            <div class="mb-3 bg-gray-50 p-3 rounded-md">
                <div class="text-sm font-medium text-gray-700 mb-1">Last Request Status:</div>
                <div id="requestStatus" class="text-xs text-gray-600">No requests made yet</div>
            </div>
            
            <!-- Analysis data debug info -->
            <div class="mb-3">
                <div class="text-sm font-medium text-gray-700 mb-1">Analysis Data:</div>
                <div id="debugInfo" class="text-xs"></div>
            </div>
            
            <!-- Raw response debug -->
            <div>
                <div class="text-sm font-medium text-gray-700 mb-1">Raw Response:</div>
                <pre id="rawResponseDebug" class="bg-gray-100 p-2 rounded-md text-xs overflow-auto max-h-40 whitespace-pre-wrap"></pre>
            </div>
        </div>
    </div>
</div>

<!-- Platform-specific analysis results container -->
<div id="platformSpecificResults" class="bg-white rounded-[20px] shadow-[0_4px_16px_0_rgba(123,61,243,0.07)] p-4 sm:p-7 border border-[#F0EFFF] mt-6 hidden">
    <!-- Platform-specific analysis will be inserted here dynamically -->
</div>

<!-- Modal for displaying analysis results -->
<div id="analysisModal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
    <div class="absolute inset-0 bg-black opacity-50" id="analysisModalOverlay"></div>
    <div class="bg-white w-full max-w-4xl mx-4 rounded-xl shadow-xl z-10 max-h-[90vh] overflow-y-auto">
        <!-- Modal header -->
        <div class="flex items-center justify-between p-6 border-b">
            <h3 class="text-xl font-bold text-gray-900" id="analysisModalTitle">Analysis Results</h3>
            <button id="closeAnalysisModalBtn" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <!-- Modal content -->
        <div class="p-6">
            <!-- Column mapping info -->
            <div id="columnMappingSection" class="mb-6">
                <h4 class="text-lg font-semibold mb-3 text-gray-800">Column Mapping</h4>
                
                <!-- Column mapping issues alert -->
                <div id="modalColumnMappingIssues" class="hidden mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                    <h5 class="text-sm font-medium text-yellow-800 mb-2">Column Mapping Issues</h5>
                    <ul id="modalColumnMappingIssuesList" class="text-xs text-yellow-700 list-disc pl-5 space-y-1">
                        <!-- Column mapping issues will be added here -->
                    </ul>
                </div>
                
                <!-- Detected columns -->
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <div class="bg-gray-50 p-3 rounded-md">
                        <div class="text-sm font-medium text-gray-700">Sales Amount</div>
                        <div id="salesAmountMapping" class="text-xs text-gray-600 mt-1">Not detected</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-md">
                        <div class="text-sm font-medium text-gray-700">Order Date</div>
                        <div id="orderDateMapping" class="text-xs text-gray-600 mt-1">Not detected</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-md">
                        <div class="text-sm font-medium text-gray-700">Product Name/ID</div>
                        <div id="productNameMapping" class="text-xs text-gray-600 mt-1">Not detected</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-md">
                        <div class="text-sm font-medium text-gray-700">Customer Location</div>
                        <div id="customerLocationMapping" class="text-xs text-gray-600 mt-1">Not detected</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-md">
                        <div class="text-sm font-medium text-gray-700">Sales Channel</div>
                        <div id="salesChannelMapping" class="text-xs text-gray-600 mt-1">Not detected</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-md">
                        <div class="text-sm font-medium text-gray-700">Quantity</div>
                        <div id="quantityMapping" class="text-xs text-gray-600 mt-1">Not detected</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-md">
                        <div class="text-sm font-medium text-gray-700">Transaction Type</div>
                        <div id="transactionTypeMapping" class="text-xs text-gray-600 mt-1">Not detected</div>
                    </div>
                </div>
            </div>
            
            <div id="analysisContent" class="space-y-6">
                <!-- Analysis content will be inserted here dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
    <div class="absolute inset-0 bg-black bg-opacity-50" id="uploadModalOverlay"></div>
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4 relative z-10 overflow-hidden max-h-[85vh] overflow-y-auto">
        <!-- Modal Header -->
        <div class="bg-[#7B3DF3] py-1.5 px-4 flex justify-between items-center">
            <h3 class="text-white text-sm font-bold">Upload Sales Data</h3>
            <button id="closeUploadModal" class="text-white hover:text-gray-200 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <!-- Modal Content -->
        <div class="p-3">
            <div class="mb-2">
                <p class="text-xs text-gray-600 mb-1">Upload your marketplace sales data (CSV or Excel) for AI-powered analysis.</p>
                <div class="bg-gray-50 p-1.5 rounded-md text-xs text-gray-500 mb-1.5">
                    <p class="mb-0.5"><strong>Supported formats:</strong> CSV, XLSX, XLS</p>
                    <p class="mb-0.5"><strong>Recommended:</strong> At least 5 records for meaningful analysis.</p>
                    <p><strong>Tip:</strong> Include sales amount, dates, products for best results.</p>
                </div>
            </div>
            
            <form id="uploadForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="mb-2">
                    <label for="platformType" class="block text-xs font-medium text-gray-700 mb-1">Marketplace Platform (Optional)</label>
                    <select id="platformType" name="platform_type" class="w-full bg-white border border-gray-300 rounded-md py-1 px-2.5 text-xs font-medium text-gray-700 focus:outline-none focus:ring-2 focus:ring-[#7B3DF3] focus:border-[#7B3DF3]">
                        <option value="">Auto-detect (Generic Analysis)</option>
                        <option value="amazon">Amazon</option>
                        <option value="flipkart">Flipkart</option>
                        <option value="meesho">Meesho</option>
                    </select>
                </div>
                
                <!-- Default file upload section (for non-Meesho platforms) -->
                <div id="standardFileUpload" class="mb-2">
                    <label for="fileInput" class="block text-xs font-medium text-gray-700 mb-1">Select File</label>
                    <div class="flex items-center space-x-2">
                        <input type="file" id="fileInput" name="file" class="hidden" accept=".csv,.xlsx,.xls">
                        <label for="fileInput" class="cursor-pointer bg-white border border-gray-300 rounded-md py-1 px-2.5 text-xs font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-[#7B3DF3] focus:border-[#7B3DF3] flex-grow flex items-center justify-between">
                            <span id="selectedFileName">Choose file...</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" />
                            </svg>
                        </label>
                    </div>
                </div>
                
                <!-- Meesho-specific file upload section (hidden by default) -->
                <div id="meeshoFileUpload" class="hidden mb-2">
                    <div class="bg-purple-50 p-2 rounded-md mb-2 border border-purple-100">
                        <p class="text-xs text-purple-700 font-medium mb-1">Meesho Data Upload</p>
                        <p class="text-xs text-purple-600">Please upload both sales data and returns data files. Both will be merged for comprehensive analysis.</p>
                    </div>
                    
                    <!-- Sales data file upload -->
                    <div class="mb-2">
                        <label for="salesFileInput" class="block text-xs font-medium text-gray-700 mb-1">Sales Data File</label>
                        <div class="flex items-center space-x-2">
                            <input type="file" id="salesFileInput" name="sales_file" class="hidden" accept=".csv,.xlsx,.xls">
                            <label for="salesFileInput" class="cursor-pointer bg-white border border-gray-300 rounded-md py-1 px-2.5 text-xs font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-[#7B3DF3] focus:border-[#7B3DF3] flex-grow flex items-center justify-between">
                                <span id="selectedSalesFileName">Choose sales file...</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" />
                                </svg>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Returns data file upload -->
                    <div>
                        <label for="returnsFileInput" class="block text-xs font-medium text-gray-700 mb-1">Returns Data File <span class="text-gray-500 font-normal">(with cancel_return_date column)</span></label>
                        <div class="flex items-center space-x-2">
                            <input type="file" id="returnsFileInput" name="returns_file" class="hidden" accept=".csv,.xlsx,.xls">
                            <label for="returnsFileInput" class="cursor-pointer bg-white border border-gray-300 rounded-md py-1 px-2.5 text-xs font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-[#7B3DF3] focus:border-[#7B3DF3] flex-grow flex items-center justify-between">
                                <span id="selectedReturnsFileName">Choose returns file...</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" />
                                </svg>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div id="uploadStatus" class="hidden mb-2"></div>
                
                <div id="columnMappingIssuesContainer" class="hidden mb-2 p-1.5 bg-yellow-50 border border-yellow-200 rounded-md">
                    <h4 class="text-xs font-medium text-yellow-800 mb-1">Column Mapping Issues</h4>
                    <ul id="columnMappingIssuesList" class="text-xs text-yellow-700 list-disc pl-4 space-y-0.5">
                        <!-- Column mapping issues will be added here -->
                    </ul>
                    <div class="mt-1 text-xs text-yellow-600">
                        <p>These issues may affect the analysis quality. Consider remapping columns.</p>
                    </div>
                </div>
                
                <div class="flex items-center justify-between">
                    <button type="button" id="uploadButton" class="bg-[#7B3DF3] py-1 px-3 text-white text-xs font-medium rounded-md hover:bg-[#6931D3] focus:outline-none focus:ring-2 focus:ring-[#7B3DF3] focus:ring-opacity-50 transition-colors">
                        <span id="uploadButtonText">Upload & Analyze</span>
                        <span id="uploadSpinner" class="hidden ml-1 animate-spin">↻</span>
                    </button>
                    <button type="button" id="advancedOptionsBtn" class="text-xs text-gray-500 hover:text-[#7B3DF3] transition-colors">
                        Advanced Options
                    </button>
                </div>
            </form>
            
            <!-- Advanced Options Panel (hidden by default) -->
            <div id="advancedOptionsPanel" class="hidden mt-2 p-2 bg-gray-50 rounded-md border border-gray-200">
                <h4 class="text-xs font-medium text-gray-700 mb-1">Manual Column Mapping</h4>
                <div class="text-xs text-gray-500 mb-1">
                    If column detection isn't working correctly, manually select the appropriate columns below:
                </div>
                
                <!-- Auto-detect button -->
                <div class="mb-2">
                    <button type="button" id="autoDetectBtn" class="text-xs px-2 py-0.5 bg-blue-50 text-blue-600 border border-blue-200 rounded hover:bg-blue-100 transition-colors">
                        Auto-Detect Columns
                    </button>
                    <span class="text-xs text-gray-500 ml-1">Uses intelligent pattern matching</span>
                </div>
                
                <!-- Column Mapping Form -->
                <div id="columnMappingForm" class="space-y-1.5 p-1.5 bg-white rounded border border-gray-200">
                    <div class="grid grid-cols-2 gap-1.5">
                        <label class="text-xs text-gray-600 font-medium">Sales Amount <span class="text-red-500">*</span></label>
                        <select id="salesAmountColumn" class="text-xs border border-gray-300 rounded p-0.5 w-full">
                            <option value="">Auto-detect</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-1.5">
                        <label class="text-xs text-gray-600 font-medium">Order Date <span class="text-red-500">*</span></label>
                        <select id="orderDateColumn" class="text-xs border border-gray-300 rounded p-0.5 w-full">
                            <option value="">Auto-detect</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-1.5">
                        <label class="text-xs text-gray-600 font-medium">Product Name/ID <span class="text-red-500">*</span></label>
                        <select id="productColumn" class="text-xs border border-gray-300 rounded p-0.5 w-full">
                            <option value="">Auto-detect</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-1.5">
                        <label class="text-xs text-gray-600 font-medium">Customer Location</label>
                        <select id="locationColumn" class="text-xs border border-gray-300 rounded p-0.5 w-full">
                            <option value="">Auto-detect</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-1.5">
                        <label class="text-xs text-gray-600 font-medium">Quantity</label>
                        <select id="quantityColumn" class="text-xs border border-gray-300 rounded p-0.5 w-full">
                            <option value="">Auto-detect</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-1.5">
                        <label class="text-xs text-gray-600 font-medium">Transaction Type</label>
                        <select id="transactionTypeColumn" class="text-xs border border-gray-300 rounded p-0.5 w-full">
                            <option value="">Auto-detect</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                </div>
                <div class="mt-1 text-xs text-gray-500">
                    <p>Fields marked with <span class="text-red-500">*</span> are required for basic analysis.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Buttons and modals
    const uploadAnalyticsBtn = document.getElementById('uploadAnalyticsBtn');
    const uploadEmptyBtn = document.getElementById('uploadEmptyBtn');
    const uploadModal = document.getElementById('uploadModal');
    const closeUploadModal = document.getElementById('closeUploadModal');
    const uploadModalOverlay = document.getElementById('uploadModalOverlay');
    const analysisModal = document.getElementById('analysisModal');
    const closeAnalysisModalBtn = document.getElementById('closeAnalysisModalBtn');
    const analysisModalOverlay = document.getElementById('analysisModalOverlay');
    const toggleDebugBtn = document.getElementById('toggleDebugBtn');
    const debugInfoContainer = document.getElementById('debugInfoContainer');
    
    // File upload elements
    const fileInput = document.getElementById('fileInput');
    const selectedFileName = document.getElementById('selectedFileName');
    const uploadForm = document.getElementById('uploadForm');
    const platformType = document.getElementById('platformType');
    const uploadButton = document.getElementById('uploadButton');
    const uploadButtonText = document.getElementById('uploadButtonText');
    const uploadSpinner = document.getElementById('uploadSpinner');
    const uploadStatus = document.getElementById('uploadStatus');
    
    // Meesho-specific elements
    const standardFileUpload = document.getElementById('standardFileUpload');
    const meeshoFileUpload = document.getElementById('meeshoFileUpload');
    const salesFileInput = document.getElementById('salesFileInput');
    const returnsFileInput = document.getElementById('returnsFileInput');
    const selectedSalesFileName = document.getElementById('selectedSalesFileName');
    const selectedReturnsFileName = document.getElementById('selectedReturnsFileName');
    
    // Toggle Meesho-specific UI when platform type changes
    if (platformType) {
        platformType.addEventListener('change', function() {
            if (this.value === 'meesho') {
                standardFileUpload.classList.add('hidden');
                meeshoFileUpload.classList.remove('hidden');
                
                // Update the upload button text
                uploadButtonText.textContent = 'Upload Both Files & Analyze';
                
                // Show Meesho-specific info
                showUploadStatus('Meesho platform selected. Please upload both sales data and returns data files for comprehensive analysis.', 'info');
            } else {
                standardFileUpload.classList.remove('hidden');
                meeshoFileUpload.classList.add('hidden');
                
                // Reset the upload button text
                uploadButtonText.textContent = 'Upload & Analyze';
                
                // Clear any Meesho-specific info
                if (uploadStatus.innerText && uploadStatus.innerText.includes('Meesho platform selected')) {
                    uploadStatus.classList.add('hidden');
                }
            }
        });
    }
    
    // Handle file selection for standard upload
    if (fileInput) {
        fileInput.addEventListener('change', function() {
            if (fileInput.files.length > 0) {
                // Use the new handler function
                handleFileSelection(fileInput.files[0]);
            } else {
                selectedFileName.textContent = 'Choose file...';
                
                // Reset any previous upload status
                uploadStatus.innerHTML = '';
                uploadStatus.classList.add('hidden');
                
                // Reset column mapping issues
                columnMappingIssuesContainer.classList.add('hidden');
                columnMappingIssuesList.innerHTML = '';
            }
        });
    }
    
    // Handle file selection for Meesho sales data
    if (salesFileInput) {
        salesFileInput.addEventListener('change', function() {
            if (salesFileInput.files.length > 0) {
                selectedSalesFileName.textContent = salesFileInput.files[0].name;
                
                // Check if both files are selected
                checkMeeshoFilesStatus();
                
                // Extract headers if it's a CSV file
                if (salesFileInput.files[0].name.toLowerCase().endsWith('.csv')) {
                    extractFileHeaders(salesFileInput.files[0], 'sales');
                }
            } else {
                selectedSalesFileName.textContent = 'Choose sales file...';
            }
        });
    }
    
    // Handle file selection for Meesho returns data
    if (returnsFileInput) {
        returnsFileInput.addEventListener('change', function() {
            if (returnsFileInput.files.length > 0) {
                selectedReturnsFileName.textContent = returnsFileInput.files[0].name;
                
                // Check if both files are selected
                checkMeeshoFilesStatus();
                
                // Extract headers if it's a CSV file
                if (returnsFileInput.files[0].name.toLowerCase().endsWith('.csv')) {
                    extractFileHeaders(returnsFileInput.files[0], 'returns');
                }
            } else {
                selectedReturnsFileName.textContent = 'Choose returns file...';
            }
        });
    }
    
    // Function to check if both Meesho files are selected
    function checkMeeshoFilesStatus() {
        if (salesFileInput.files.length > 0 && returnsFileInput.files.length > 0) {
            showUploadStatus('Both sales and returns files selected. Ready to analyze!', 'success');
            
            // Enable the upload button if it was disabled
            if (uploadButton.disabled) {
                uploadButton.disabled = false;
            }
        } else if (salesFileInput.files.length > 0) {
            showUploadStatus('Sales file selected. Please also select a returns file.', 'info');
        } else if (returnsFileInput.files.length > 0) {
            showUploadStatus('Returns file selected. Please also select a sales file.', 'info');
        }
    }
    
    // Function to extract headers from CSV files with file type parameter
    function extractFileHeaders(file, fileType = 'standard') {
        if (!file) return;
        
        // Update the UI to show file is being processed
        showUploadStatus(`Processing ${fileType} file...`, 'info');
        
        // Only process CSV files for header extraction
        if (file.name.toLowerCase().endsWith('.csv')) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const lines = content.split(/\r\n|\n|\r/);  // Handle different line endings
                    
                    if (lines.length > 0) {
                        // Try to detect the delimiter by examining the first few lines
                        let bestDelimiter = detectDelimiter(lines.slice(0, 5));
                        console.log(`Detected delimiter: ${bestDelimiter}`);
                        
                        // Handle quoted cells with delimiters inside them
                        let headers = [];
                        const firstLine = lines[0].trim();
                        
                        // Parse CSV properly handling quoted strings
                        if (firstLine.includes('"')) {
                            // Use regex to handle quoted fields with delimiters inside
                            const regex = new RegExp(`"[^"]*"|[^"${bestDelimiter}]+`, 'g');
                            headers = [];
                            let matches = firstLine.match(regex) || [];
                            
                            for (let match of matches) {
                                // Remove quotes and trim
                                let header = match.replace(/^"(.*)"$/, '$1').trim();
                                if (header) headers.push(header);
                            }
                        } else {
                            // Simple split for non-quoted headers
                            headers = firstLine.split(bestDelimiter)
                                .map(header => header.trim())
                                .filter(header => header);
                        }
                        
                        // Clean headers - remove BOM marker, quotes, etc.
                        headers = headers.map(h => {
                            // Remove BOM mark if present
                            let clean = h.replace(/^\uFEFF/, '');
                            // Remove quotes and trim
                            clean = clean.replace(/^["'](.*)["']$/, '$1').trim();
                            return clean;
                        });
                        
                        console.log(`Extracted headers (${fileType}):`, headers);
                        
                        // Check for cancel_return_date column in returns file
                        if (fileType === 'returns') {
                            const hasReturnDateColumn = headers.some(h => 
                                h.toLowerCase().includes('cancel_return_date') || 
                                h.toLowerCase().includes('return_date') || 
                                h.toLowerCase().includes('cancellation_date'));
                            
                            if (!hasReturnDateColumn) {
                                showUploadStatus('Warning: The returns file does not appear to have a cancel_return_date column. This might affect analysis quality.', 'warning');
                            } else {
                                showUploadStatus('Returns file contains cancel_return_date column. Good to proceed!', 'success');
                            }
                        }
                        
                        // Populate column mapping dropdowns with these headers
                        if (headers.length > 0) {
                            populateColumnMappingDropdowns(headers);
                            
                            // Show advanced options panel automatically if we have headers
                            if (advancedOptionsPanel) {
                                advancedOptionsPanel.classList.remove('hidden');
                            }
                            
                            // Set column mapping intelligently
                            intelligentColumnMapping(headers);
                            
                            // Update status
                            if (fileType === 'standard' || fileType === 'sales') {
                                showUploadStatus(`Found ${headers.length} columns in the ${fileType} file. You can customize column mapping in Advanced Options.`, 'success');
                            }
                        } else {
                            showUploadStatus(`Could not detect columns in ${fileType} CSV file. You may need to map columns manually after upload.`, 'warning');
                        }
                    } else {
                        showUploadStatus(`${fileType} CSV file appears to be empty.`, 'error');
                    }
                } catch (error) {
                    console.error('Error extracting headers:', error);
                    showUploadStatus(`Error reading ${fileType} file headers. Try uploading anyway.`, 'error');
                }
            };
            
            // Read just the beginning of the file to get headers
            try {
                const blob = file.slice(0, 8192);  // First 8KB should be enough for headers
                reader.readAsText(blob);
            } catch (error) {
                console.error('Error reading file slice:', error);
                showUploadStatus(`Error reading ${fileType} file. Try a different file format.`, 'error');
            }
        } else if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
            // For Excel files, we cannot easily extract headers without a library
            // Show a message that manual mapping will be available after initial processing
            showUploadStatus(`Excel ${fileType} file detected. Column mapping will be available after initial processing.`, 'info');
        }
    }
    
    // Existing handleFileSelection function with small modification
    function handleFileSelection(file) {
        if (!file) return;
        
        selectedFileName.textContent = file.name;
        
        // Reset any previous upload status
        uploadStatus.innerHTML = '';
        uploadStatus.classList.add('hidden');
        
        // Reset column mapping issues
        columnMappingIssuesContainer.classList.add('hidden');
        columnMappingIssuesList.innerHTML = '';
        
        // Reset column mapping dropdowns
        resetColumnMappingForm();
        
        // If it's an Excel file, add some helpful guidance
        if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
            showUploadStatus('Excel file detected. Ensure it has proper column headers in the first row for best results.', 'info');
            
            // Auto-show advanced options panel for Excel files
            if (advancedOptionsPanel) {
                advancedOptionsPanel.classList.remove('hidden');
            }
        }
        
        // Extract headers if it's a CSV file
        if (file.name.toLowerCase().endsWith('.csv')) {
            extractFileHeaders(file, 'standard');
        }
    }
    
    // Handle form submission
    if (uploadButton) {
        uploadButton.addEventListener('click', function(e) {
            e.preventDefault();
            
            const isMeesho = platformType && platformType.value === 'meesho';
            
            // Check if the required files are selected
            if (isMeesho) {
                // For Meesho, both sales and returns files are required
                if (!salesFileInput.files.length || !returnsFileInput.files.length) {
                    showUploadStatus('Please select both sales and returns files for Meesho analysis.', 'error');
                    return;
                }
            } else {
                // For standard upload, just one file is required
                if (!fileInput.files.length) {
                    showUploadStatus('Please select a file first.', 'error');
                    return;
                }
            }
            
            // Show loading state
            uploadButtonText.textContent = isMeesho ? 'Merging & Analyzing...' : 'Analyzing...';
            uploadSpinner.classList.remove('hidden');
            uploadButton.disabled = true;
            
            // Prepare form data
            const formData = new FormData(uploadForm);
            
            // Add manual column mappings if provided
            const manualMappings = getManualColumnMappings();
            if (Object.keys(manualMappings).length > 0) {
                formData.append('manual_column_mapping', JSON.stringify(manualMappings));
            }
            
            // Add flag for Meesho merge operation
            if (isMeesho) {
                formData.append('merge_meesho_files', 'true');
            }
            
            // Send the request to the correct endpoint
            fetch('/business_analytics/api/upload/', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Update debug info
                if (requestStatus) {
                    requestStatus.textContent = 'Success: ' + (isMeesho ? 'Files merged and analyzed' : 'File uploaded and analyzed');
                }
                if (rawResponseDebug) {
                    rawResponseDebug.textContent = JSON.stringify(data, null, 2);
                }
                
                // Reset upload button state
                uploadButtonText.textContent = isMeesho ? 'Upload Both Files & Analyze' : 'Upload & Analyze';
                uploadSpinner.classList.add('hidden');
                uploadButton.disabled = false;
                
                if (data.success) {
                    // Show success message
                    showUploadStatus(isMeesho ? 'Files merged and analysis completed successfully!' : 'Analysis completed successfully!', 'success');
                    
                    // Check for column mapping issues
                    if (data.column_mapping_issues && data.column_mapping_issues.length > 0) {
                        displayColumnMappingIssues(data.column_mapping_issues);
                    }
                    
                    // Update column mapping form with available columns
                    if (data.available_columns && data.available_columns.length > 0) {
                        populateColumnMappingDropdowns(data.available_columns);
                        
                        // Set current mappings if available
                        if (data.column_mapping) {
                            setCurrentColumnMappings(data.column_mapping);
                        }
                    }
                    
                    // Display the results
                    displayAnalysisResults(data);
                    
                    // Close the upload modal after a short delay
                    setTimeout(() => {
                        uploadModal.classList.add('hidden');
                        
                        // Show analysis modal if there are results
                        if (data.analysis && analysisModal) {
                            analysisModal.classList.remove('hidden');
                        }
                        
                        // Update the dashboard with the new analysis
                        updateDashboard(data.analysis);
                    }, 1000);
                } else {
                    // Show error message
                    showUploadStatus(`Error: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (requestStatus) {
                    requestStatus.textContent = `Error: ${error.message}`;
                }
                if (rawResponseDebug) {
                    rawResponseDebug.textContent = error.toString();
                }
                
                // Reset upload button state
                uploadButtonText.textContent = isMeesho ? 'Upload Both Files & Analyze' : 'Upload & Analyze';
                uploadSpinner.classList.add('hidden');
                uploadButton.disabled = false;
                
                // Show error message
                showUploadStatus(`Error: ${error.message}`, 'error');
            });
        });
    }
});
</script>
{% endblock %} 