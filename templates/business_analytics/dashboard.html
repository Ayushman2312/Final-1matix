{% extends 'user_dashboard/base.html' %}
{% load static %}

{% block extrahead %}
<!-- Load Chart.js for visualizations -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
{% endblock %}

{% block content %}
<div class="w-full sm:py-6 md:py-2 font-[Quicksand] mb-10">
    <div class="bg-white rounded-[20px] shadow-[0_4px_16px_0_rgba(123,61,243,0.07)] p-4 sm:p-7 border border-[#F0EFFF] mb-6">
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
                <h2 class="font-bold text-base sm:text-lg text-[#232323] whitespace-nowrap" style="font-family: 'Montserrat', sans-serif;">
                    Business Analytics
                </h2>
            </div>
            <div class="flex items-center gap-2">
                <button 
                    id="calculateMetricsBtn"
                    class="text-[#7B3DF3] px-3 py-1.5 rounded-lg text-sm font-medium flex items-center hover:bg-[#F0EFFF] transition-colors duration-200 mr-2"
                    style="font-family: 'Montserrat', sans-serif;"
                    aria-label="Calculate Metrics">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                    </svg>
                    Calculate Metrics
                </button>
                <button 
                    id="uploadAnalyticsBtn"
                    class="text-[#7B3DF3] px-3 py-1.5 rounded-lg text-sm font-medium flex items-center hover:bg-[#F0EFFF] transition-colors duration-200"
                    style="font-family: 'Montserrat', sans-serif;"
                    aria-label="Upload Data">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                    </svg>
                    Upload Data
                </button>
            </div>
        </div>
        
        <!-- Debug information for template rendering -->
        <div id="debugInfo" class="bg-gray-100 p-2 rounded mb-4 text-xs font-mono">
            <div>Debug: Template rendered. Recent analysis: {% if recent_analysis %}Available (ID: {{ recent_analysis.id }}){% else %}Not available{% endif %}</div>
            {% if recent_analysis and recent_analysis.analysis_data %}
                <div>Analysis data available: Yes</div>
                <div>Time series data: {% if recent_analysis.analysis_data.time_series %}Available ({{ recent_analysis.analysis_data.time_series.labels|length }} periods){% else %}Not available{% endif %}</div>
            {% else %}
                <div>Analysis data available: No</div>
            {% endif %}
        </div>
        
        <div id="noAnalysisMessage" class="{% if recent_analysis %}hidden{% endif %} text-center py-8">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="text-gray-600 font-medium mb-2">No Analysis Data Yet</h3>
            <p class="text-gray-500 text-sm mb-4">Upload your sales data to see detailed analytics and insights</p>
            <button 
                id="uploadEmptyBtn"
                class="px-6 py-2 bg-[#7B3DF3] text-white rounded-lg text-sm font-medium hover:bg-[#6931D3] transition-all duration-300">
                Upload Sales Data
            </button>
        </div>
        
        <div id="analysisContent" class="{% if not recent_analysis %}hidden{% endif %}">
            <!-- Analysis content for the main dashboard -->
            {% if recent_analysis %}
            <div class="mb-6">
                <h4 class="text-lg font-semibold mb-3 text-gray-800">Sales Summary</h4>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4" id="dashboardSummaryCards">
                    <!-- Summary cards will be added here -->
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6" id="dashboardChartsContainer">
                <!-- Sales Trend Chart -->
                <div id="salesTrendContainer" class="bg-white rounded-lg shadow p-4 border border-gray-100 hidden">
                    <h4 class="text-sm font-semibold mb-3 text-gray-800">Sales Trend</h4>
                    <div class="h-60">
                        <canvas id="dashboardSalesTrendChart"></canvas>
                    </div>
                </div>
                
                <!-- Sales by Channel Chart -->
                <div id="salesChannelContainer" class="bg-white rounded-lg shadow p-4 border border-gray-100 hidden">
                    <h4 class="text-sm font-semibold mb-3 text-gray-800">Sales by Channel</h4>
                    <div class="h-60">
                        <canvas id="dashboardSalesChannelChart"></canvas>
                    </div>
                </div>
                
                <!-- Returns vs Cancellations Chart -->
                <div id="returnsVsCancellationsContainer" class="bg-white rounded-lg shadow p-4 border border-gray-100 hidden">
                    <h4 class="text-sm font-semibold mb-3 text-gray-800">Returns vs Cancellations</h4>
                    <div class="h-60">
                        <canvas id="returnsVsCancellationsChart"></canvas>
                    </div>
                </div>
                
                <!-- Sales by Category Chart -->
                <div id="salesByCategoryContainer" class="bg-white rounded-lg shadow p-4 border border-gray-100 hidden">
                    <h4 class="text-sm font-semibold mb-3 text-gray-800">Sales by Category</h4>
                    <div class="h-60">
                        <canvas id="salesByCategoryChart"></canvas>
                    </div>
                </div>
                
                <!-- Fallback chart container for when primary charts don't have data -->
                <div id="fallbackChartContainer" class="bg-white rounded-lg shadow p-4 border border-gray-100 hidden">
                    <h4 id="fallbackChartTitle" class="text-sm font-semibold mb-3 text-gray-800">Available Data</h4>
                    <div class="h-60">
                        <canvas id="fallbackChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="dashboardListsContainer">
                <!-- Top Products Container -->
                <div id="topProductsContainer" class="bg-white rounded-lg shadow p-4 border border-gray-100 hidden">
                    <h4 class="text-sm font-semibold mb-3 text-gray-800">Top 10 Products</h4>
                    <div id="dashboardTopProductsList" class="space-y-2">
                        <!-- Top products will be added here -->
                    </div>
                </div>
                
                <!-- Top Regions Container -->
                <div id="topRegionsContainer" class="bg-white rounded-lg shadow p-4 border border-gray-100 hidden">
                    <h4 class="text-sm font-semibold mb-3 text-gray-800">Top 10 Regions</h4>
                    <div id="dashboardTopRegionsList" class="space-y-2">
                        <!-- Top regions will be added here -->
                    </div>
                </div>
                
                <!-- Bottom Products Container -->
                <div id="bottomProductsContainer" class="bg-white rounded-lg shadow p-4 border border-gray-100 hidden">
                    <h4 class="text-sm font-semibold mb-3 text-gray-800">Bottom 10 Products</h4>
                    <div id="dashboardBottomProductsList" class="space-y-2">
                        <!-- Bottom products will be added here -->
                    </div>
                </div>
                
                <!-- Bottom Regions Container -->
                <div id="bottomRegionsContainer" class="bg-white rounded-lg shadow p-4 border border-gray-100 hidden">
                    <h4 class="text-sm font-semibold mb-3 text-gray-800">Bottom 10 Regions</h4>
                    <div id="dashboardBottomRegionsList" class="space-y-2">
                        <!-- Bottom regions will be added here -->
                    </div>
                </div>
                
                <!-- Region Heatmap Container -->
                <div id="regionHeatmapContainer" class="bg-white rounded-lg shadow p-4 border border-gray-100 hidden">
                    <h4 class="text-sm font-semibold mb-3 text-gray-800">Revenue by Region</h4>
                    <div id="regionHeatmap" class="h-60">
                        <!-- Heatmap will be added here -->
                    </div>
                </div>
                
                <!-- High Returns/Cancellations Container -->
                <div id="highReturnsContainer" class="bg-white rounded-lg shadow p-4 border border-gray-100 hidden">
                    <h4 class="text-sm font-semibold mb-3 text-gray-800">Products with High Returns/Cancellations</h4>
                    <div id="highReturnsList" class="space-y-2">
                        <!-- Products with high returns will be added here -->
                    </div>
                </div>
                
                <!-- Fallback list container for when primary lists don't have data -->
                <div id="fallbackListContainer" class="bg-white rounded-lg shadow p-4 border border-gray-100 hidden">
                    <h4 id="fallbackListTitle" class="text-sm font-semibold mb-3 text-gray-800">Available Data</h4>
                    <div id="fallbackList" class="space-y-2">
                        <!-- Fallback data will be added here -->
                    </div>
                </div>
                
                <!-- Data quality info container -->
                <div id="dataQualityContainer" class="bg-white rounded-lg shadow p-4 border border-gray-100 hidden">
                    <h4 class="text-sm font-semibold mb-3 text-gray-800">Data Quality Information</h4>
                    <div id="dataQualityContent" class="text-sm text-gray-600">
                        <!-- Data quality info will be added here -->
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Debug information section -->
    <div class="mt-6 bg-white rounded-[20px] shadow-[0_4px_16px_0_rgba(123,61,243,0.07)] p-4 sm:p-7 border border-[#F0EFFF]">
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
                <h2 class="font-bold text-base sm:text-lg text-[#232323] whitespace-nowrap" style="font-family: 'Montserrat', sans-serif;">
                    Debug Information
                </h2>
            </div>
            <button 
                id="toggleDebugBtn"
                class="text-[#7B3DF3] px-3 py-1.5 rounded-lg text-sm font-medium flex items-center hover:bg-[#F0EFFF] transition-colors duration-200"
                style="font-family: 'Montserrat', sans-serif;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Toggle
            </button>
        </div>
        
        <div id="debugInfoContainer" class="hidden">
            <!-- Response status info -->
            <div class="mb-3 bg-gray-50 p-3 rounded-md">
                <div class="text-sm font-medium text-gray-700 mb-1">Last Request Status:</div>
                <div id="requestStatus" class="text-xs text-gray-600">No requests made yet</div>
            </div>
            
            <!-- Analysis data debug info -->
            <div class="mb-3">
                <div class="text-sm font-medium text-gray-700 mb-1">Analysis Data:</div>
                <div id="debugInfo" class="text-xs"></div>
            </div>
            
            <!-- Raw response debug -->
            <div>
                <div class="text-sm font-medium text-gray-700 mb-1">Raw Response:</div>
                <pre id="rawResponseDebug" class="bg-gray-100 p-2 rounded-md text-xs overflow-auto max-h-40 whitespace-pre-wrap"></pre>
            </div>
        </div>
    </div>
</div>

<!-- Modal for displaying analysis results -->
<div id="analysisModal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
    <div class="absolute inset-0 bg-black opacity-50" id="analysisModalOverlay"></div>
    <div class="bg-white w-full max-w-4xl mx-4 rounded-xl shadow-xl z-10 max-h-[90vh] overflow-y-auto">
        <!-- Modal header -->
        <div class="flex items-center justify-between p-6 border-b">
            <h3 class="text-xl font-bold text-gray-900" id="analysisModalTitle">Analysis Results</h3>
            <button id="closeAnalysisModalBtn" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <!-- Modal content -->
        <div class="p-6">
            <!-- Column mapping info -->
            <div id="columnMappingSection" class="mb-6">
                <h4 class="text-lg font-semibold mb-3 text-gray-800">Column Mapping</h4>
                
                <!-- Column mapping issues alert -->
                <div id="modalColumnMappingIssues" class="hidden mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                    <h5 class="text-sm font-medium text-yellow-800 mb-2">Column Mapping Issues</h5>
                    <ul id="modalColumnMappingIssuesList" class="text-xs text-yellow-700 list-disc pl-5 space-y-1">
                        <!-- Column mapping issues will be added here -->
                    </ul>
                </div>
                
                <!-- Detected columns -->
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <div class="bg-gray-50 p-3 rounded-md">
                        <div class="text-sm font-medium text-gray-700">Sales Amount</div>
                        <div id="salesAmountMapping" class="text-xs text-gray-600 mt-1">Not detected</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-md">
                        <div class="text-sm font-medium text-gray-700">Order Date</div>
                        <div id="orderDateMapping" class="text-xs text-gray-600 mt-1">Not detected</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-md">
                        <div class="text-sm font-medium text-gray-700">Product Name/ID</div>
                        <div id="productNameMapping" class="text-xs text-gray-600 mt-1">Not detected</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-md">
                        <div class="text-sm font-medium text-gray-700">Customer Location</div>
                        <div id="customerLocationMapping" class="text-xs text-gray-600 mt-1">Not detected</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-md">
                        <div class="text-sm font-medium text-gray-700">Sales Channel</div>
                        <div id="salesChannelMapping" class="text-xs text-gray-600 mt-1">Not detected</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-md">
                        <div class="text-sm font-medium text-gray-700">Quantity</div>
                        <div id="quantityMapping" class="text-xs text-gray-600 mt-1">Not detected</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-md">
                        <div class="text-sm font-medium text-gray-700">Transaction Type</div>
                        <div id="transactionTypeMapping" class="text-xs text-gray-600 mt-1">Not detected</div>
                    </div>
                </div>
            </div>
            
            <div id="analysisContent" class="space-y-6">
                <!-- Analysis content will be inserted here dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
    <div class="absolute inset-0 bg-black bg-opacity-50" id="uploadModalOverlay"></div>
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4 relative z-10 overflow-hidden max-h-[85vh] overflow-y-auto">
        <!-- Modal Header -->
        <div class="bg-[#7B3DF3] py-1.5 px-4 flex justify-between items-center">
            <h3 class="text-white text-sm font-bold">Upload Sales Data</h3>
            <button id="closeUploadModal" class="text-white hover:text-gray-200 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <!-- Modal Content -->
        <div class="p-3">
            <div class="mb-2">
                <p class="text-xs text-gray-600 mb-1">Upload your marketplace sales data (CSV or Excel) for AI-powered analysis.</p>
                <div class="bg-gray-50 p-1.5 rounded-md text-xs text-gray-500 mb-1.5">
                    <p class="mb-0.5"><strong>Supported formats:</strong> CSV, XLSX, XLS</p>
                    <p class="mb-0.5"><strong>Recommended:</strong> At least 5 records for meaningful analysis.</p>
                    <p><strong>Tip:</strong> Include sales amount, dates, products for best results.</p>
                </div>
            </div>
            
            <form id="uploadForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="mb-2">
                    <label for="fileInput" class="block text-xs font-medium text-gray-700 mb-1">Select File</label>
                    <div class="flex items-center space-x-2">
                        <input type="file" id="fileInput" name="file" class="hidden" accept=".csv,.xlsx,.xls">
                        <label for="fileInput" class="cursor-pointer bg-white border border-gray-300 rounded-md py-1 px-2.5 text-xs font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-[#7B3DF3] focus:border-[#7B3DF3] flex-grow flex items-center justify-between">
                            <span id="selectedFileName">Choose file...</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" />
                            </svg>
                        </label>
                    </div>
                </div>
                
                <div class="mb-2">
                    <label for="platformType" class="block text-xs font-medium text-gray-700 mb-1">Marketplace Platform (Optional)</label>
                    <select id="platformType" name="platform_type" class="w-full bg-white border border-gray-300 rounded-md py-1 px-2.5 text-xs font-medium text-gray-700 focus:outline-none focus:ring-2 focus:ring-[#7B3DF3] focus:border-[#7B3DF3]">
                        <option value="">Auto-detect (Generic Analysis)</option>
                            <option value="amazon">Amazon</option>
                            <option value="flipkart">Flipkart</option>
                            <option value="meesho">Meesho</option>
                        </select>
                        </div>
                
                <div id="uploadStatus" class="hidden mb-2"></div>
                
                <div id="columnMappingIssuesContainer" class="hidden mb-2 p-1.5 bg-yellow-50 border border-yellow-200 rounded-md">
                    <h4 class="text-xs font-medium text-yellow-800 mb-1">Column Mapping Issues</h4>
                    <ul id="columnMappingIssuesList" class="text-xs text-yellow-700 list-disc pl-4 space-y-0.5">
                        <!-- Column mapping issues will be added here -->
                    </ul>
                    <div class="mt-1 text-xs text-yellow-600">
                        <p>These issues may affect the analysis quality. Consider remapping columns.</p>
                    </div>
                </div>
                
                <div class="flex items-center justify-between">
                    <button type="button" id="uploadButton" class="bg-[#7B3DF3] py-1 px-3 text-white text-xs font-medium rounded-md hover:bg-[#6931D3] focus:outline-none focus:ring-2 focus:ring-[#7B3DF3] focus:ring-opacity-50 transition-colors">
                        <span id="uploadButtonText">Upload & Analyze</span>
                        <span id="uploadSpinner" class="hidden ml-1 animate-spin">↻</span>
                    </button>
                    <button type="button" id="advancedOptionsBtn" class="text-xs text-gray-500 hover:text-[#7B3DF3] transition-colors">
                        Advanced Options
                    </button>
                </div>
            </form>
            
            <!-- Advanced Options Panel (hidden by default) -->
            <div id="advancedOptionsPanel" class="hidden mt-2 p-2 bg-gray-50 rounded-md border border-gray-200">
                <h4 class="text-xs font-medium text-gray-700 mb-1">Manual Column Mapping</h4>
                <div class="text-xs text-gray-500 mb-1">
                    If column detection isn't working correctly, manually select the appropriate columns below:
        </div>
                
                <!-- Auto-detect button -->
                <div class="mb-2">
                    <button type="button" id="autoDetectBtn" class="text-xs px-2 py-0.5 bg-blue-50 text-blue-600 border border-blue-200 rounded hover:bg-blue-100 transition-colors">
                        Auto-Detect Columns
                    </button>
                    <span class="text-xs text-gray-500 ml-1">Uses intelligent pattern matching</span>
                </div>
                
                <!-- Column Mapping Form -->
                <div id="columnMappingForm" class="space-y-1.5 p-1.5 bg-white rounded border border-gray-200">
                    <div class="grid grid-cols-2 gap-1.5">
                        <label class="text-xs text-gray-600 font-medium">Sales Amount <span class="text-red-500">*</span></label>
                        <select id="salesAmountColumn" class="text-xs border border-gray-300 rounded p-0.5 w-full">
                            <option value="">Auto-detect</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-1.5">
                        <label class="text-xs text-gray-600 font-medium">Order Date <span class="text-red-500">*</span></label>
                        <select id="orderDateColumn" class="text-xs border border-gray-300 rounded p-0.5 w-full">
                            <option value="">Auto-detect</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-1.5">
                        <label class="text-xs text-gray-600 font-medium">Product Name/ID <span class="text-red-500">*</span></label>
                        <select id="productColumn" class="text-xs border border-gray-300 rounded p-0.5 w-full">
                            <option value="">Auto-detect</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-1.5">
                        <label class="text-xs text-gray-600 font-medium">Customer Location</label>
                        <select id="locationColumn" class="text-xs border border-gray-300 rounded p-0.5 w-full">
                            <option value="">Auto-detect</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-1.5">
                        <label class="text-xs text-gray-600 font-medium">Quantity</label>
                        <select id="quantityColumn" class="text-xs border border-gray-300 rounded p-0.5 w-full">
                            <option value="">Auto-detect</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-1.5">
                        <label class="text-xs text-gray-600 font-medium">Transaction Type</label>
                        <select id="transactionTypeColumn" class="text-xs border border-gray-300 rounded p-0.5 w-full">
                            <option value="">Auto-detect</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                </div>
                <div class="mt-1 text-xs text-gray-500">
                    <p>Fields marked with <span class="text-red-500">*</span> are required for basic analysis.</p>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="{% static 'js/business_analytics/analysis.js' %}?v=2"></script>
<script src="{% static 'js/business_analytics/meesho_handling.js' %}?v=2"></script>
<script src="{% static 'js/business_analytics/enhanced_charts.js' %}?v=2"></script>
{% endblock %} 