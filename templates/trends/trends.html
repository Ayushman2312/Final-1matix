{% extends 'user_dashboard/base.html' %}
{% load static %}
{% block title %}TrendIQ Analysis{% endblock %}

{% block content %}
<h1 class="text-2xl bg-gradient-to-r from-blue-600 to-blue-400 bg-clip-text text-transparent" style="font-weight:800;">Welcome to the TrendIQ</h1>

<!-- Test Buttons Section -->
<div class="flex gap-3 mb-4 mt-2">
    <button id="testAnalysisBtn" class="neumorphic-button px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-400 text-white font-medium rounded-xl hover:shadow-lg transition-all duration-300">
        Test Analysis Popup
    </button>
    <button id="testRecommendationBtn" class="neumorphic-button px-4 py-2 bg-gradient-to-r from-indigo-600 to-indigo-400 text-white font-medium rounded-xl hover:shadow-lg transition-all duration-300">
        Test Recommendation Popup
    </button>
</div>

<div class="py-4">
    <div>
        <!-- Top Search Section -->
        <div class="m-2 bg-white p-3 rounded-2xl shadow-[0_0_7px_rgba(0,0,0,0.1)]">
            <div class="w-full">
                <!-- Main Search Container -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 md:grid-cols-3 gap-4 lg:gap-6 items-stretch">
                    
                    <!-- Search Input Container - Takes full width on mobile, half on larger screens -->
                    <div class="relative col-span-1 sm:col-span-2 md:col-span-2 transition-all duration-300">
                        <div class="neumorphic-input-container h-full">
                            <div class="absolute inset-y-0 left-0 pl-6 flex items-center pointer-events-none">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <input type="text" 
                                   id="keywordInput" 
                                   class="w-full m-2 pl-10 pr-4 py-2.5 bg-gray-50 border-[3px] border-light-blue rounded-xl focus:ring-2 focus:ring-blue-500 transition-all duration-300 hover:shadow-sm" 
                                   placeholder="Enter your search query">
                            <button id="testPdfBtn" 
                                    class="absolute right-3 top-1/2 transform -translate-y-1/2 px-3 py-1.5 bg-indigo-100 text-indigo-700 text-xs font-medium rounded-lg hover:bg-indigo-200 transition-colors"
                                    title="Generate test PDF with demo content">
                                Test PDF
                            </button>
                        </div>
                    </div>
                    
                    <!-- Options and Submit Container -->
                    <div class="flex flex-col sm:flex-row md:flex-col lg:flex-row gap-3 col-span-1 sm:col-span-2 md:col-span-1 lg:col-span-2 h-full">
                        <!-- Business Intent Select -->
                        <div class="neumorphic-select-container m-2 relative flex-1 min-w-[200px]">
                            <select id="business_intent" 
                                    class="neumorphic-select w-full pl-4 pr-10 py-2.5 bg-gray-50 border-0 rounded-xl appearance-none focus:ring-2 focus:ring-blue-500 transition-all duration-300" 
                                    required>
                                <option value="" class="text-gray-500">Select your intent</option>
                                <option value="yes">I want to start a business</option>
                                <option value="no">I'm already in business</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Submit Button -->
                        <button id="analyzeButton" 
                                class="neumorphic-button m-2 flex-1 px-6 py-2.5 bg-gradient-to-r from-blue-600 to-blue-500 text-white font-medium rounded-xl hover:shadow-blue-500/20 hover:shadow-lg active:scale-[0.98] transition-all duration-300 min-w-[140px]">
                            <span class="flex items-center justify-center gap-2">
                                Submit & Analyze
                            </span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Business Details Fields (initially hidden) -->
            <div id="businessDetailsContainer" class=" hidden">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="neumorphic-input-container">
                        <input type="text" id="brandName" class="w-full m-2 pl-4 pr-4 py-3 bg-gray-50 border-[3px] border-light-blue rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="Brand Name" required>
                    </div>
                    <div class="neumorphic-input-container">
                        <input type="text" id="businessWebsite" class="w-full m-2 pl-4 pr-4 py-3 bg-gray-50 border-[3px] border-light-blue rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="https://www.example.com">
                    </div>
                    <div class="neumorphic-select-container relative w-full">
                        {% comment %} <label class="block text-gray-700 mb-2">Choose Your Marketplaces (select multiple)</label> {% endcomment %}
                        <div class="relative m-2">
                            <button id="marketplaceDropdownBtn" class="w-full bg-gray-50 p-3 rounded-xl border-[3px] border-light-blue flex justify-between items-center">
                                <span class="selected-count">Choose Your Marketplaces</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 transition-transform duration-300" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <div id="marketplaceDropdown" class="absolute z-50 w-full mt-2 bg-white rounded-xl shadow-lg border border-gray-200 hidden transform transition-all duration-300 ease-in-out">
                                <div class="p-3 grid grid-cols-1 gap-2 max-h-60 overflow-y-auto scrollbar-hide">
                                    <div class="flex items-center p-2 hover:bg-gray-50 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" id="marketplace-amazon" name="marketplace" value="amazon" class="marketplace-checkbox w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 cursor-pointer">
                                        <label for="marketplace-amazon" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer select-none w-full">Amazon</label>
                                    </div>
                                    <div class="flex items-center p-2 hover:bg-gray-50 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" id="marketplace-meesho" name="marketplace" value="meesho" class="marketplace-checkbox w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 cursor-pointer">
                                        <label for="marketplace-meesho" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer select-none w-full">Meesho</label>
                                    </div>
                                    <div class="flex items-center p-2 hover:bg-gray-50 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" id="marketplace-shopify" name="marketplace" value="shopify" class="marketplace-checkbox w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 cursor-pointer">
                                        <label for="marketplace-shopify" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer select-none w-full">Shopify</label>
                                    </div>
                                    <div class="flex items-center p-2 hover:bg-gray-50 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" id="marketplace-flipkart" name="marketplace" value="flipkart" class="marketplace-checkbox w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 cursor-pointer">
                                        <label for="marketplace-flipkart" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer select-none w-full">Flipkart</label>
                                    </div>
                                    <div class="flex items-center p-2 hover:bg-gray-50 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" id="marketplace-indiamart" name="marketplace" value="indiamart" class="marketplace-checkbox w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 cursor-pointer">
                                        <label for="marketplace-indiamart" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer select-none w-full">IndiaMART</label>
                                    </div>
                                    <div class="flex items-center p-2 hover:bg-gray-50 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" id="marketplace-jiomart" name="marketplace" value="jiomart" class="marketplace-checkbox w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 cursor-pointer">
                                        <label for="marketplace-jiomart" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer select-none w-full">JioMart</label>
                                    </div>
                                    <div class="flex items-center p-2 hover:bg-gray-50 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" id="marketplace-other" name="marketplace" value="other" class="marketplace-checkbox w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 cursor-pointer">
                                        <label for="marketplace-other" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer select-none w-full">Other</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Hidden input to store selected values -->
                        <input type="hidden" id="marketplace" value="">
                        <style>
                            .scrollbar-hide::-webkit-scrollbar {
                                display: none;
                            }
                            .scrollbar-hide {
                                -ms-overflow-style: none;
                                scrollbar-width: none;
                            }
                        </style>
                    </div>
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            const dropdownBtn = document.getElementById('marketplaceDropdownBtn');
                            const dropdown = document.getElementById('marketplaceDropdown');
                            const checkboxes = document.querySelectorAll('.marketplace-checkbox');
                            const selectedCountSpan = document.querySelector('.selected-count');
                            
                            // Toggle dropdown visibility
                            dropdownBtn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                dropdown.classList.toggle('hidden');
                                const isOpen = !dropdown.classList.contains('hidden');
                                dropdownBtn.querySelector('svg').style.transform = isOpen ? 'rotate(180deg)' : '';
                                
                                if(isOpen) {
                                    dropdown.style.opacity = '1';
                                    dropdown.style.transform = 'scale(1)';
                                } else {
                                    dropdown.style.opacity = '0';
                                    dropdown.style.transform = 'scale(0.95)';
                                }
                            });
                            
                            function updateSelectedCount() {
                                const selectedCount = [...checkboxes].filter(cb => cb.checked).length;
                                selectedCountSpan.textContent = selectedCount === 0 ? 'No marketplaces selected' : 
                                                              `${selectedCount} marketplace${selectedCount > 1 ? 's' : ''} selected`;
                            }
                            
                            checkboxes.forEach(checkbox => {
                                checkbox.addEventListener('change', function(e) {
                                    e.stopPropagation();
                                    updateSelectedCount();
                                });
                                
                                // Make the entire div clickable for checkbox
                                checkbox.parentElement.addEventListener('click', function(e) {
                                    if (e.target !== checkbox) {
                                        checkbox.checked = !checkbox.checked;
                                        updateSelectedCount();
                                    }
                                });
                            });
                            
                            // Close dropdown when clicking outside
                            document.addEventListener('click', function(e) {
                                if (!dropdownBtn.contains(e.target) && !dropdown.contains(e.target)) {
                                    dropdown.classList.add('hidden');
                                    dropdownBtn.querySelector('svg').style.transform = '';
                                    dropdown.style.opacity = '0';
                                    dropdown.style.transform = 'scale(0.95)';
                                }
                            });
                            
                            // Handle responsive behavior
                            function adjustDropdownPosition() {
                                const btnRect = dropdownBtn.getBoundingClientRect();
                                const viewportHeight = window.innerHeight;
                                
                                if (btnRect.bottom + dropdown.offsetHeight > viewportHeight) {
                                    dropdown.style.top = 'auto';
                                    dropdown.style.bottom = '100%';
                                    dropdown.style.marginTop = '0';
                                    dropdown.style.marginBottom = '8px';
                                } else {
                                    dropdown.style.top = '100%';
                                    dropdown.style.bottom = 'auto';
                                    dropdown.style.marginTop = '8px';
                                    dropdown.style.marginBottom = '0';
                                }
                            }
                            
                            window.addEventListener('resize', adjustDropdownPosition);
                            dropdownBtn.addEventListener('click', adjustDropdownPosition);
                        });
                    </script>
                </div>
            </div>
            
            <!-- Hidden fields with default values -->
            <input type="hidden" id="timeframeSelect" name="timeframe" value="today 5-y">
            <input type="hidden" id="regionSelect" name="geo" value="IN">
            <!-- Hidden field to store PageSpeed Insights data -->
            <input type="hidden" id="pagespeedData" name="pagespeed_data" value="">
            
            <!-- PageSpeed Preview Container -->
            <div id="pagespeed-preview" class="mt-4 hidden"></div>
        </div>
        
        <!-- Results Section -->
        <div id="resultsContainer" class="grid grid-cols-1 lg:grid-cols-3" style="display: none;">
            <!-- Graph Panel - Fixed Height, Not Scrollable -->
            <div class="lg:col-span-2 bg-transparent rounded-xl p-6 sticky-chart">
                <h2 class="text-xl font-bold text-transparent bg-gradient-to-r from-blue-600 to-blue-400 bg-clip-text mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 3a1 1 0 000 2h14a1 1 0 100-2H3zm0 6a1 1 0 000 2h9a1 1 0 100-2H3zm0 6a1 1 0 100 2h5a1 1 0 100-2H3z" clip-rule="evenodd" />
                    </svg>
                    Trend Visualization
                </h2>
                <div id="chartContainer" class="relative h-96 mb-4 rounded-xl bg-gradient-to-br from-gray-50 to-gray-100 p-3">
                    <canvas id="trendsChart"></canvas>
                </div>
                
                <!-- Regional Analysis Chart Panel -->
                <div id="regionChartContainer" class="lg:col-span-2 neumorphic-card bg-white rounded-xl p-6 hover:shadow-xl transition-shadow duration-300 mt-6" style="display: none;">
                    <h2 class="text-xl font-bold text-transparent bg-gradient-to-r from-blue-600 to-blue-400 bg-clip-text mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm0 6a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2zm0 6a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2z" clip-rule="evenodd" />
                        </svg>
                        Regional Interest
                    </h2>
                    <div id="regionChartWrapper" class="relative h-96 mb-4 rounded-xl neumorphic-chart-container bg-gradient-to-br from-gray-50 to-gray-100 p-3">
                        <canvas id="regionChart"></canvas>
                    </div>
                    
                    <!-- Region Chart Settings -->
                    <div class="flex flex-wrap gap-2 mt-4 justify-between items-center">
                        <div class="flex gap-2">
                            <button id="sortByValueBtn" class="region-sort-btn neumorphic-tag-button px-3 py-1.5 hover:bg-blue-500/20 hover:border-blue-500" data-sort="value">Sort by Value</button>
                            <button id="sortByNameBtn" class="region-sort-btn neumorphic-tag-button px-3 py-1.5 hover:bg-blue-500/20 hover:border-blue-500" data-sort="name">Sort by Name</button>
                        </div>
                        <div>
                            <div class="neumorphic-select-container">
                                <select id="regionLimitSelect" class="neumorphic-select px-3 py-1.5 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 appearance-none pr-8">
                                    <option value="10">Top 10 Regions</option>
                                    <option value="15">Top 15 Regions</option>
                                    <option value="20">Top 20 Regions</option>
                                    <option value="all">All Regions</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chart Filters -->
                <div class="flex flex-wrap gap-2 mt-4">
                    <button class="time-unit-btn neumorphic-tag-button px-3 py-1.5 hover:bg-blue-500/20 hover:border-blue-500 transition-all duration-200" data-unit="day">Daily</button>
                    <button class="time-unit-btn neumorphic-tag-button px-3 py-1.5 hover:bg-blue-500/20 hover:border-blue-500 transition-all duration-200" data-unit="week">Weekly</button>
                    <button class="time-unit-btn neumorphic-tag-button px-3 py-1.5 hover:bg-blue-500/20 hover:border-blue-500 transition-all duration-200 bg-blue-500/20 border-blue-500" data-unit="month">Monthly</button>
                    <button class="time-unit-btn neumorphic-tag-button px-3 py-1.5 hover:bg-blue-500/20 hover:border-blue-500 transition-all duration-200" data-unit="quarter">Quarterly</button>
                    <button class="time-unit-btn neumorphic-tag-button px-3 py-1.5 hover:bg-blue-500/20 hover:border-blue-500 transition-all duration-200" data-unit="year">Yearly</button>
                    
                    <!-- Yearly Filter Dropdown (initially hidden) -->
                    <div id="yearlyFilterContainer" class="hidden ml-2">
                        <div class="neumorphic-select-container relative">
                            <select id="yearlyFilter" class="neumorphic-select px-3 py-1.5 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 appearance-none pr-8">
                                <option value="all">All Years</option>
                                <!-- Years will be populated dynamically -->
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analysis and Recommendation - Scrollable Section -->
            <div class="lg:col-span-1 mt-2 flex flex-col gap-0 right-panel">
                <!-- Analysis Panel -->
                <div class="rounded-xl p-6">
                    <h2 class="text-xl font-bold text-transparent bg-gradient-to-r from-blue-600 to-blue-400 bg-clip-text mb-4 flex items-center justify-between">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                            </svg>
                            Analysis
                            <span id="aiAnalysisIndicator" class="ml-2 hidden px-2 py-0.5 text-xs font-medium rounded-full bg-gradient-to-r from-blue-500 to-blue-400 text-white shadow-sm">AI</span>
                        </div>
                        <button class="expand-btn text-blue-500 text-sm flex items-center font-medium hover:text-blue-600 transition-colors" data-target="analysisContent">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 8V7a5 5 0 0110 0v1h1a2 2 0 012 2v7a2 2 0 01-2 2H6a2 2 0 01-2-2v-7a2 2 0 012-2h1zm5-3a3 3 0 00-3 3v1h6V8a3 3 0 00-3-3z" clip-rule="evenodd" />
                            </svg>
                            Expand
                        </button>
                    </h2>
                    <div id="analysisContent" class="rounded-xl p-6 prose prose-sm max-w-none shadow-[0_0px_5px_rgba(0,0,0,0.1)] leading-relaxed overflow-y-auto scrollable-content neumorphic-content">
                        <!-- Analysis content will be populated by AI -->
                        <div class="flex items-center justify-center p-6 text-gray-500 text-sm italic">
                            Trend analysis will appear here after search
                        </div>
                    </div>
                </div>
                
                <!-- Recommendation Panel -->
                <div class="rounded-xl p-6">
                    <h2 class="text-xl font-bold text-transparent bg-gradient-to-r from-blue-600 to-blue-400 bg-clip-text mb-4 flex items-center justify-between">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
                            </svg>
                            Recommendation
                            <span id="aiRecommendationIndicator" class="ml-2 hidden px-2 py-0.5 text-xs font-medium rounded-full bg-gradient-to-r from-blue-500 to-blue-400 text-white shadow-sm">AI</span>
                        </div>
                        <button class="expand-btn text-blue-500 text-sm flex items-center font-medium hover:text-blue-600 transition-colors" data-target="recommendationContent">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 8V7a5 5 0 0110 0v1h1a2 2 0 012 2v7a2 2 0 01-2 2H6a2 2 0 01-2-2v-7a2 2 0 012-2h1zm5-3a3 3 0 00-3 3v1h6V8a3 3 0 00-3-3z" clip-rule="evenodd" />
                            </svg>
                            Expand
                        </button>
                    </h2>
                    <div id="recommendationContent" class="rounded-xl p-6 prose prose-sm max-w-none shadow-[0_0px_5px_rgba(0,0,0,0.1)] leading-relaxed overflow-y-auto scrollable-content neumorphic-content">
                        <!-- Recommendation content will be populated by AI -->
                        <div class="flex items-center justify-center p-6 text-gray-500 text-sm italic">
                            Trend recommendations will appear here after search
                        </div>
                    </div>
                </div>
                
                <!-- Download Results Button (initially hidden) -->
                <div id="downloadButtonContainer" class="mt-6 hidden">
                    <button id="downloadReportBtn" class="neumorphic-button w-full py-3 px-4 bg-gradient-to-r from-indigo-600 to-indigo-500 text-white font-medium rounded-xl hover:shadow-indigo-500/20 hover:shadow-lg transition-all flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        Download Report as PDF
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="flex flex-col items-center justify-center py-12 mb-8 rounded-2xl" style="display: none;">
            <div class="relative w-24 h-24 mb-4">
                <!-- Matrix-like digit animation container -->
                <div class="absolute inset-0 overflow-hidden rounded-full neumorphic-circle border-2 border-blue-400">
                    <div class="matrix-digits absolute inset-0 flex items-center justify-center">
                        {% comment %} <span class="text-[#27FFB4] font-mono text-xs opacity-80">10110101</span> {% endcomment %}
                    </div>
                </div>
                <!-- Pulsing outer ring -->
                <div class="absolute inset-0 rounded-full border-4 border-blue-500/30 animate-pulse"></div>
                <!-- Spinning inner circle -->
                <div class="absolute inset-2 rounded-full border-t-4 border-blue-500 animate-spin"></div>
                <!-- 1Matrix logo/text in center -->
                <div class="absolute inset-0 flex items-center justify-center">
                    <span class="text-blue-600 font-bold text-xl"></span>
                </div>
            </div>
            <p class="text-blue-500 font-medium text-center">Analyzing trends data<span class="dots-animation">...</span></p>
            <div class="w-64 h-2 bg-gray-200 rounded-full mt-4 overflow-hidden neumorphic-progress-container">
                <div class="h-full bg-gradient-to-r from-blue-600 via-blue-400 to-blue-300 rounded-full loading-progress"></div>
            </div>
        </div>
        
        <!-- Error Container -->
        <div id="errorContainer" class="neumorphic-error bg-white border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-xl shadow-lg hidden max-w-3xl mx-auto">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm" id="errorMessage"></p>
                </div>
                <div class="ml-auto pl-3">
                    <div class="-mx-1.5 -my-1.5">
                        <button type="button" class="inline-flex rounded-md p-1.5 text-red-500 hover:bg-red-200 focus:outline-none neumorphic-tag-button-small" onclick="document.getElementById('errorContainer').style.display='none'">
                            <span class="sr-only">Dismiss</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Expand Modal -->
<div id="expandModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col transform transition-all">
        <!-- Modal Header -->
        <div class="flex items-center justify-between">
            <h3 id="modalTitle" class="text-xl font-bold text-transparent bg-gradient-to-r from-blue-600 to-blue-400 bg-clip-text hidden"></h3>
        </div>
        <div class="flex items-center justify-end px-6 py-4">
            <button id="closeModal" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <!-- Modal Content -->
        <div id="modalContent" class="px-6 overflow-y-auto flex-grow">
            <!-- Content will be populated dynamically -->
        </div>
    </div>
</div>

<style>
    /* Neumorphic Styles */
    .neumorphic-card {
        background: #f0f4f8;
        box-shadow: 10px 10px 20px rgba(166, 180, 200, 0.25), 
                   -10px -10px 20px rgba(255, 255, 255, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
    }
    
    .neumorphic-card:hover {
        box-shadow: 12px 12px 24px rgba(166, 180, 200, 0.3), 
                   -12px -12px 24px rgba(255, 255, 255, 0.6);
    }
    
    .neumorphic-input-container, .neumorphic-select-container {
        position: relative;
    }
    
    /* Enhanced select styles for more professional appearance */
    .neumorphic-select {
        background: linear-gradient(175deg, #f8fafc, #eef2f7);
        border: 1px solid rgba(255, 255, 255, 0.9);
        box-shadow: 0 2px 6px rgba(71, 85, 105, 0.08), 0 1px 3px rgba(100, 116, 139, 0.05);
        border-radius: 12px;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        color: #334155;
        appearance: none;
        padding-right: 2.5rem;
    }
    
    .neumorphic-input {
        background: linear-gradient(175deg, #f8fafc, #eef2f7);
        border: 1px solid rgba(255, 255, 255, 0.9);
        transition: all 0.3s ease;
    }
    
    .neumorphic-input:focus {
        box-shadow: inset 2px 2px 5px rgba(166, 180, 200, 0.25), 
                    inset -2px -2px 5px rgba(255, 255, 255, 0.9),
                    0 0 0 3px rgba(59, 130, 246, 0.25);
        outline: none;
    }
    
    .neumorphic-select:focus {
        box-shadow: 0 4px 12px rgba(56, 114, 224, 0.15), 0 0 0 2px rgba(59, 130, 246, 0.2);
        border-color: rgba(59, 130, 246, 0.6);
        outline: none;
        transform: translateY(-1px);
    }
    
    .neumorphic-select:hover {
        box-shadow: 0 3px 8px rgba(71, 85, 105, 0.1);
        transform: translateY(-1px);
    }
    
    /* Enhanced styling for dropdown options */
    .neumorphic-select option {
        background-color: white;
        padding: 12px 16px;
        font-weight: 500;
        color: #334155;
        border-radius: 8px;
        margin: 4px 0;
    }
    
    .neumorphic-select option:checked {
        background-color: rgba(59, 130, 246, 0.08);
        color: #3b82f6;
    }
    
    .neumorphic-select option:hover {
        background-color: rgba(59, 130, 246, 0.04);
    }
    
    /* Elegant dropdown arrow styling */
    .neumorphic-select-container::after {
        content: '';
        position: absolute;
        right: 16px;
        top: 50%;
        width: 10px;
        height: 10px;
        border-bottom: 2px solid #64748b;
        border-right: 2px solid #64748b;
        transform: translateY(-70%) rotate(45deg);
        pointer-events: none;
        transition: all 0.2s ease;
    }
    
    .neumorphic-select-container:hover::after {
        border-color: #3b82f6;
    }
    
    /* Custom select style for dropdown to match professional design */
    .neumorphic-select-container select {
        appearance: none;
        width: 100%;
        padding: 12px 18px;
        background-color: #f8fafc;
        border-radius: 12px;
        border: 1px solid rgba(226, 232, 240, 0.8);
        box-shadow: 0 2px 6px rgba(71, 85, 105, 0.08);
        font-size: 14.5px;
        color: #334155;
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        outline: none;
    }
    
    /* Styling for placeholder options */
    .neumorphic-select-container select option[value=""] {
        color: #94a3b8;
        font-style: italic;
    }
    
    /* Enhanced selected option styling */
    .neumorphic-select-container select.selected {
        background-color: #f1f5fd;
        border-color: #3b82f6;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
    }
    
    /* States for the select element */
    .neumorphic-select-container select:focus {
        border-color: #3b82f6;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15), 0 0 0 2px rgba(59, 130, 246, 0.15);
        transform: translateY(-1px);
    }
    
    .neumorphic-select-container select:hover {
        background-color: #f8fafc;
        border-color: rgba(59, 130, 246, 0.4);
        box-shadow: 0 3px 8px rgba(71, 85, 105, 0.1);
        transform: translateY(-1px);
    }
    
    /* Media queries for responsiveness */
    @media (max-width: 768px) {
        .grid.grid-cols-1.md\:grid-cols-3 {
            grid-template-columns: 1fr;
        }
        
        .flex.gap-4 {
            flex-direction: column;
        }
        
        .neumorphic-select-container {
            margin-bottom: 12px;
            width: 100%;
        }
        
        #analyzeButton {
            width: 100%;
        }
        
        .neumorphic-select-container select {
            padding: 12px 16px;
        }
    }
    
    @media (max-width: 640px) {
        .neumorphic-select-container select {
            font-size: 14px;
            padding: 10px 14px;
        }
        
        .neumorphic-select-container::after {
            right: 14px;
            width: 8px;
            height: 8px;
        }
    }
    
    @media (max-width: 640px) {
        .neumorphic-select {
            font-size: 13px;
        }
    }
    
    /* Original styles continue below */
    @keyframes matrixRain {
        0% { transform: translateY(-100%); }
        100% { transform: translateY(100%); }
    }
    .matrix-digits {
        animation: matrixRain 3s linear infinite;
    }
    .dots-animation {
        animation: dots 1.5s infinite;
    }
    @keyframes dots {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60%, 100% { content: '...'; }
    }
    .loading-progress {
        width: 30%;
        animation: progress 2s ease-in-out infinite alternate;
    }
    @keyframes progress {
        0% { width: 5%; }
        100% { width: 95%; }
    }
    
    /* Chart animation and styling */
    #chartContainer {
        box-shadow: 0 0 5px rgba(0,0,0,0.1);
        transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
    }
    
    /* Button animations */
    .time-unit-btn {
        transition: all 0.2s ease-in-out;
    }
    .time-unit-btn:hover {
        transform: translateY(-1px);
    }
    .time-unit-btn:active {
        transform: translateY(1px);
    }
    
    /* AI Content Styling */
    .ai-content p {
        margin-bottom: 0.75rem;
        line-height: 1.6;
    }
    
    .ai-content strong {
        color: #4b5563;
        font-weight: 600;
    }
    
    .ai-content ol {
        margin-left: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .ai-content li {
        margin-bottom: 0.5rem;
    }
    
    .ai-content h3 {
        margin-top: 1rem;
        margin-bottom: 1.5rem;
        font-weight: 600;
        color: #1f2937;
    }
    
    /* Recommendation styling */
    .ai-content ol li div.font-medium {
        font-weight: 600;
        color: #7e22ce;
        margin-bottom: 0.25rem;
    }
    
    /* Animation for content transition */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
        animation: fadeIn 0.5s ease-out forwards;
    }
    
    /* Yearly filter styling */
    #yearlyFilterContainer {
        transition: all 0.3s ease-in-out;
    }
    
    #yearlyFilter {
        min-width: 120px;
        background-color: white;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%2327FFB4'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.5rem center;
        background-size: 1.25em 1.25em;
        padding-right: 2rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    #yearlyFilter:focus {
        border-color: #27FFB4;
        box-shadow: 0 0 0 2px rgba(39, 255, 180, 0.2);
        outline: none;
    }
    
    #yearlyFilter option {
        padding: 0.5rem;
    }
    
    /* Apply fade-in animation to the dropdown */
    #yearlyFilterContainer.fade-in {
        animation: fadeIn 0.3s ease-out forwards;
    }
    
    /* Sticky Chart and Scrollable Content Styles */
    .sticky-chart {
        position: sticky;
        top: 1.5rem;
        height: fit-content;
        z-index: 10;
        transition: all 0.3s ease;
    }
    
    .scrollable-content {
        max-height: calc(100vh - 15rem);
        overscroll-behavior: contain;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
        padding-right: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .scrollable-content::-webkit-scrollbar {
        width: 5px;
    }
    
    .scrollable-content::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .scrollable-content::-webkit-scrollbar-thumb {
        background-color: rgba(156, 163, 175, 0.5);
        border-radius: 9999px;
    }
    
    .scrollable-content::-webkit-scrollbar-thumb:hover {
        background-color: rgba(156, 163, 175, 0.7);
    }
    
    .right-panel {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    /* Responsive adjustments */
    @media (max-width: 1024px) {
        .sticky-chart {
            position: relative;
            top: 0;
        }
        
        #resultsContainer {
            gap: 1.5rem;
        }
    }
    
    @media (max-width: 768px) {
        .matrix-digits span { font-size: 0.6rem; }
        .ai-content { font-size: 0.9rem; }
        
        #resultsContainer {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .sticky-chart {
            margin-bottom: 1rem;
        }
    }
    
    /* When analysis and recommendation content is small, limit scrolling */
    .right-panel.has-small-content .scrollable-content {
        overflow-y: visible;
        max-height: none;
    }
    
    /* Neumorphic Progress Bar */
    .neumorphic-progress-container {
        box-shadow: inset 2px 2px 5px rgba(166, 180, 200, 0.5),
                    inset -2px -2px 5px rgba(255, 255, 255, 0.5);
    }
    
    /* Neumorphic Animated Circle */
    .neumorphic-circle {
        background: linear-gradient(145deg, #f0f4f8, #ffffff);
        box-shadow: 6px 6px 12px rgba(166, 180, 200, 0.4),
                   -6px -6px 12px rgba(255, 255, 255, 0.8),
                   inset 1px 1px 2px rgba(255, 255, 255, 0.3);
    }
    
    /* Neumorphic Chart Container */
    .neumorphic-chart-container {
        box-shadow: inset 2px 2px 5px rgba(166, 180, 200, 0.3),
                    inset -2px -2px 5px rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.7);
    }
    
    /* Neumorphic Tag Buttons */
    .neumorphic-tag-button {
        background: linear-gradient(145deg, #f0f4f8, #ffffff);
        box-shadow: 2px 2px 4px rgba(166, 180, 200, 0.3),
                   -2px -2px 4px rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.8);
        border-radius: 0.5rem;
        transition: all 0.2s ease;
    }
    
    .neumorphic-tag-button:hover {
        transform: translateY(-1px);
        box-shadow: 3px 3px 6px rgba(166, 180, 200, 0.4),
                   -3px -3px 6px rgba(255, 255, 255, 0.9);
    }
    
    .neumorphic-tag-button:active {
        transform: translateY(1px);
        box-shadow: 1px 1px 2px rgba(166, 180, 200, 0.4),
                   -1px -1px 2px rgba(255, 255, 255, 0.7),
                   inset 1px 1px 2px rgba(166, 180, 200, 0.2);
    }
    
    /* Neumorphic Content Area */
    .neumorphic-content {
        background-color: #f8fafc;
        border-radius: 0.5rem;
        padding: 0.75rem;
        box-shadow: inset 1px 1px 3px rgba(166, 180, 200, 0.2),
                    inset -1px -1px 3px rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.5);
    }
    
    /* Neumorphic Error Container */
    .neumorphic-error {
        background: linear-gradient(145deg, #fff5f5, #fee2e2);
        box-shadow: 4px 4px 8px rgba(166, 180, 200, 0.3),
                   -4px -4px 8px rgba(255, 255, 255, 0.8);
        border-left: 4px solid #ef4444;
        transition: all 0.3s ease;
    }
    
    .neumorphic-tag-button-small {
        background: linear-gradient(145deg, #fee2e2, #fff5f5);
        box-shadow: 1px 1px 2px rgba(166, 180, 200, 0.2),
                   -1px -1px 2px rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.8);
        border-radius: 0.25rem;
        transition: all 0.2s ease;
    }
    
    .neumorphic-tag-button-small:hover {
        transform: translateY(-1px);
        box-shadow: 2px 2px 4px rgba(166, 180, 200, 0.3),
                   -2px -2px 4px rgba(255, 255, 255, 0.8);
    }
    
    .neumorphic-tag-button-small:active {
        transform: translateY(1px);
        box-shadow: inset 1px 1px 2px rgba(166, 180, 200, 0.2),
                    inset -1px -1px 2px rgba(255, 255, 255, 0.5);
    }
    
    /* Neumorphic Button */
    .neumorphic-button {
        box-shadow: 4px 4px 10px rgba(166, 180, 200, 0.5), 
                   -4px -4px 10px rgba(255, 255, 255, 0.8),
                   inset 1px 1px 1px rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(59, 130, 246, 0.3);
        transition: all 0.3s ease;
    }
    
    .neumorphic-button:hover {
        transform: translateY(-2px);
        box-shadow: 6px 6px 12px rgba(166, 180, 200, 0.6), 
                   -6px -6px 12px rgba(255, 255, 255, 0.9),
                   inset 1px 1px 1px rgba(255, 255, 255, 0.3);
    }
    
    .neumorphic-button:active {
        transform: translateY(1px);
        box-shadow: 2px 2px 5px rgba(166, 180, 200, 0.4), 
                   -2px -2px 5px rgba(255, 255, 255, 0.7),
                   inset 1px 1px 2px rgba(166, 180, 200, 0.2);
    }
    
    /* Enhanced select container - clear the SVG arrows */
    .neumorphic-select-container {
        position: relative;
    }
    
    .neumorphic-select-container svg {
        display: none;
    }
    
    /* Enhanced select styles for more professional appearance */
    .neumorphic-select {
        background: linear-gradient(175deg, #f8fafc, #eef2f7);
        border: 1px solid rgba(226, 232, 240, 0.8);
        box-shadow: 0 2px 6px rgba(71, 85, 105, 0.08);
        border-radius: 12px;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        font-weight: 500;
        color: #334155;
        appearance: none;
        padding: 12px 18px;
        padding-right: 2.5rem;
        width: 100%;
        font-size: 14.5px;
        cursor: pointer;
        outline: none;
    }
    
    .neumorphic-input {
        background: linear-gradient(175deg, #f8fafc, #eef2f7);
        border: 1px solid rgba(255, 255, 255, 0.9);
        transition: all 0.3s ease;
    }
    
    .neumorphic-input:focus {
        box-shadow: inset 2px 2px 5px rgba(166, 180, 200, 0.25), 
                    inset -2px -2px 5px rgba(255, 255, 255, 0.9),
                    0 0 0 3px rgba(59, 130, 246, 0.25);
        outline: none;
    }
    
    .neumorphic-select:focus {
        box-shadow: 0 4px 12px rgba(56, 114, 224, 0.15), 0 0 0 2px rgba(59, 130, 246, 0.2);
        border-color: rgba(59, 130, 246, 0.6);
        outline: none;
        transform: translateY(-1px);
    }
    
    .neumorphic-select:hover {
        box-shadow: 0 3px 8px rgba(71, 85, 105, 0.1);
        transform: translateY(-1px);
    }
    
    /* Enhanced styling for dropdown options */
    .neumorphic-select option {
        background-color: white;
        padding: 12px 16px;
        font-weight: 500;
        color: #334155;
        border-radius: 8px;
        margin: 4px 0;
    }
    
    .neumorphic-select option:checked {
        background-color: rgba(59, 130, 246, 0.08);
        color: #3b82f6;
    }
    
    .neumorphic-select option:hover {
        background-color: rgba(59, 130, 246, 0.04);
    }
    
    /* Elegant dropdown arrow styling */
    .neumorphic-select-container::after {
        content: '';
        position: absolute;
        right: 16px;
        top: 50%;
        width: 10px;
        height: 10px;
        border-bottom: 2px solid #64748b;
        border-right: 2px solid #64748b;
        transform: translateY(-70%) rotate(45deg);
        pointer-events: none;
        transition: all 0.2s ease;
        z-index: 1;
    }
    
    .neumorphic-select-container:hover::after {
        border-color: #3b82f6;
    }
    
    /* Styling for placeholder options */
    .neumorphic-select option[value=""] {
        color: #94a3b8;
        font-style: italic;
    }
    
    /* Enhanced selected option styling */
    .neumorphic-select-container select.selected {
        background-color: #f1f5fd;
        border-color: #3b82f6;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
    }
    
    /* Responsive adjustments */
    @media (max-width: 1024px) {
        .flex.flex-col.md\:flex-row {
            gap: 12px;
        }
        
        .neumorphic-select {
            padding: 10px 16px;
            padding-right: 2.5rem;
        }
    }
    
    @media (max-width: 768px) {
        /* Stack elements vertically on mobile */
        .flex.flex-col.md\:flex-row {
            gap: 16px;
        }
        
        .neumorphic-select-container {
            width: 100%;
        }
        
        .neumorphic-select {
            width: 100%;
            padding: 12px 16px;
            padding-right: 2.5rem;
            font-size: 14px;
        }
        
        #analyzeButton {
            width: 100%;
            margin-top: 8px;
        }
    }
    
    @media (max-width: 640px) {
        .neumorphic-select {
            padding: 10px 14px;
            padding-right: 2.2rem;
            font-size: 13px;
        }
        
        .neumorphic-select-container::after {
            right: 14px;
            width: 8px;
            height: 8px;
        }
    }
    
    /* Modal styling */
    #expandModal {
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    h1{
        font-weight: 800 !important;
    }
    /* Standardize all font weights to 450 */
     {% comment %} {
        font-weight: 450 !important;
    } {% endcomment %}



    #expandModal.active {
        opacity: 1;
        visibility: visible;
    }
    
    /* Enhanced styling for multiple select */
    select[multiple] {
        height: auto;
        min-height: 100px;
        padding-top: 8px;
        padding-bottom: 8px;
    }
    
    select[multiple] option {
        padding: 8px 12px;
        margin: 3px 0;
        border-radius: 4px;
        background-color: #f8fafc;
        transition: all 0.2s ease;
    }
    
    select[multiple] option:checked {
        background-color: rgba(59, 130, 246, 0.15);
        color: #1d4ed8;
        font-weight: 500;
    }
    
    select[multiple] option:hover {
        background-color: rgba(59, 130, 246, 0.05);
    }
    
    /* Style for the multiple select container */
    .neumorphic-select-container select[multiple] {
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
    }
    
    .neumorphic-select-container select[multiple]::-webkit-scrollbar {
        width: 5px;
    }
    
    .neumorphic-select-container select[multiple]::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .neumorphic-select-container select[multiple]::-webkit-scrollbar-thumb {
        background-color: rgba(156, 163, 175, 0.5);
        border-radius: 9999px;
    }
    
    .neumorphic-select-container select[multiple]::-webkit-scrollbar-thumb:hover {
        background-color: rgba(156, 163, 175, 0.7);
    }
</style>

<!-- Include Chart.js and its date adapter -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<!-- Include custom JS -->
<script src="{% static 'js/trends-charts.js' %}"></script>
<script src="{% static 'js/trends-ai-analysis.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    // Function to show AI indicators when AI analysis is used
    document.addEventListener('DOMContentLoaded', function() {
        // Listen for custom event when AI analysis is complete
        document.addEventListener('aiAnalysisComplete', function(e) {
            if (e.detail && e.detail.isAi) {
                // Show AI indicators
                document.getElementById('aiAnalysisIndicator').classList.remove('hidden');
                document.getElementById('aiRecommendationIndicator').classList.remove('hidden');
            }
        });

        // Add event listener for analysis type dropdown to show/hide charts
        const analysisTypeSelect = document.getElementById('analysis_type');
        const regionChartContainer = document.getElementById('regionChartContainer');
        const timeChartContainer = document.getElementById('chartContainer').parentElement;
        const yearlyFilterContainer = document.getElementById('yearlyFilterContainer');

        if (analysisTypeSelect && regionChartContainer && timeChartContainer) {
            analysisTypeSelect.addEventListener('change', function() {
                const selectedValue = this.value;
                
                // Reset - hide region chart
                if (regionChartContainer) {
                    regionChartContainer.style.display = 'none';
                }
                
                // Reset - show time chart and yearly filter (default)
                if (timeChartContainer) {
                    timeChartContainer.style.display = 'block';
                }
                if (yearlyFilterContainer) {
                    yearlyFilterContainer.style.display = 'block';
                }
                
                // Handle specific analysis types
                if (selectedValue === '2') { // Regional Analysis
                    // For regional analysis, hide time chart, show region chart
                    if (timeChartContainer) {
                        timeChartContainer.style.display = 'none';
                    }
                    if (yearlyFilterContainer) {
                        yearlyFilterContainer.style.display = 'none';
                    }
                    if (regionChartContainer) {
                        regionChartContainer.style.display = 'block';
                    }
                } else if (selectedValue === '7') { // Complete Analysis
                    // For complete analysis, show both charts
                    if (timeChartContainer) {
                        timeChartContainer.style.display = 'block';
                    }
                    if (regionChartContainer) {
                        regionChartContainer.style.display = 'block';
                    }
                    if (yearlyFilterContainer) {
                        yearlyFilterContainer.style.display = 'block';
                    }
                }
            });
        }

        // Add event listeners for time unit buttons
        const timeUnitButtons = document.querySelectorAll('.time-unit-btn');
        
        timeUnitButtons.forEach(button => {
            button.addEventListener('click', function() {
                const unit = this.getAttribute('data-unit');
                
                // Show/hide yearly filter based on selected time unit
                if (yearlyFilterContainer) {
                    // Only show yearly filter for month or day views
                    if (unit === 'month' || unit === 'day') {
                        yearlyFilterContainer.classList.remove('hidden');
                    } else {
                        yearlyFilterContainer.classList.add('hidden');
                    }
                }
            });
        });

        // Add event listener for yearly filter changes
        document.getElementById('yearlyFilter').addEventListener('change', function() {
            const selectedYear = this.value;
            console.log('Year filter changed to:', selectedYear);
            
            // Apply visual feedback
            this.classList.add('border-[#27FFB4]');
            setTimeout(() => {
                this.classList.remove('border-[#27FFB4]');
            }, 500);
            
            // The actual filtering is handled by the trends-charts.js updateChartWithYearFilter function
        });
        
        // Function to check content height and adjust scrolling behavior
        function adjustScrollableContent() {
            const rightPanel = document.querySelector('.right-panel');
            const analysisContent = document.getElementById('analysisContent');
            const recommendationContent = document.getElementById('recommendationContent');
            
            if (!rightPanel || !analysisContent || !recommendationContent) return;
            
            // Calculate viewport height
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;
            
            // Calculate content heights
            const analysisHeight = analysisContent.scrollHeight;
            const recommendationHeight = recommendationContent.scrollHeight;
            const totalContentHeight = analysisHeight + recommendationHeight;
            
            // Apply or remove the small content class
            if (totalContentHeight < viewportHeight * 0.7) {
                rightPanel.classList.add('has-small-content');
            } else {
                rightPanel.classList.remove('has-small-content');
            }
            
            // For mobile screens, set appropriate max heights
            if (viewportWidth < 768) {
                // Mobile view
                analysisContent.style.maxHeight = '250px';
                recommendationContent.style.maxHeight = '250px';
            } else if (viewportWidth < 1024) {
                // Tablet view
                analysisContent.style.maxHeight = '300px';
                recommendationContent.style.maxHeight = '300px';
            } else {
                // Desktop view
                const maxHeight = Math.max(300, Math.floor(viewportHeight * 0.4));
                analysisContent.style.maxHeight = `${maxHeight}px`;
                recommendationContent.style.maxHeight = `${maxHeight}px`;
            }
            
            // Clear any previous observers
            if (window.contentResizeObserver) {
                window.contentResizeObserver.disconnect();
            }
            
            // Create new resize observer
            window.contentResizeObserver = new ResizeObserver(() => {
                setTimeout(() => {
                    // Check if content is smaller than container
                    if (analysisContent.scrollHeight <= analysisContent.clientHeight &&
                        recommendationContent.scrollHeight <= recommendationContent.clientHeight) {
                        rightPanel.classList.add('has-small-content');
                    } else {
                        rightPanel.classList.remove('has-small-content');
                    }
                }, 300);
            });
            
            // Observe content containers
            window.contentResizeObserver.observe(analysisContent);
            window.contentResizeObserver.observe(recommendationContent);
        }
        
        // Adjust content on page load and when results are shown
        const resultsContainer = document.getElementById('resultsContainer');
        
        // Use MutationObserver to detect when results become visible
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'style' && 
                    resultsContainer.style.display !== 'none') {
                    adjustScrollableContent();
                }
            });
        });
        
        // Start observing
        if (resultsContainer) {
            observer.observe(resultsContainer, { attributes: true });
        }
        
        // Also adjust on window resize
        window.addEventListener('resize', adjustScrollableContent);
        
        // Listen for content updated event from AI analysis
        document.addEventListener('contentUpdated', adjustScrollableContent);
        
        // Initial adjustment
        setTimeout(adjustScrollableContent, 500);

        // Add selected class when dropdown has a selection
        const businessIntentSelect = document.getElementById('business_intent');
        const businessDetailsContainer = document.getElementById('businessDetailsContainer');
        
        if (businessIntentSelect) {
            businessIntentSelect.addEventListener('change', function() {
                if (this.value) {
                    this.classList.add('selected');
                } else {
                    this.classList.remove('selected');
                }
                
                // Show/hide business details based on selection
                if (this.value === 'no') {
                    businessDetailsContainer.classList.remove('hidden');
                    // Make the fields required
                    document.getElementById('brandName').setAttribute('required', 'required');
                    document.getElementById('marketplace').setAttribute('required', 'required');
                    // Website is optional, don't set required
                } else {
                    businessDetailsContainer.classList.add('hidden');
                    // Remove required attribute when hidden
                    document.getElementById('brandName').removeAttribute('required');
                    document.getElementById('businessWebsite').removeAttribute('required');
                    document.getElementById('marketplace').removeAttribute('required');
                }
            });
        }

        // Make dropdowns responsive and fix any styling issues
        const updateDropdownStyles = () => {
            const dropdowns = document.querySelectorAll('.neumorphic-select');
            const dropdownContainers = document.querySelectorAll('.neumorphic-select-container');
            
            dropdowns.forEach(dropdown => {
                // Add selected class when dropdown has a value
                if (dropdown.value) {
                    dropdown.classList.add('selected');
                } else {
                    dropdown.classList.remove('selected');
                }
                
                // Listen for changes
                dropdown.addEventListener('change', function() {
                    if (this.value) {
                        this.classList.add('selected');
                    } else {
                        this.classList.remove('selected');
                    }
                });
            });
            
            // Ensure proper arrow positioning
            dropdownContainers.forEach(container => {
                const svg = container.querySelector('svg');
                if (svg) svg.style.display = 'none';
            });
        };
        
        // Run initially and on window resize
        updateDropdownStyles();
        window.addEventListener('resize', updateDropdownStyles);

        // Variables for expand functionality
        const expandModal = document.getElementById('expandModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const closeModal = document.getElementById('closeModal');
        
        // Variables for PDF download
        const downloadReportBtn = document.getElementById('downloadReportBtn');
        const downloadButtonContainer = document.getElementById('downloadButtonContainer');
        
        // Function to check if at least one marketplace is selected
        function isAtLeastOneMarketplaceSelected() {
            const checkboxes = document.querySelectorAll('.marketplace-checkbox:checked');
            return checkboxes.length > 0;
        }
        
        // Function to update the hidden input with selected marketplace values
        function updateMarketplaceValues() {
            const checkboxes = document.querySelectorAll('.marketplace-checkbox:checked');
            const selectedValues = Array.from(checkboxes).map(checkbox => checkbox.value);
            document.getElementById('marketplace').value = selectedValues.join(', ');
            console.log('Updated marketplace values:', document.getElementById('marketplace').value);
        }
        
        // Add event listeners to marketplace checkboxes
        document.querySelectorAll('.marketplace-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateMarketplaceValues);
        });
        
        // Form validation
        const analyzeButton = document.getElementById('analyzeButton');
        if (analyzeButton) {
            analyzeButton.addEventListener('click', function(e) {
                // Prevent default form submission
                e.preventDefault();
                
                // Check if business intent is selected
                const businessIntent = document.getElementById('business_intent').value;
                if (!businessIntent) {
                    showError('Please select your business intent');
                    return false;
                }
                
                // If business intent is "no", validate additional fields
                if (businessIntent === 'no') {
                    const brandName = document.getElementById('brandName').value;
                    
                    // Check if at least one marketplace checkbox is selected
                    const hasSelectedMarketplace = isAtLeastOneMarketplaceSelected();
                    
                    // Only check for brand name and marketplace, website is optional
                    if (!brandName || !hasSelectedMarketplace) {
                        showError('Please provide brand name and select at least one marketplace');
                        return false;
                    }
                }
                
                // If validation passes, proceed with form submission
                if (typeof handleFormSubmit === 'function') {
                    handleFormSubmit(e);
                }
            });
        }
        
        // Function to show error message
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            
            if (errorContainer && errorMessage) {
                errorMessage.textContent = message;
                errorContainer.style.display = 'flex';
                
                // Scroll to error message
                errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        // Show download button when AI content is loaded
        document.addEventListener('aiAnalysisComplete', function(e) {
            if (e.detail && e.detail.isAi) {
                downloadButtonContainer.classList.remove('hidden');
            }
        });
        
        // Expand button functionality
        const expandButtons = document.querySelectorAll('.expand-btn');
        expandButtons.forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const targetContent = document.getElementById(targetId);
                const sectionTitle = this.parentElement.querySelector('div').textContent.trim();
                
                // Set modal title and content
                modalTitle.textContent = sectionTitle;
                modalContent.innerHTML = targetContent.innerHTML;
                
                // Show modal with animation
                expandModal.classList.remove('hidden');
                setTimeout(() => {
                    expandModal.classList.add('active');
                }, 10);
            });
        });
        
        // Close modal when clicking the close button
        closeModal.addEventListener('click', function() {
            expandModal.classList.remove('active');
            setTimeout(() => {
                expandModal.classList.add('hidden');
            }, 300);
        });
        
        // Close modal when clicking outside
        expandModal.addEventListener('click', function(e) {
            if (e.target === expandModal) {
                expandModal.classList.remove('active');
                setTimeout(() => {
                    expandModal.classList.add('hidden');
                }, 300);
            }
        });
        
        // PDF Download functionality
        if (downloadReportBtn) {
            downloadReportBtn.addEventListener('click', function() {
                generatePDF();
            });
        }
        
        // Function to generate PDF
        function generatePDF() {
            // Show loading state
            const originalBtnText = downloadReportBtn.innerHTML;
            downloadReportBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 pdf-loading" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M16 12l-4 4-4-4"></path>
                    <path d="M12 8v8"></path>
                </svg>
                Generating PDF...
            `;
            downloadReportBtn.disabled = true;
            
            // Delay to allow button state to update
            setTimeout(() => {
                // Get content for PDF
                const chartContainer = document.getElementById('chartContainer');
                const analysisContent = document.getElementById('analysisContent');
                const recommendationContent = document.getElementById('recommendationContent');
                const searchQuery = document.getElementById('keywordInput').value;
                
                // Create a temporary container for capturing PDF content
                const pdfContainer = document.createElement('div');
                pdfContainer.style.padding = '5px';
                pdfContainer.style.background = 'white';
                pdfContainer.style.width = '800px';
                pdfContainer.style.position = 'absolute';
                pdfContainer.style.left = '-9999px';
                
                // Create PDF content with professional styling
                pdfContainer.innerHTML = `
                    <div style="padding: 5px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb;">
                        <h1 style="color: #2563eb; font-size: 24px; margin-bottom: 8px; padding: 5px;">TrendIQ Analysis Report</h1>
                        <p style="color: #6b7280; font-size: 14px; padding: 5px;">Generated on ${new Date().toLocaleDateString()} for search query: "${searchQuery}"</p>
                    </div>
                    
                    <div style="margin-top: 20px; margin-bottom: 30px; padding: 5px;">
                        <h2 style="color: #1e40af; font-size: 18px; margin-bottom: 15px; padding: 5px;">Trend Visualization</h2>
                        <div id="pdfChart" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 5px; background: #f9fafb;"></div>
                    </div>
                    
                    <div style="margin-bottom: 30px; padding: 5px;">
                        <h2 style="color: #1e40af; font-size: 18px; margin-bottom: 15px; padding: 5px;">Analysis</h2>
                        <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 5px; background: #f9fafb;">${analysisContent.innerHTML}</div>
                    </div>
                    
                    <div style="margin-bottom: 30px; padding: 5px;">
                        <h2 style="color: #1e40af; font-size: 18px; margin-bottom: 15px; padding: 5px;">Recommendations</h2>
                        <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 5px; background: #f9fafb;">${recommendationContent.innerHTML}</div>
                    </div>
                    
                    <div style="margin-top: 20px; border-top: 1px solid #e5e7eb; padding: 5px; text-align: center;">
                        <p style="color: #6b7280; font-size: 12px; padding: 5px;"> ${new Date().getFullYear()} 1Matrix TrendIQ. All rights reserved.</p>
                    </div>
                `;
                
                document.body.appendChild(pdfContainer);
                
                // Clone chart into PDF container
                const pdfChart = pdfContainer.querySelector('#pdfChart');
                html2canvas(chartContainer, {scale: 2}).then(canvas => {
                    pdfChart.appendChild(canvas);
                    
                    // Create PDF
                    setTimeout(() => {
                        html2canvas(pdfContainer, {
                            scale: 1,
                            useCORS: true,
                            allowTaint: true,
                            backgroundColor: '#ffffff'
                        }).then(canvas => {
                            // Remove temporary container
                            document.body.removeChild(pdfContainer);
                            
                            // Create PDF document
                            const { jsPDF } = window.jspdf;
                            const pdf = new jsPDF('p', 'mm', 'a4');
                            
                            // Define PDF margins (5px converted to mm)
                            const margin = 1.89; // 5px converted to mm (approx)
                            
                            // Canvas dimensions
                            const imgData = canvas.toDataURL('image/png');
                            const imgWidth = 210 - (margin * 2); // A4 width in mm minus margins
                            const pageHeight = 295 - (margin * 2); // A4 height in mm minus margins
                            const imgHeight = canvas.height * imgWidth / canvas.width;
                            let heightLeft = imgHeight;
                            
                            // Add content to first page with margins
                            let position = margin;
                            pdf.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
                            heightLeft -= pageHeight;
                            
                            // Add new pages if content is larger than one page
                            while (heightLeft >= 0) {
                                position = heightLeft - imgHeight + margin;
                                pdf.addPage();
                                pdf.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
                                heightLeft -= pageHeight;
                            }
                            
                            // Save PDF
                            pdf.save(`TrendIQ_Analysis_${new Date().toISOString().slice(0,10)}.pdf`);
                            
                            // Reset button state
                            downloadReportBtn.innerHTML = originalBtnText;
                            downloadReportBtn.disabled = false;
                        });
                    }, 500);
                });
            }, 100);
        }

        // Add event listener for test PDF button
        const testPdfBtn = document.getElementById('testPdfBtn');
        if (testPdfBtn) {
            testPdfBtn.addEventListener('click', function() {
                generateTestPDF();
            });
        }

        // Function to generate a demo PDF for testing
        function generateTestPDF() {
            // Show loading state on the test button
            const originalBtnText = testPdfBtn.innerHTML;
            testPdfBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                </svg>
                Generating...
            `;
            testPdfBtn.disabled = true;

            // Create sample chart if it doesn't exist
            let chartContainer = document.getElementById('chartContainer');
            if (!chartContainer || chartContainer.style.display === 'none') {
                // Create a temporary chart container if not visible
                chartContainer = document.createElement('div');
                chartContainer.id = 'tempChartContainer';
                chartContainer.style.width = '600px';
                chartContainer.style.height = '300px';
                chartContainer.style.position = 'absolute';
                chartContainer.style.left = '-9999px';
                chartContainer.style.background = '#f8fafc';
                chartContainer.style.padding = '20px';
                chartContainer.style.border = '1px solid #e5e7eb';
                chartContainer.style.borderRadius = '12px';
                
                // Add a canvas for the chart
                const canvas = document.createElement('canvas');
                canvas.width = 600;
                canvas.height = 300;
                chartContainer.appendChild(canvas);
                document.body.appendChild(chartContainer);
                
                // Create a simple chart
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#f1f5f9';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw sample chart lines
                ctx.beginPath();
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 3;
                ctx.moveTo(50, 200);
                ctx.bezierCurveTo(150, 100, 250, 250, 350, 50);
                ctx.bezierCurveTo(450, 150, 500, 100, 550, 150);
                ctx.stroke();
                
                // Add grid lines
                ctx.lineWidth = 0.5;
                ctx.strokeStyle = '#cbd5e1';
                for (let i = 50; i < 300; i += 50) {
                    ctx.beginPath();
                    ctx.moveTo(50, i);
                    ctx.lineTo(550, i);
                    ctx.stroke();
                }
                
                // Add months
                ctx.fillStyle = '#64748b';
                ctx.font = '12px Arial';
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                for (let i = 0; i < 6; i++) {
                    ctx.fillText(months[i], 100 * i + 50, 280);
                }
            }
            
            // Generate sample analysis and recommendation content if not available
            let analysisContent = document.getElementById('analysisContent');
            let recommendationContent = document.getElementById('recommendationContent');
            
            // Create temporary containers if needed
            if (!analysisContent || analysisContent.innerText.trim().includes('will appear here after search')) {
                analysisContent = document.createElement('div');
                analysisContent.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Trend Analysis Overview</h3>
                    <p class="mb-2">The search term <strong>"smartphone accessories"</strong> shows a consistent upward trend over the past 5 years, with seasonal spikes during holiday shopping periods (November-December) and new smartphone release cycles (September).</p>
                    <p class="mb-2">Year-over-year growth rate: <strong>+18%</strong> (average)</p>
                    <p class="mb-2">Highest interest regions:</p>
                    <ol class="list-decimal pl-5 mb-3">
                        <li>Maharashtra (100)</li>
                        <li>Delhi (87)</li>
                        <li>Karnataka (76)</li>
                        <li>Tamil Nadu (72)</li>
                        <li>Gujarat (68)</li>
                    </ol>
                    <p class="mb-2">Related rising queries:</p>
                    <ul class="list-disc pl-5 mb-3">
                        <li>smartphone ring holder (+120%)</li>
                        <li>magnetic phone holders (+95%)</li>
                        <li>phone camera lens attachments (+82%)</li>
                        <li>smartphone gaming accessories (+78%)</li>
                    </ul>
                    <p>The market shows strong growth potential with a diversifying range of products and increasing consumer interest in specialized accessories that enhance smartphone functionality.</p>
                `;
            }
            
            if (!recommendationContent || recommendationContent.innerText.trim().includes('will appear here after search')) {
                recommendationContent = document.createElement('div');
                recommendationContent.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Strategic Recommendations</h3>
                    <ol class="list-decimal pl-5 mb-3">
                        <li>
                            <div class="font-medium">Focus on emerging accessory categories</div>
                            <p class="mb-2">Invest in trending categories like magnetic accessories, camera enhancements, and gaming peripherals that show above-average growth rates.</p>
                        </li>
                        <li>
                            <div class="font-medium">Time your marketing campaigns strategically</div>
                            <p class="mb-2">Allocate higher marketing budgets during pre-holiday seasons (October-November) and align campaigns with major smartphone brand release dates.</p>
                        </li>
                        <li>
                            <div class="font-medium">Regional targeting</div>
                            <p class="mb-2">Prioritize digital marketing efforts in Maharashtra, Delhi, and Karnataka where interest is highest, with localized campaigns addressing regional preferences.</p>
                        </li>
                        <li>
                            <div class="font-medium">Cross-selling opportunity</div>
                            <p class="mb-2">Bundle complementary accessories together based on rising search correlations, like phone cases with screen protectors or ring holders with car mounts.</p>
                        </li>
                        <li>
                            <div class="font-medium">Competitive differentiation</div>
                            <p>Emphasize premium quality and unique features in product listings to stand out in an increasingly competitive marketplace.</p>
                        </li>
                    </ol>
                    <p class="mt-3 italic text-gray-600">Implementing these strategies can help maximize market opportunity and establish a strong positioning in the growing smartphone accessories market.</p>
                `;
            }
            
            // Set query text if empty
            const searchQuery = document.getElementById('keywordInput').value || "smartphone accessories";
            
            // Create a temporary container for capturing PDF content
            const pdfContainer = document.createElement('div');
            pdfContainer.style.padding = '5px';
            pdfContainer.style.background = 'white';
            pdfContainer.style.width = '800px';
            pdfContainer.style.position = 'absolute';
            pdfContainer.style.left = '-9999px';
            
            // Create PDF content with professional styling
            pdfContainer.innerHTML = `
                <div style="padding: 5px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb;">
                    <h1 style="color: #2563eb; font-size: 24px; margin-bottom: 8px; padding: 5px;">TrendIQ Analysis Report</h1>
                    <p style="color: #6b7280; font-size: 14px; padding: 5px;">Generated on ${new Date().toLocaleDateString()} for search query: "${searchQuery}"</p>
                </div>
                
                <div style="margin-top: 20px; margin-bottom: 30px; padding: 5px;">
                    <h2 style="color: #1e40af; font-size: 18px; margin-bottom: 15px; padding: 5px;">Trend Visualization</h2>
                    <div id="pdfChart" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 5px; background: #f9fafb;"></div>
                </div>
                
                <div style="margin-bottom: 30px; padding: 5px;">
                    <h2 style="color: #1e40af; font-size: 18px; margin-bottom: 15px; padding: 5px;">Analysis</h2>
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 5px; background: #f9fafb;">${analysisContent.innerHTML}</div>
                </div>
                
                <div style="margin-bottom: 30px; padding: 5px;">
                    <h2 style="color: #1e40af; font-size: 18px; margin-bottom: 15px; padding: 5px;">Recommendations</h2>
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 5px; background: #f9fafb;">${recommendationContent.innerHTML}</div>
                </div>
                
                <div style="margin-top: 20px; border-top: 1px solid #e5e7eb; padding: 5px; text-align: center;">
                    <p style="color: #6b7280; font-size: 12px; padding: 5px;"> ${new Date().getFullYear()} 1Matrix TrendIQ. All rights reserved.</p>
                </div>
            `;
            
            document.body.appendChild(pdfContainer);
            
            // Clone chart into PDF container
            const pdfChart = pdfContainer.querySelector('#pdfChart');
            html2canvas(chartContainer, {scale: 2}).then(canvas => {
                pdfChart.appendChild(canvas);
                
                // Create PDF
                setTimeout(() => {
                    html2canvas(pdfContainer, {
                        scale: 1,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff'
                    }).then(canvas => {
                        // Remove temporary container
                        document.body.removeChild(pdfContainer);
                        
                        // Remove temporary chart container if we created one
                        if (chartContainer.id === 'tempChartContainer') {
                            document.body.removeChild(chartContainer);
                        }
                        
                        // Create PDF document
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        
                        // Define PDF margins (5px converted to mm)
                        const margin = 1.89; // 5px converted to mm (approx)
                        
                        // Canvas dimensions
                        const imgData = canvas.toDataURL('image/png');
                        const imgWidth = 210 - (margin * 2); // A4 width in mm minus margins
                        const pageHeight = 295 - (margin * 2); // A4 height in mm minus margins
                        const imgHeight = canvas.height * imgWidth / canvas.width;
                        let heightLeft = imgHeight;
                        
                        // Add content to first page with margins
                        let position = margin;
                        pdf.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                        
                        // Add new pages if content is larger than one page
                        while (heightLeft >= 0) {
                            position = heightLeft - imgHeight + margin;
                            pdf.addPage();
                            pdf.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
                            heightLeft -= pageHeight;
                        }
                        
                        // Save PDF
                        pdf.save(`TrendIQ_Demo_${new Date().toISOString().slice(0,10)}.pdf`);
                        
                        // Reset button state
                        testPdfBtn.innerHTML = originalBtnText;
                        testPdfBtn.disabled = false;
                    });
                }, 500);
            });
        }
    });

    // Add PageSpeed Insights API Integration
    const businessWebsiteInput = document.getElementById('businessWebsite');
    const pagespeedDataInput = document.getElementById('pagespeedData');
    const analyzeButton = document.getElementById('analyzeButton');
    const businessIntentSelect = document.getElementById('business_intent');
    
    // Function to analyze website with PageSpeed Insights API
    async function analyzeWebsiteWithPageSpeed(targetUrl) {
        if (!targetUrl || targetUrl.trim() === '') {
            console.log('No website URL provided for analysis');
            return null;
        }
        
        // Validate and normalize URL format
        try {
            // Ensure URL has proper format with protocol
            if (!targetUrl.startsWith('http')) {
                targetUrl = 'https://' + targetUrl;
            }
            
            // Use URL constructor to validate and normalize
            const urlObj = new URL(targetUrl);
            
            // Ensure we have a valid hostname
            if (!urlObj.hostname || urlObj.hostname.length < 3) {
                console.error('Invalid hostname in URL:', targetUrl);
                return { 
                    error: 'Invalid website URL: hostname is missing or too short',
                    status: 'error',
                    url: targetUrl
                };
            }
            
            // Normalize URL by removing trailing slashes
            targetUrl = urlObj.toString().replace(/\/+$/, '');
            
            console.log(`Starting PageSpeed analysis for: ${targetUrl}`);
        } catch (urlError) {
            console.error('Invalid URL format:', urlError);
            return { 
                error: `Invalid URL format: ${urlError.message}`,
                status: 'error',
                url: targetUrl
            };
        }
        
        const apiEndpoint = "https://www.googleapis.com/pagespeedonline/v5/runPagespeed";
        const apiKey = "AIzaSyCtlv3d3rD8C2E5YDDJl1ozNWwcNyrcTYE";
        
        // Implement progressive retry with increasing timeouts
        const timeouts = [20000, 40000, 60000]; // 20s, 40s, 60s
        let lastError = null;
        
        for (let attempt = 0; attempt < timeouts.length; attempt++) {
            try {
                const timeout = timeouts[attempt];
                console.log(`Attempt ${attempt + 1} with timeout ${timeout}ms for ${targetUrl}`);
                
                const url = new URL(apiEndpoint);
                
                // Set required and optional parameters
                url.searchParams.set('url', targetUrl);
                url.searchParams.set('key', apiKey);
                url.searchParams.set('strategy', 'mobile'); // Explicitly use mobile strategy
                
                // Add all categories to ensure comprehensive results
                url.searchParams.append('category', 'performance');
                url.searchParams.append('category', 'accessibility');
                url.searchParams.append('category', 'best-practices');
                url.searchParams.append('category', 'seo');
                
                // Add locale for consistent results
                url.searchParams.set('locale', 'en');
                
                // Request full reports to get all details
                url.searchParams.set('utm_source', 'lighthouse');
                
                console.log(`Sending API request to: ${url.toString()}`);
                
                // Create an AbortController with the current timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                const response = await fetch(url.toString(), {
                    method: 'GET',
                    signal: controller.signal
                });
                
                // Clear the timeout as request completed
                clearTimeout(timeoutId);
                
                console.log(`Received response with status: ${response.status}`);
                
                // Handle quota exceeded errors (429)
                if (response.status === 429) {
                    console.warn('PageSpeed API quota exceeded');
                    return { 
                        error: 'API quota exceeded. Please try again later.',
                        status: 429,
                        url: targetUrl
                    };
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`PageSpeed API error: ${errorText}`);
                    throw new Error(`API request failed with status: ${response.status}, ${errorText}`);
                }
                
                const json = await response.json();
                console.log('PageSpeed API raw response received successfully');
                
                // Process the response to extract the most important information
                const lighthouse = json.lighthouseResult;
                if (!lighthouse) {
                    console.error('Missing lighthouse result in API response');
                    return { 
                        error: 'Invalid API response: missing lighthouse result',
                        url: targetUrl
                    };
                }
                
                // Extract all available information
                const result = {
                    url: targetUrl,
                    analyzed_at: new Date().toISOString(),
                    captchaResult: json.captchaResult,
                    kind: json.kind,
                    id: json.id,
                    loadingExperience: json.loadingExperience || {},
                    originLoadingExperience: json.originLoadingExperience || {},
                    version: lighthouse.lighthouseVersion,
                    userAgent: lighthouse.userAgent,
                    environment: lighthouse.environment || {},
                    fetchTime: lighthouse.fetchTime,
                    runWarnings: lighthouse.runWarnings || [],
                    configSettings: lighthouse.configSettings || {},
                    attempt: attempt + 1,
                    full_report_url: `https://pagespeed.web.dev/report?url=${encodeURIComponent(targetUrl)}`
                };
                
                // Extract all categories and scores
                result.categories = {};
                result.scores = {};
                
                if (lighthouse.categories) {
                    Object.keys(lighthouse.categories).forEach(categoryKey => {
                        const category = lighthouse.categories[categoryKey];
                        result.categories[categoryKey] = {
                            id: category.id,
                            title: category.title,
                            description: category.description,
                            score: category.score,
                            manualDescription: category.manualDescription,
                            auditRefs: category.auditRefs
                        };
                        
                        // Add to scores for backward compatibility
                        result.scores[categoryKey] = category.score * 100 || 0;
                    });
                }
                
                // Extract all audits with complete details
                result.audits = {};
                
                if (lighthouse.audits) {
                    Object.keys(lighthouse.audits).forEach(auditKey => {
                        const audit = lighthouse.audits[auditKey];
                        result.audits[auditKey] = {
                            id: audit.id,
                            title: audit.title,
                            description: audit.description,
                            score: audit.score,
                            scoreDisplayMode: audit.scoreDisplayMode,
                            displayValue: audit.displayValue,
                            numericValue: audit.numericValue,
                            warnings: audit.warnings || [],
                            errorMessage: audit.errorMessage,
                            details: audit.details
                        };
                    });
                }
                
                // Extract key metrics (for backward compatibility)
                result.metrics = {
                    'first-contentful-paint': {
                        display_value: lighthouse.audits['first-contentful-paint']?.displayValue || 'N/A',
                        numeric_value: lighthouse.audits['first-contentful-paint']?.numericValue 
                            ? Math.round(lighthouse.audits['first-contentful-paint'].numericValue) : null
                    },
                    'largest-contentful-paint': {
                        display_value: lighthouse.audits['largest-contentful-paint']?.displayValue || 'N/A',
                        numeric_value: lighthouse.audits['largest-contentful-paint']?.numericValue 
                            ? Math.round(lighthouse.audits['largest-contentful-paint'].numericValue) : null
                    },
                    'cumulative-layout-shift': {
                        display_value: lighthouse.audits['cumulative-layout-shift']?.displayValue || 'N/A',
                        numeric_value: lighthouse.audits['cumulative-layout-shift']?.numericValue 
                            ? parseFloat(lighthouse.audits['cumulative-layout-shift'].numericValue.toFixed(3)) : null
                    },
                    'total-blocking-time': {
                        display_value: lighthouse.audits['total-blocking-time']?.displayValue || 'N/A',
                        numeric_value: lighthouse.audits['total-blocking-time']?.numericValue 
                            ? Math.round(lighthouse.audits['total-blocking-time'].numericValue) : null
                    },
                    'speed-index': {
                        display_value: lighthouse.audits['speed-index']?.displayValue || 'N/A',
                        numeric_value: lighthouse.audits['speed-index']?.numericValue 
                            ? Math.round(lighthouse.audits['speed-index'].numericValue) : null
                    },
                    'interactive': {
                        display_value: lighthouse.audits['interactive']?.displayValue || 'N/A',
                        numeric_value: lighthouse.audits['interactive']?.numericValue 
                            ? Math.round(lighthouse.audits['interactive'].numericValue) : null
                    },
                    'server-response-time': {
                        display_value: lighthouse.audits['server-response-time']?.displayValue || 'N/A',
                        numeric_value: lighthouse.audits['server-response-time']?.numericValue 
                            ? Math.round(lighthouse.audits['server-response-time'].numericValue) : null
                    },
                    'max-potential-fid': {
                        display_value: lighthouse.audits['max-potential-fid']?.displayValue || 'N/A',
                        numeric_value: lighthouse.audits['max-potential-fid']?.numericValue 
                            ? Math.round(lighthouse.audits['max-potential-fid'].numericValue) : null
                    },
                    'first-meaningful-paint': {
                        display_value: lighthouse.audits['first-meaningful-paint']?.displayValue || 'N/A',
                        numeric_value: lighthouse.audits['first-meaningful-paint']?.numericValue 
                            ? Math.round(lighthouse.audits['first-meaningful-paint'].numericValue) : null
                    },
                    'mainthread-work-breakdown': {
                        display_value: lighthouse.audits['mainthread-work-breakdown']?.displayValue || 'N/A',
                        numeric_value: lighthouse.audits['mainthread-work-breakdown']?.numericValue
                            ? Math.round(lighthouse.audits['mainthread-work-breakdown'].numericValue) : null
                    }
                };
                
                // Extract opportunities and passed audits (for backward compatibility)
                result.opportunities = [];
                result.passed_audits = [];
                
                for (const auditId in lighthouse.audits) {
                    const audit = lighthouse.audits[auditId];
                    
                    if (audit.details && audit.details.type === 'opportunity' && audit.score < 1) {
                        result.opportunities.push({
                            id: auditId,
                            title: audit.title,
                            description: audit.description || '',
                            score: audit.score,
                            numericValue: audit.numericValue,
                            displayValue: audit.displayValue,
                            details: audit.details
                        });
                    } else if (audit.score === 1) {
                        result.passed_audits.push({
                            id: auditId,
                            title: audit.title,
                            description: audit.description || ''
                        });
                    }
                }
                
                // Add full stack packs information (for framework-specific advice)
                result.stackPacks = lighthouse.stackPacks || [];
                
                // Add timing information
                result.timing = lighthouse.timing || {};
                
                // Add I18n information
                result.i18n = lighthouse.i18n || {};
                
                // Add entity information
                result.entities = lighthouse.entities || [];
                
                // Format summary for backward compatibility
                const performanceScore = result.scores.performance ? result.scores.performance.toFixed(0) : 'N/A';
                const seoScore = result.scores.seo ? result.scores.seo.toFixed(0) : 'N/A';
                const accessibilityScore = result.scores.accessibility ? result.scores.accessibility.toFixed(0) : 'N/A';
                const bestPracticesScore = result.scores['best-practices'] ? result.scores['best-practices'].toFixed(0) : 'N/A';
                
                result.summary = `Performance: ${performanceScore}%, SEO: ${seoScore}%, Accessibility: ${accessibilityScore}%, Best Practices: ${bestPracticesScore}%`;
                
                console.log('PageSpeed analysis completed successfully with comprehensive data extraction');
                
                // Return the complete result
                return result;
                
            } catch (error) {
                console.error(`Attempt ${attempt + 1} failed:`, error);
                lastError = error;
                
                // If it's not a timeout error, don't retry
                if (error.name !== 'AbortError' && !error.message.includes('timed out')) {
                    break;
                }
                
                // If this was the last attempt, don't wait
                if (attempt < timeouts.length - 1) {
                    console.log(`Waiting before retry ${attempt + 2}...`);
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2s between attempts
                }
            }
        }
        
        // All attempts failed
        console.error('All PageSpeed API attempts failed:', lastError);
        return {
            error: `PageSpeed API request failed: ${lastError ? (lastError.message || 'The operation timed out.') : 'Unknown error'}`,
            status: 'error',
            url: targetUrl
        };
    }
    
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Add event listener to business website input for analysis when submitting
    if (businessWebsiteInput && analyzeButton && businessIntentSelect) {
        analyzeButton.addEventListener('click', async function(event) {
            // Only analyze if business intent is "no" (already in business)
            if (businessIntentSelect.value === 'no') {
                const websiteUrl = businessWebsiteInput.value.trim();
                
                if (websiteUrl) {
                    try {
                        // Show loading indicator or some feedback
                        const loadingIndicator = document.getElementById('loadingIndicator');
                        if (loadingIndicator) loadingIndicator.style.display = 'flex';
                        
                        console.log('Analyzing website before form submission:', websiteUrl);
                        
                        // Analyze the website
                        const pagespeedResults = await analyzeWebsiteWithPageSpeed(websiteUrl);
                        
                        // Store results in both places to ensure redundancy
                        if (pagespeedResults) {
                            // Show the preview of the data
                            showPageSpeedPreview(pagespeedResults);
                            
                            // Store as both string and object to ensure compatibility
                            const jsonString = JSON.stringify(pagespeedResults);
                            pagespeedDataInput.value = jsonString;
                            window.pagespeedInsightsData = pagespeedResults; // Store as object
                            
                            console.log('PageSpeed data stored for submission:', {
                                asString: jsonString.substring(0, 100) + '...',
                                asObject: pagespeedResults
                            });
                            
                            // Create a DOM event to notify that PageSpeed data is ready
                            const event = new CustomEvent('pagespeedDataReady', {
                                detail: { pagespeedData: pagespeedResults }
                            });
                            document.dispatchEvent(event);
                        }
                        
                        // Debug check to make sure data is properly stored
                        setTimeout(() => {
                            console.log('Verifying stored PageSpeed data:', {
                                inputValue: pagespeedDataInput.value ? 'Set (length: ' + pagespeedDataInput.value.length + ')' : 'Empty',
                                windowValue: window.pagespeedInsightsData ? 'Set (object)' : 'Not set',
                                hasData: !!pagespeedDataInput.value
                            });
                        }, 100);
                        
                    } catch (error) {
                        console.error('Error during website analysis:', error);
                        // Continue with form submission even if analysis fails
                    }
                }
            }
        });
        
        // Add an event listener to the business intent dropdown to clear PageSpeed data when changed
        businessIntentSelect.addEventListener('change', function() {
            if (this.value !== 'no') {
                // Clear PageSpeed data if not "already in business"
                pagespeedDataInput.value = '';
                window.pagespeedInsightsData = null;
                console.log('PageSpeed data cleared due to business intent change');
            }
        });
    }

    // Add Website PageSpeed Preview Modal functionality
    const businessWebsitePreviewBtn = document.createElement('button');
    businessWebsitePreviewBtn.type = 'button';
    businessWebsitePreviewBtn.className = 'text-blue-500 text-sm absolute right-3 top-3 hover:text-blue-600';
    businessWebsitePreviewBtn.innerHTML = 'Preview Analysis';
    businessWebsitePreviewBtn.style.display = 'none';
    
    // Insert the button after the business website input
    if (businessWebsiteInput && businessWebsiteInput.parentNode) {
        businessWebsiteInput.parentNode.style.position = 'relative';
        businessWebsiteInput.parentNode.appendChild(businessWebsitePreviewBtn);
        
        // Show/hide preview button based on input value
        businessWebsiteInput.addEventListener('input', function() {
            businessWebsitePreviewBtn.style.display = this.value.trim() ? 'block' : 'none';
        });
        
        // Preview button click handler
        businessWebsitePreviewBtn.addEventListener('click', async function() {
            const websiteUrl = businessWebsiteInput.value.trim();
            
            if (websiteUrl) {
                // Create or get preview modal
                let previewModal = document.getElementById('websitePreviewModal');
                
                if (!previewModal) {
                    // Create modal if it doesn't exist
                    previewModal = document.createElement('div');
                    previewModal.id = 'websitePreviewModal';
                    previewModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden';
                    
                    previewModal.innerHTML = `
                        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform transition-all">
                            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                                <h3 id="previewModalTitle" class="text-xl font-bold text-transparent bg-gradient-to-r from-blue-600 to-blue-400 bg-clip-text">Website Analysis Preview</h3>
                                <button id="closePreviewModal" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            <div id="previewModalContent" class="p-6 overflow-y-auto flex-grow">
                                <div class="flex items-center justify-center py-10">
                                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500"></div>
                                    <span class="ml-3 text-gray-600">Analyzing website...</span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(previewModal);
                    
                    // Close button functionality
                    document.getElementById('closePreviewModal').addEventListener('click', function() {
                        previewModal.classList.add('hidden');
                    });
                    
                    // Close when clicking outside
                    previewModal.addEventListener('click', function(e) {
                        if (e.target === previewModal) {
                            previewModal.classList.add('hidden');
                        }
                    });
                }
                
                // Show modal
                previewModal.classList.remove('hidden');
                
                // Analyze website
                try {
                    const results = await analyzeWebsiteWithPageSpeed(websiteUrl);
                    const modalContent = document.getElementById('previewModalContent');
                    
                    // Use our comprehensive display function
                    displayComprehensivePageSpeedResults(modalContent, results);
                    
                } catch (error) {
                    console.error('Error in website preview:', error);
                    document.getElementById('previewModalContent').innerHTML = `
                        <div class="bg-red-50 p-4 rounded-lg">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-red-800">Exception occurred</h3>
                                    <div class="mt-2 text-sm text-red-700">
                                        <p>Error analyzing website: ${error.message}</p>
                                        <p class="mt-2">Stack trace: ${error.stack ? error.stack.split('\n')[0] : 'Not available'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        });
    }
    
    // Helper function to create score cards
    function createScoreCard(label, score) {
        let colorClass = 'bg-red-500';
        if (score >= 90) {
            colorClass = 'bg-green-500';
        } else if (score >= 50) {
            colorClass = 'bg-yellow-500';
        }
        
        return `
            <div class="bg-gray-50 p-3 rounded-lg text-center">
                <div class="w-16 h-16 rounded-full ${colorClass} flex items-center justify-center mx-auto mb-2 text-white font-bold">
                    ${Math.round(score)}
                </div>
                <span class="text-sm font-medium text-gray-700">${label}</span>
            </div>
        `;
    }
    
    // Modify existing handleFormSubmit function to include PageSpeed data
    const originalHandleFormSubmit = window.handleFormSubmit;
    
    if (typeof originalHandleFormSubmit === 'function') {
        window.handleFormSubmit = async function(event) {
            event.preventDefault();
            
            // Check if we need to analyze a website
            const businessIntent = document.getElementById('business_intent').value;
            const websiteUrl = document.getElementById('businessWebsite')?.value?.trim();
            
            if (businessIntent === 'no' && websiteUrl && !window.pagespeedInsightsData) {
                // Show loading indicator
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) loadingIndicator.style.display = 'flex';
                
                console.log('Analyzing website before form submission:', websiteUrl);
                
                try {
                    // Analyze the website
                    const pagespeedResults = await analyzeWebsiteWithPageSpeed(websiteUrl);
                    
                    if (pagespeedResults) {
                        // Show preview
                        showPageSpeedPreview(pagespeedResults);
                        
                        // Store results in both hidden input and window object
                        const jsonString = JSON.stringify(pagespeedResults);
                        document.getElementById('pagespeedData').value = jsonString;
                        window.pagespeedInsightsData = pagespeedResults;
                        
                        console.log('PageSpeed data obtained and stored:', {
                            isObject: typeof pagespeedResults === 'object',
                            isMockData: pagespeedResults.is_mock_data || false
                        });
                    }
                } catch (error) {
                    console.error('Error analyzing website:', error);
                }
            }
            
            // Now continue with the original form submission
            return originalHandleFormSubmit.call(this, event);
        };
    }

    // Existing code continues below
    // ...

    // Function to show PageSpeed data preview
    function showPageSpeedPreview(data) {
        const previewElem = document.getElementById('pagespeed-preview');
        if (!previewElem) return;
        
        // Check if this is an error response
        if (data.error) {
            let previewHTML = `
                <div class="p-4 mb-4 bg-red-50 border border-red-200 rounded-lg">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-semibold text-red-700">Website Analysis Error: ${data.url}</h3>
                        <span class="text-xs px-2 py-1 bg-red-100 text-red-800 rounded">Status: ${data.status || 'Error'}</span>
                    </div>
                    <div class="text-sm text-red-700 mb-3">
                        <p>${data.error}</p>
                        ${data.details ? `<p class="mt-2 text-xs">${data.details}</p>` : ''}
                    </div>
                    <div class="text-sm bg-white p-3 rounded border border-red-100">
                        <p class="text-gray-700">
                            Unable to analyze your website. Please check the URL and try again later. 
                            You can still proceed with the analysis without website performance data.
                        </p>
                    </div>
                </div>
            `;
            
            previewElem.innerHTML = previewHTML;
            previewElem.classList.remove('hidden');
            return;
        }
        
        // Build the preview HTML for successful response
        let previewHTML = `
            <div class="p-4 mb-4 bg-gray-50 border rounded-lg">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-lg font-semibold">Website Analysis: ${data.url}</h3>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                    <div class="p-2 bg-white rounded border text-center">
                        <div class="font-semibold mb-1">Performance</div>
                        <div class="text-xl ${getScoreColorClass(data.scores.performance)}">${Math.round(data.scores.performance)}%</div>
                    </div>
                    <div class="p-2 bg-white rounded border text-center">
                        <div class="font-semibold mb-1">SEO</div>
                        <div class="text-xl ${getScoreColorClass(data.scores.seo)}">${Math.round(data.scores.seo)}%</div>
                    </div>
                    <div class="p-2 bg-white rounded border text-center">
                        <div class="font-semibold mb-1">Accessibility</div>
                        <div class="text-xl ${getScoreColorClass(data.scores.accessibility)}">${Math.round(data.scores.accessibility)}%</div>
                    </div>
                    <div class="p-2 bg-white rounded border text-center">
                        <div class="font-semibold mb-1">Best Practices</div>
                        <div class="text-xl ${getScoreColorClass(data.scores['best-practices'])}">${Math.round(data.scores['best-practices'])}%</div>
                    </div>
                </div>
                
                <div class="text-sm">
                    <p class="mb-2 text-gray-600">
                        This data will be included in the AI analysis to provide website optimization recommendations.
                    </p>
                </div>
            </div>
        `;
        
        // Display the preview
        previewElem.innerHTML = previewHTML;
        previewElem.classList.remove('hidden');
    }

    // Helper function to get color class based on score
    function getScoreColorClass(score) {
        if (score >= 90) return 'text-green-600';
        if (score >= 70) return 'text-yellow-600';
        if (score >= 50) return 'text-orange-500';
        return 'text-red-600';
    }
    
    // Helper function to get color for metric values
    function getMetricColorClass(metric) {
        if (!metric || !metric.display_value || metric.display_value === 'N/A') return 'text-gray-500';
        
        // For metrics where lower is better (most timing metrics)
        if (metric.display_value.includes('ms') || metric.display_value.includes('s')) {
            const value = parseFloat(metric.display_value);
            if (value < 1000) return 'text-green-600';
            if (value < 2500) return 'text-yellow-600';
            if (value < 4000) return 'text-orange-500';
            return 'text-red-600';
        }
        
        // For CLS specific handling
        if (metric.numeric_value !== undefined && metric.display_value.length < 5) {
            const value = parseFloat(metric.numeric_value);
            if (value < 0.1) return 'text-green-600';
            if (value < 0.25) return 'text-yellow-600';
            return 'text-red-600';
        }
        
        return 'text-gray-700';
    }

    // Function to display comprehensive PageSpeed Insights data preview
    function displayComprehensivePageSpeedResults(modalContent, results) {
        if (!results || !modalContent) return;
        
        // Handle error response
        if (results.error) {
            modalContent.innerHTML = `
                <div class="bg-red-50 p-4 rounded-lg">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">Error analyzing website</h3>
                            <div class="mt-2 text-sm text-red-700">
                                <p>${results.error}</p>
                                ${results.details ? `<p class="mt-2 text-xs text-red-600">${results.details}</p>` : ''}
                                <p class="mt-2">Status: ${results.status || 'Error'}</p>
                                <p class="mt-2">Make sure the URL is correct and the website is accessible.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-blue-800">
                        <span class="font-medium">Note:</span> You can still proceed with the trend analysis without website data.
                        The recommendations will be based solely on trend data.
                    </p>
                </div>
            `;
            return;
        }
        
        // Format the results nicely in the modal with comprehensive data
        modalContent.innerHTML = `
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="text-lg font-semibold text-gray-800">Performance Scores</h4>
                    <a href="${results.full_report_url}" target="_blank" class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded hover:bg-blue-200 transition-colors">
                        View Full Report 
                    </a>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    ${createScoreCard('Performance', results.scores.performance)}
                    ${createScoreCard('SEO', results.scores.seo)}
                    ${createScoreCard('Accessibility', results.scores.accessibility)}
                    ${createScoreCard('Best Practices', results.scores['best-practices'])}
                </div>
            </div>
            
            <div class="mb-6">
                <h4 class="text-lg font-semibold mb-2 text-gray-800">Core Web Vitals</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <span class="text-sm font-medium text-gray-500">Largest Contentful Paint (LCP)</span>
                        <p class="text-lg font-semibold ${getMetricColorClass(results.metrics['largest-contentful-paint'])}">${results.metrics['largest-contentful-paint'].display_value}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <span class="text-sm font-medium text-gray-500">Cumulative Layout Shift (CLS)</span>
                        <p class="text-lg font-semibold ${getMetricColorClass(results.metrics['cumulative-layout-shift'])}">${results.metrics['cumulative-layout-shift'].display_value}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <span class="text-sm font-medium text-gray-500">First Contentful Paint (FCP)</span>
                        <p class="text-lg font-semibold ${getMetricColorClass(results.metrics['first-contentful-paint'])}">${results.metrics['first-contentful-paint'].display_value}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <span class="text-sm font-medium text-gray-500">Speed Index</span>
                        <p class="text-lg font-semibold ${getMetricColorClass(results.metrics['speed-index'])}">${results.metrics['speed-index'].display_value}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <span class="text-sm font-medium text-gray-500">Time to Interactive (TTI)</span>
                        <p class="text-lg font-semibold ${getMetricColorClass(results.metrics['interactive'])}">${results.metrics['interactive'].display_value}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <span class="text-sm font-medium text-gray-500">Total Blocking Time (TBT)</span>
                        <p class="text-lg font-semibold ${getMetricColorClass(results.metrics['total-blocking-time'])}">${results.metrics['total-blocking-time'].display_value}</p>
                    </div>
                </div>
            </div>
            
            ${results.opportunities && results.opportunities.length > 0 ? `
            <div class="mb-6">
                <h4 class="text-lg font-semibold mb-3 text-gray-800">Improvement Opportunities</h4>
                <div class="bg-white border border-gray-200 rounded-lg">
                    ${results.opportunities.slice(0, 5).map((opp, index) => `
                        <div class="p-3 ${index < Math.min(results.opportunities.length, 5) - 1 ? 'border-b border-gray-200' : ''}">
                            <div class="flex items-start">
                                <span class="inline-block w-2 h-2 rounded-full bg-yellow-400 mt-1.5 mr-2 flex-shrink-0"></span>
                                <div>
                                    <p class="font-medium text-gray-800">${opp.title} ${opp.displayValue ? `<span class="font-normal text-gray-600">(${opp.displayValue})</span>` : ''}</p>
                                    <p class="text-sm text-gray-600 mt-1">${opp.description}</p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                    ${results.opportunities.length > 5 ? `
                        <div class="p-3 bg-gray-50 text-center">
                            <span class="text-sm text-blue-600">+ ${results.opportunities.length - 5} more opportunities</span>
                        </div>
                    ` : ''}
                </div>
            </div>
            ` : ''}
            
            ${results.stackPacks && results.stackPacks.length > 0 ? `
            <div class="mb-6">
                <h4 class="text-lg font-semibold mb-2 text-gray-800">Framework-Specific Advice</h4>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-800 mb-2">
                        <span class="font-medium">Detected frameworks:</span> ${results.stackPacks.map(stack => stack.title).join(', ')}
                    </p>
                </div>
            </div>
            ` : ''}
            
            ${results.runWarnings && results.runWarnings.length > 0 ? `
            <div class="mb-6">
                <h4 class="text-lg font-semibold mb-2 text-gray-800">Warnings</h4>
                <div class="bg-yellow-50 p-3 rounded-lg">
                    <ul class="list-disc pl-5 text-sm text-yellow-800">
                        ${results.runWarnings.map(warning => `<li>${warning}</li>`).join('')}
                    </ul>
                </div>
            </div>
            ` : ''}
            
            <div class="mt-4 bg-blue-50 p-4 rounded-lg">
                <p class="text-sm text-blue-800">
                    <span class="font-medium">Note:</span> This comprehensive analysis will be included in your recommendations
                    when you submit the form. The AI will use this data to provide tailored advice for your website.
                </p>
            </div>
        `;
    }
</script>

<!-- Include existing script for trends-ai-analysis.js with modification to use PageSpeed data -->
<script>
    // This script will check if window.pagespeedInsightsData exists and pass it to the backend
    document.addEventListener('DOMContentLoaded', function() {
        // Override the original sendAiAnalysisRequest function if it exists
        if (typeof window.sendAiAnalysisRequest === 'function') {
            const originalSendAiAnalysisRequest = window.sendAiAnalysisRequest;
            
            window.sendAiAnalysisRequest = function(keyword, data, business_intent, brand_name, website_url, marketplaces) {
                // Create a new request payload object with the base data
                const requestPayload = {
                    keyword: keyword,
                    data: data,
                    business_intent: business_intent,
                    brand_name: brand_name,
                    user_website: website_url,
                    marketplaces_selected: marketplaces
                };
                
                // Add PageSpeed data if available
                if (window.pagespeedInsightsData) {
                    try {
                        // Parse PageSpeed data and add it directly to the request
                        const pagespeedData = typeof window.pagespeedInsightsData === 'string' 
                            ? JSON.parse(window.pagespeedInsightsData) 
                            : window.pagespeedInsightsData;
                            
                        requestPayload.pagespeed_insights = pagespeedData;
                        console.log('Added PageSpeed data to AI analysis request', pagespeedData);
                    } catch (error) {
                        console.error('Error parsing PageSpeed data:', error);
                    }
                } else {
                    // Check if PageSpeed data is in the hidden input field
                    const pagespeedDataInput = document.getElementById('pagespeedData');
                    if (pagespeedDataInput && pagespeedDataInput.value) {
                        try {
                            const pagespeedData = JSON.parse(pagespeedDataInput.value);
                            requestPayload.pagespeed_insights = pagespeedData;
                            console.log('Added PageSpeed data from input field to AI analysis request', pagespeedData);
                        } catch (error) {
                            console.error('Error parsing PageSpeed data from input:', error);
                        }
                    }
                }
                
                // Debug output to check data before sending
                console.log('Sending AI analysis request with payload:', JSON.stringify(requestPayload));
                
                // Make API request to backend for AI analysis
                return fetch('/trends/ai-analysis/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(requestPayload),
                    // Add timeout to prevent long waiting times
                    signal: AbortSignal.timeout(30000) // 30 seconds timeout
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                });
            };
        }
        
        // Function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>

<script>
    // Test Buttons Functionality for Analysis and Recommendation Popups
    document.addEventListener('DOMContentLoaded', function() {
        const testAnalysisBtn = document.getElementById('testAnalysisBtn');
        const testRecommendationBtn = document.getElementById('testRecommendationBtn');
        const expandModal = document.getElementById('expandModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const closeModal = document.getElementById('closeModal');

        // Analysis content based on the provided image
        const analysisContent = `
            <div class="bg-white p-6 md:p-8 lg:p-10 rounded-lg">
                <div class="flex flex-col md:flex-row">
                    <!-- Left side: Title and process overview -->
                    <div class="md:w-1/3 pr-0 md:pr-8 -mt-[2rem]">
                        <h2 class="text-3xl md:text-4xl text-gray-800 mb-3" style="font-weight: 800;">Our analysis</h2>
                        <p class="text-gray-600 text-sm md:text-base -mt-[0.5rem]">Here's how we approached this project.</p>
                    </div>
                    
                    <!-- Right side: Process steps -->
                    <div class="md:w-2/3 space-y-8 md:-mt-[2rem]">
                        <!-- Step 1 -->
                        <div class="flex items-start">
                            <div class="flex-shrink-0 w-12 h-12 bg-[#7B3DF3] rounded-full flex items-center justify-center">
                                <span class="text-sm font-bold text-white">01</span>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-[800] text-gray-800 mb-1">Searching for pain</h3>
                                <p class="text-gray-600 text-sm">We are always looking for little signals: the annoying, the frustrating, the could-be-better.</p>
                            </div>
                        </div>
                        
                        <!-- Step 2 -->
                        <div class="flex items-start">
                            <div class="flex-shrink-0 w-12 h-12 bg-[#7B3DF3] rounded-full flex items-center justify-center">
                                <span class="text-sm font-bold text-white">02</span>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-[800] text-gray-800 mb-1">Living that pain</h3>
                                <p class="text-gray-600 text-sm">Once we discover a problem, we embrace it. This involves getting away from the computer and talking to people in their own environments.</p>
                            </div>
                        </div>
                        
                        <!-- Step 3 -->
                        <div class="flex items-start">
                            <div class="flex-shrink-0 w-12 h-12 bg-[#7B3DF3] rounded-full flex items-center justify-center">
                                <span class="text-sm font-bold text-white">03</span>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-[800] text-gray-800 mb-1">Connecting the data</h3>
                                <p class="text-gray-600 text-sm">We gather data to pinpoint the problem's exact what, when, where, how, and why.</p>
                            </div>
                        </div>
                        
                        <!-- Step 4 -->
                        <div class="flex items-start">
                            <div class="flex-shrink-0 w-12 h-12 bg-[#7B3DF3] rounded-full flex items-center justify-center">
                                <span class="text-sm font-bold text-white">04</span>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-[800] text-gray-800 mb-1">Next steps</h3>
                                <p class="text-gray-600 text-sm">Armed with insights and data, we start to explore solutions that'll make the experience better.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Recommendation content based on image 2
        const recommendationContent = `
            <div class="px-6 prose prose-sm max-w-none ai-content leading-relaxed">
                <h3 class="text-3xl font-[800] text-gray-800 mb-[1.5rem]">Strategic Recommendations <br>for "Makhana" <span class="text-sm text-gray-500">by 1matrix.io</span></h3>
                
                <div class="mb-6">
                    <h4 class="flex items-center gap-4 font-[800] text-indigo-700">
                        <div class="flex-shrink-0 w-12 h-12 bg-[#7B3DF3] rounded-full flex items-center justify-center">
                            <span class="text-sm font-bold text-white">01</span>
                        </div>
                        <span class="text-xl " style="font-weight: 800;">Search Trend Analysis</span>
                    </h4>
                    <ul class="list-disc pl-[4.8rem] mb-2 space-y-2">
                        <li class="text-gray-700">Strongly increasing trend over the past 5 years</li>
                        <li class="text-gray-700">Multiple seasonal spikes with most recent peak in February 2-8, 2025</li>
                        <li class="text-gray-700">Low periods of interest in late 2021</li>
                        <li class="text-gray-700">Exhibits low volatility</li>
                        <li class="text-gray-700">Upward trend in the last 3 months</li>
                    </ul>
                </div>
                
                <h3 class="text-3xl font-[800] text-gray-800 mb-[1.5rem]">Action Plan:</h3>
                
                <div class="mb-6">
                    <h4 class="flex items-center gap-4 font-[800] text-indigo-700">
                        <div class="flex-shrink-0 w-12 h-12 bg-[#7B3DF3] rounded-full flex items-center justify-center">
                            <span class="text-sm font-bold text-white">01</span>
                        </div>
                        <span class="text-xl" style="font-weight: 800;">Website Analysis & Optimization</span>
                    </h4>
                    
                    <!-- Performance metrics visualization based on the image -->
                    <div class="flex flex-wrap gap-8 items-center my-4 pl-[3.6rem]">
                        <div class="flex flex-col items-center">
                            <div class="relative w-16 h-16">
                                <svg class="w-16 h-16 transform -rotate-90" viewBox="0 0 36 36">
                                    <circle cx="18" cy="18" r="16" fill="none" stroke="#f3f4f6" stroke-width="2"></circle>
                                    <circle cx="18" cy="18" r="16" fill="none" stroke="#7B3DF3" stroke-width="2" stroke-dasharray="100" stroke-dashoffset="26"></circle>
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span class="text-sm font-bold text-gray-800">74</span>
                                </div>
                            </div>
                            <span class="text-xs font-medium text-gray-600 mt-1">Performance</span>
                        </div>
                        
                        <div class="flex flex-col items-center">
                            <div class="relative w-16 h-16">
                                <svg class="w-16 h-16 transform -rotate-90" viewBox="0 0 36 36">
                                    <circle cx="18" cy="18" r="16" fill="none" stroke="#f3f4f6" stroke-width="2"></circle>
                                    <circle cx="18" cy="18" r="16" fill="none" stroke="#7B3DF3" stroke-width="2" stroke-dasharray="100" stroke-dashoffset="10"></circle>
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span class="text-sm font-bold text-gray-800">90</span>
                                </div>
                            </div>
                            <span class="text-xs font-medium text-gray-600 mt-1">Accessibility</span>
                        </div>
                        
                        <div class="flex flex-col items-center">
                            <div class="relative w-16 h-16">
                                <svg class="w-16 h-16 transform -rotate-90" viewBox="0 0 36 36">
                                    <circle cx="18" cy="18" r="16" fill="none" stroke="#f3f4f6" stroke-width="2"></circle>
                                    <circle cx="18" cy="18" r="16" fill="none" stroke="#7B3DF3" stroke-width="2" stroke-dasharray="100" stroke-dashoffset="0"></circle>
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span class="text-sm font-bold text-gray-800">100</span>
                                </div>
                            </div>
                            <span class="text-xs font-medium text-gray-600 mt-1">Best Practices</span>
                        </div>
                        
                        <div class="flex flex-col items-center">
                            <div class="relative w-16 h-16">
                                <svg class="w-16 h-16 transform -rotate-90" viewBox="0 0 36 36">
                                    <circle cx="18" cy="18" r="16" fill="none" stroke="#f3f4f6" stroke-width="2"></circle>
                                    <circle cx="18" cy="18" r="16" fill="none" stroke="#7B3DF3" stroke-width="2" stroke-dasharray="100" stroke-dashoffset="8"></circle>
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span class="text-sm font-bold text-gray-800">92</span>
                                </div>
                            </div>
                            <span class="text-xs font-medium text-gray-600 mt-1">SEO</span>
                        </div>
                    </div>
                    <ul class="list-disc pl-[4.8rem] mb-2 space-y-2">
                        <li class="text-gray-700">Performance Issues: First Contentful Paint (3.5s) and Largest Contentful Paint (4.5s) are too slow</li>
                        <li class="text-gray-700">Eliminate render-blocking resources ASAP</li>
                        <li class="text-gray-700">Reduce unused JavaScript to improve loading times</li>
                        <li class="text-gray-700">Server Response Time: 1.32 seconds is too long - needs reduction</li>
                        <li class="text-gray-700">Avoid serving legacy JavaScript to modern browsers</li>
                        <li class="text-gray-700">Start a blog to generate organic traffic</li>
                        <li class="text-gray-700">Add structured data/schema for AI-readiness</li>
                    </ul>
                </div>
                
                <div class="mb-6">
                    <h4 class="flex items-center gap-4 font-[800] text-indigo-700">
                        <div class="flex-shrink-0 w-12 h-12 bg-[#7B3DF3] rounded-full flex items-center justify-center">
                            <span class="text-sm font-bold text-white">02</span>
                        </div>
                        <span class="text-xl" style="font-weight: 800;">Marketplace Audit</span>
                    </h4>
                    <ul class="list-disc pl-[4.8rem] mb-2 space-y-2">
                        <li class="text-gray-700">Check for any missing marketplaces beside Amazon, Meesho, IndiaMART</li>
                        <li class="text-gray-700">Upload A+ content on Amazon immediately</li>
                        <li class="text-gray-700">Only 3 reviews on Amazon is hurting conversion</li>
                        <li class="text-gray-700">Improve listing title and bullets - currently lacks material & use-case</li>
                    </ul>
                </div>
                
                <div class="mb-6">
                    <h4 class="flex items-center gap-4 font-[800] text-indigo-700">
                        <div class="flex-shrink-0 w-12 h-12 bg-[#7B3DF3] rounded-full flex items-center justify-center">
                            <span class="text-sm font-bold text-white">03</span>
                        </div>
                        <span class="text-xl" style="font-weight: 800;">Channel Strategy</span>
                    </h4>
                    <ul class="list-disc pl-[4.8rem] mb-2 space-y-2">
                        <li class="text-gray-700">Best content platforms: YouTube + Blog</li>
                    </ul>
                </div>
                
                <div class="mb-6">
                    <h4 class="flex items-center gap-4 font-[800] text-indigo-700">
                        <div class="flex-shrink-0 w-12 h-12 bg-[#7B3DF3] rounded-full flex items-center justify-center">
                            <span class="text-sm font-bold text-white">04</span>
                        </div>
                        <span class="text-xl" style="font-weight: 800;">Keywords</span>
                    </h4>
                    <p class="pl-[4.8rem] text-gray-700">Low-competition, high-intent keywords for the "Makhana" niche:</p>
                    <ul class="list-disc pl-[4.8rem] mb-2 space-y-2 grid grid-cols-1 md:grid-cols-2">
                        <li class="text-gray-700">"Benefits of Makhana for weight loss"</li>
                        <li class="text-gray-700">"Makhana recipes healthy"</li>
                        <li class="text-gray-700">"Makhana nutritional value"</li>
                        <li class="text-gray-700">"Roasted Makhana calories"</li>
                        <li class="text-gray-700">"Makhana vs popcorn"</li>
                        <li class="text-gray-700">"Makhana for babies"</li>
                        <li class="text-gray-700">"Makhana online buy"</li>
                        <li class="text-gray-700">"Flavored Makhana recipes"</li>
                        <li class="text-gray-700">"Makhana kheer recipe"</li>
                        <li class="text-gray-700">"Makhana side effects"</li>
                        <li class="text-gray-700">"What is Makhana"</li>
                        <li class="text-gray-700">"Is Makhana keto friendly?"</li>
                        <li class="text-gray-700">"Makhana protein content"</li>
                        <li class="text-gray-700">"Makhana glycemic index"</li>
                        <li class="text-gray-700">"How to roast Makhana perfectly"</li>
                    </ul>
                </div>
                
                <div class="mb-6">
                    <h4 class="flex items-center gap-4 font-[800] text-indigo-700">
                        <div class="flex-shrink-0 w-12 h-12 bg-[#7B3DF3] rounded-full flex items-center justify-center">
                            <span class="text-sm font-bold text-white">05</span>
                        </div>
                        <span class="text-xl" style="font-weight: 800;">Content Calendar Ideas</span>
                    </h4>
                    <ul class="list-disc pl-[4.8rem] mb-2 space-y-2">
                        <li class="text-gray-700">"How to Roast Makhana Perfectly Every Time"</li>
                        <li class="text-gray-700">"Makhana vs. Popcorn: Which is the Healthier Snack?"</li>
                        <li class="text-gray-700">"The Ultimate Guide to Makhana Nutrition"</li>
                        <li class="text-gray-700">"5 Delicious and Healthy Makhana Recipes"</li>
                        <li class="text-gray-700">"Makhana for Weight Loss: Does it Really Work?"</li>
                        <li class="text-gray-700 text-indigo-600 font-medium">+ 20 more content ideas available</li>
                    </ul>
                </div>
                
                <div class="mb-6">
                    <h4 class="flex items-center gap-4 font-[800] text-indigo-700">
                        <div class="flex-shrink-0 w-12 h-12 bg-[#7B3DF3] rounded-full flex items-center justify-center">
                            <span class="text-sm font-bold text-white">06</span>
                        </div>
                        <span class="text-xl" style="font-weight: 800;">PR & Influencers</span>
                    </h4>
                    <p class="pl-[4.8rem] text-gray-700">Guest Post/PR Websites:</p>
                    <ul class="list-disc pl-[4.8rem] mb-2 space-y-2">
                        <li class="text-gray-700">Healthline</li>
                        <li class="text-gray-700">NDTV Food</li>
                        <li class="text-gray-700">Times Food</li>
                        <li class="text-gray-700 italic">Note: A competitor was featured on Masala Monks - consider reaching out</li>
                    </ul>
                </div>
                
                <p class="text-sm text-gray-600 italic mt-4">Implementing these strategies can help maximize the market opportunity and establish a strong position in the Makhana market.</p>
            </div>
        `;

        // Test Analysis Button Event Handler
        if (testAnalysisBtn) {
            testAnalysisBtn.addEventListener('click', function() {
                // Set modal title and content
                modalTitle.textContent = "";
                modalTitle.parentElement.style.borderBottom = 'none'; // Remove header border
                modalContent.innerHTML = analysisContent;
                
                // Show modal with animation
                expandModal.classList.remove('hidden');
                setTimeout(() => {
                    expandModal.classList.add('active');
                }, 10);
            });
        }
        
        // Test Recommendation Button Event Handler
        if (testRecommendationBtn) {
            testRecommendationBtn.addEventListener('click', function() {
                // Set modal title and content
                modalTitle.textContent = "";
                modalTitle.parentElement.style.borderBottom = 'none'; // Remove header border
                modalContent.innerHTML = recommendationContent;
                
                // Show modal with animation
                expandModal.classList.remove('hidden');
                setTimeout(() => {
                    expandModal.classList.add('active');
                }, 10);
            });
        }
        
        // Close modal when clicking the close button
        if (closeModal) {
            closeModal.addEventListener('click', function() {
                expandModal.classList.remove('active');
                setTimeout(() => {
                    expandModal.classList.add('hidden');
                }, 300);
            });
        }
        
        // Close modal when clicking outside
        if (expandModal) {
            expandModal.addEventListener('click', function(e) {
                if (e.target === expandModal) {
                    expandModal.classList.remove('active');
                    setTimeout(() => {
                        expandModal.classList.add('hidden');
                    }, 300);
                }
            });
        }
    });
</script>
{% endblock %} 